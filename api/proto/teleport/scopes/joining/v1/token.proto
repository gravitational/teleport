// Copyright 2025 Gravitational, Inc
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//      http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

syntax = "proto3";

package teleport.scopes.joining.v1;

import "teleport/header/v1/metadata.proto";

option go_package = "github.com/gravitational/teleport/api/gen/proto/go/teleport/scopes/joining/v1;joiningv1";

// ScopedToken is a token whose resource and permissions are scoped. Scoped tokens are used for the provisioning
// of teleport agents locked to specific scopes. Scoped tokens implement a subset of the functionality of standard
// provisioning tokens, specifically tailored to the usecase of limited admins/users provisioning resources within
// sub-scopes over which they have been granted elevated privileges.
message ScopedToken {
  // Kind is the resource kind.
  string kind = 1;

  // SubKind is the resource sub-kind.
  string sub_kind = 2;

  // Version is the resource version.
  string version = 3;

  // Metadata contains the resource metadata.
  teleport.header.v1.Metadata metadata = 4;

  // Scope is the scope of the token resource.
  string scope = 5;

  // Spec is the token specification.
  ScopedTokenSpec spec = 6;

  // The status of a scoped token.
  ScopedTokenStatus status = 7;
}

// ScopedTokenSpec is the specification of a scoped token.
message ScopedTokenSpec {
  // The scope to which this token is assigned.
  string assigned_scope = 1;

  // The list of roles associated with the token. They will be converted
  // to metadata in the SSH and X509 certificates issued to the user of the
  // token.
  repeated string roles = 2;

  // The joining method required in order to use this token.
  // Supported joining methods for scoped tokens only include 'token'.
  string join_method = 3;

  // The AWS-specific configuration used with the "ec2" and "iam" join methods.
  AWS aws = 4;

  // The GitHub-specific configuration used with the "github" join method.
  Github github = 5;
}

// The status of a scoped token.
message ScopedTokenStatus {
  // The secret that must be provided as part of the challenge when joining using
  // the token join method.
  string secret = 1;
}

// The AWS-specific configuration used with the "ec2" and "iam" join methods.
message AWS {
  // A rule that a joining node must match in order to use the associated token
  // with AWS join methods.
  message Rule {
    // The AWS account ID.
    string aws_account = 1;
    // List of AWS regions a node is allowed to join from when using the
    // EC2 join method.
    repeated string aws_regions = 2;
    // The ARN of the role the Auth Service will assume in order to call the
    // EC2 API when using the EC2 join method.
    string aws_role = 3;
    // The ARN of the joining identity for use with the IAM join method.
    // Supports wildcards "*" and "?".
    string aws_arn = 4;
    // The organization ID that the joining AWS identity must belong to
    // when using the IAM join method.
    string aws_organization_id = 5;
  }

  // A list of Rules for allowing use of this token. A node must match at least one
  // allow rule in order to use this token.
  repeated Rule allow = 1;

  // The TTL to use for AWS EC2 Instance Identity Documents used
  // to join the cluster with this token.
  int64 aws_iid_ttl = 2;

  // Integration name which provides credentials for validating join attempts.
  // Currently only in use for validating the AWS Organization ID in the IAM Join method.
  string integration = 3;
}

// The GitHub-specific configuration used with the "github" join method.
message Github {
  // The fields mapped from `lib/githubactions.IDToken`. Not all fields should be included,
  // only ones that we expect to be useful when trying to create rules around which workflows
  // should be allowed to authenticate against a cluster.
  message Rule {
    // Sub, also known as Subject, is a string that roughly uniquely identifies
    // the workload. The format of this varies depending on the type of github
    // action run.
    string sub = 1;
    // The repository from where the workflow is running.
    // This includes the name of the owner e.g `gravitational/teleport`
    string repository = 2;
    // The name of the organization in which the repository is stored.
    string repository_owner = 3;
    // The name of the workflow.
    string workflow = 4;
    // The name of the environment used by the job.
    string environment = 5;
    // The personal account that initiated the workflow run.
    string actor = 6;
    // The git ref that triggered the workflow run.
    string ref = 7;
    // The type of ref, for example: "branch".
    string ref_type = 8;
  }
  // A list of Rules for allowing use of this token. A node must match at least one
  // allow rule in order to use this token.
  repeated Rule allow = 1;

  // Allows joining from runners associated with a GitHub Enterprise Server instance.
  // When unconfigured, tokens will be validated against github.com, but when configured
  // to the host of a GHES instance, then the tokens will be validated against host.
  //
  // This value should be the hostname of the GHES instance, and should not
  // include the scheme or a path. The instance must be accessible over HTTPS
  // at this hostname and the certificate must be trusted by the Auth Service.
  string enterprise_server_host = 2;

  // Allows the slug of a GitHub Enterprise organisation to be
  // included in the expected issuer of the OIDC tokens. This is for
  // compatibility with the `include_enterprise_slug` option in GHE.
  //
  // This field should be set to the slug of your enterprise if this is enabled. If
  // this is not enabled, then this field must be left empty. This field cannot
  // be specified if `enterprise_server_host` is specified.
  //
  // See https://docs.github.com/en/enterprise-cloud@latest/actions/deployment/security-hardening-your-deployments/about-security-hardening-with-openid-connect#customizing-the-issuer-value-for-an-enterprise
  // for more information about customized issuer values.
  string enterprise_slug = 3;
  // Disables fetching of the GHES signing keys via the JWKS/OIDC
  // endpoints, and allows them to be directly specified. This allows joining
  // from GitHub Actions in GHES instances that are not reachable by the
  // Teleport Auth Service.
  string static_jwks = 4;
}
