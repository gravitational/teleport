#!/bin/bash

# This before remove script is run each time the teleport package is removed.

set -eu

version_le() {
  [ "$(printf '%s\n' "$1" "$2" | sort -V | head -n1)" = "$1" ]
}

unlink() {
  echo "Removing symlinks from Teleport system paths..."
  /opt/teleport/system/bin/teleport-update unlink-package
}

case "$1" in
  1)
    echo "Skipping symlink removal as this is a package upgrade."
    ;;
  remove|0)
    unlink || true
    ;;
  purge)
    ;;
  upgrade)
    target_version="$2"
    if [[ -n "$target_version" ]]; then
      major="${target_version%%.*}"
      case "$major" in
        17)
          version_le "$target_version" "17.2.9" && unlink || true
          ;;
        16)
          version_le "$target_version" "16.4.29" && unlink || true
          ;;
        15)
          version_le "$target_version" "15.4.33" && unlink || true
          ;;
        *)
          echo "Skipping symlink removal for version $target_version."
          ;;
      esac
    fi
    ;;
  failed-upgrade)
    echo "Upgrade failed â€” skipping symlink removal."
    ;;
  *)
    unlink || true
    ;;
esac