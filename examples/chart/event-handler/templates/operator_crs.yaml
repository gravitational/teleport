{{- if .Values.crd.create -}}
{{- if not .Values.tbot.enabled -}}
{{- fail "Custom resources cannot be deployed without tbot enabled" -}}
{{- end -}}
apiVersion: resources.teleport.dev/v1
kind: TeleportRoleV8
metadata:
  name: {{ include "event-handler.fullname" . }}
  namespace: {{ include "event-handler.crd.namespace" . }}
  labels:
    {{- include "event-handler.labels" . | nindent 4 }}
spec:
  allow:
    rules:
      - resources: ['event', 'session']
        verbs: ['list','read']
---
apiVersion: resources.teleport.dev/v1
kind: TeleportBotV1
metadata:
  name: {{ include "event-handler.fullname" . }}
  namespace: {{ include "event-handler.crd.namespace" . }}
  labels:
    {{- include "event-handler.labels" . | nindent 4 }}
spec:
  roles:
    - {{ include "event-handler.fullname" . }}
---
apiVersion: resources.teleport.dev/v2
kind: TeleportProvisionToken
metadata:
  name: {{ include "event-handler.tbot.tokenName" . }}
  namespace: {{ include "event-handler.crd.namespace" . }}
  labels:
    {{- include "event-handler.labels" . | nindent 4 }}
spec:
  roles: [Bot]
  bot_name: {{ include "event-handler.fullname" . }}
  {{- include "event-handler.crd.tokenJoinSpec" . | nindent 2 -}}
{{- end -}}
