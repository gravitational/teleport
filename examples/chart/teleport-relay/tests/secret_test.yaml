suite: Test Secret
templates:
  - secret.yaml

tests:
  - it: creates a secret by default
    set:
      joinParams:
        tokenName: randomTokenName
    asserts:
      - hasDocuments:
          count: 1
      - containsDocument:
          kind: Secret
          apiVersion: v1
          name: RELEASE-NAME-teleport-relay
  - it: fails if joinParams.tokenName is missing
    asserts:
      - failedTemplate:
          errorMessage: joinParams.tokenName must be specified if joinTokenSecret.create is enabled
  - it: the secret contains the token in auth-token
    set:
      joinParams:
        tokenName: randomTokenName
    asserts:
      - equal:
          path: stringData.auth-token
          value: randomTokenName

  - it: does not create a secret account if joinTokenSecret.create is false
    set:
      joinTokenSecret:
        create: false
    asserts:
      - hasDocuments:
          count: 0
  - it: creates a secret with the configured name
    set:
      joinParams:
        tokenName: randomTokenName
      joinTokenSecret:
        name: randomSecretName
    asserts:
      - equal:
          path: metadata.name
          value: randomSecretName

  - it: includes extraLabels and annotations
    set:
      joinParams:
        tokenName: randomTokenName
      extraLabels:
        secret:
          labelName1: labelValue1
          labelName2: labelValue2
      annotations:
        secret:
          annotationName1: annotationValue1
          annotationName2: annotationValue2
    asserts:
      - isSubset:
          path: metadata.labels
          content:
            labelName1: labelValue1
            labelName2: labelValue2
      - equal:
          path: metadata.annotations
          value:
            annotationName1: annotationValue1
            annotationName2: annotationValue2
