---
authors: Marek Smoli≈Ñski (marek@goteleport.com)
state: draft
---

# RFD 0142 - Grace Teleport Proxy Restart Protocol

## Required Approvers

- Engineering: `@r0mant && @klizhentas && @jimbishopp`

## What

This RFD proposes a way to handle Teleport Proxy pod restart in HA k8 kube deployment without breaking ongoing client connections allowing to upgrade of Teleport Proxy and roll-out of a new
version of Teleport Proxy without breaking ongoing Database/SSH client connections.

Described solution applies only to  `tsh` flow where SSH/Desktop connections established from Teleport Web UI don't use Teleport Local Proxy.

## Why

In addition to [Add RFD 134: Cloud first deployments](https://github.com/gravitational/teleport/pull/28072#discussion_r1239847065) where transition to Teleport as SaaS Product the Teleport Auth/Proxy deployment process shouldn't impact end user workflow.
Currently, when the Teleport Proxy service is terminated  ongoing user connection is dropped. This impacts the end-user workflow where a user wll be disconnected and will be disconnected and needs to re-connect to a Teleport Service.

## Details

### The `tsh local proxy <---> Teleprot Proxy <---> Teleport Agent` Internal Protocol:

The introduction of an internal wire protocol between TSH Local Proxy/Teleport Proxy and Teleport Agent Service will add the ability to establish a connection to the Teleport Agent Service propagate information to the client about selected AgentID (HostID - uniq internal Teleport Agent Service identifier) and assign obtain unique connID that will allow for reconnection.

The TSH Local proxy and Teleport Agent Service will keep in memory the internal connection state allowing TSH local proxy to establish a new connection to Teleport Agent Service that will replace in the fly the underlying `net.Conn` injected to Teleport Agent Service handlers.

#### ConnInfo:
```
// ConnInfo contains metadata information about the ongoing connection.
struct ConnInfo type {
   // Length of ConnID string.
   ConnIDLength uint8
   // ConnID is a unique connection generated on the Teleport Proxy.
   ConnID  string

   // Length of AgentID string.
   AgentIDLength uint8
   // AgentID is the unique reverse tunnel agentID identified that was used to establish a connection to Teleport Agent Service.
   AgentID string
}
```
#### ConnectReq:
```
// ConnectReq message is a message that triggers connection flow to Teleport Agent Service.
struct ConnectReq type {
   // ConnInfo contains metadata information about the connection to Teleport Agent Service.
   // If empty a connection will be handled as a new connection. In order to recconect to the same Teleport Agent Service
   // a client can set the ConnInfo returned by ConnectResp.
   ConnInfo ConnInfo
}
```

#### ConnectResp:
```
// ConnectResp message contains metadata about the Teleport Agent Service connection.
struct ConnectResp type {
   // ConnInfo contains metadata information about the connection to Teleport Agent Service.
   ConnInfo ConnInfo
}
```

#### Reconnect:
```
// Reconnect message is sent by Teleport Proxy  to clients in order to indicate that Teleport Proxy is being in shutdown phase
// adding ability to Teleport Local Proxy to establish a connection to a separate Teleport Proxy resuing connection and agnetID identifiers.
struct Reconnect type {}
```

#### Data:
```
// Data message forwards application user data.
struct Data type {
   // Lenght of Data.
   Length uint32
   // Data is a User application Data.
   Data []byte
}
```

### Connection Flow:


#### 1) Using internal TSH local proxy protocol to establish a connection to Teleport Agent Service:

In order to establish a client new connection Local Proxy sends the `ConnectReq` to the Teleport Proxy step 1). Teleport Proxy will generate a unique UUID identifier for the incoming connection and forward the connID to Teleport Agent Service step 4).
Teleport Proxy will send the `ConnectResp` message to TSH Local Proxy with connID generated by Teleport Proxy and agentID - unique identifier of Teleport Agent Service.
As the result, Teleport Local Proxy will be able to reference the connID and agentID in the re-connection flow:

![Screenshot 2023-07-06 at 14 34 37](https://github.com/gravitational/teleport/assets/22402974/54f4c4a8-7b7e-470d-be36-da99f36b02a1)


#### 2) Handling Teleport Proxy Service Restart:

When Teleport Proxy is restarted/updated during the grace period (see: [pod-termination](httbs://kubernetes.io/docs/concepts/workloads/pods/pod-lifecycle/#pod-termination)) it will send the `ReconnectReq` to all clients as an indication that Teleport Proxy is being terminated and
TSH Local Proxy should reconnect to Teleport Agent Service via another Teleport Proxy. In the meantime, Teleport Proxy will stop responding to LB Heartbeat call and stop accepting new connections.

TSH Local Proxy after receiving the `ReconnectReq` stop 2) will try to establish a new connection to a different Teleport Proxy using the connID, agentID identifier allowing Teleport Proxy to connect to the same Teleport Agent Serve and forward `connID` stop 4)

![Screenshot 2023-07-06 at 14 35 06](https://github.com/gravitational/teleport/assets/22402974/76bf5649-7282-44da-bc89-0e17fa08a85d)


## Performance impact:
`TODO:`

## Security:
The  `Connection ID`  on the Teleport Proxy side will allow TSH Local Proxy to reconnect to the Teleport DB Agent service and hijack the Teleport Agent Service connection handler for the ongoing connection.
Thus, `Connection ID` should be generated randomly and never shared anywhere in logs and kept in memory with an auto cleaning mechanism.
