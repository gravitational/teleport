---
authors: Przemko Robakowski (przemko.robakowski@goteleport.com)
state: draft
---

# RFD 235 - Desktop Access - Linux

## Required Approvals

- Engineering: @zmb3 @rosstimothy
- Product: @klizhentas

## What

RFD 33 defines the high-level goals and architecture for Teleport Desktop
Access.

This RFD specifies how Teleport Desktop Access integrates with Linux hosts.

## Why

We currently support Windows Desktop Access using RDP protocol but there's no way to connect
to desktop environments on Linux boxes. Current RDP servers, like [xrdp](https://www.xrdp.org/),
usually don't work with IronRDP library and even when they do, they don't support smart card
authentication which we use for providing passwordless access. We would like to close this gap
but adding Teleport-native Linux Desktop Access to minimize the amount of configuration user has
to do outside Teleport and to bring Linux desktop experience on-par with Windows.

## Details

### Architecture

Linux Desktop Access is implemented using `linux_desktop_service` that
translates the Teleport desktop protocol (TDPB defined in RFD 232) into X11 protocol. 

Linux Desktop Service will run in agent mode, no agent-less mode will be supported.

```
+--------+
| web UI |
+--------+
    ^
    | TDPB over websocket
    v
+--------+
| proxy  |
+--------+
    ^
    | TDPB over mTLS over reverse tunnel
    |
+---|------------------------------+
|   v                              |
| +-------------------------+      |
| |  linux_desktop_service  |      |
| +-------------------------+      |
|     ^                 |          |
|     | X11             | starts   |
|     v                 v          |
| +--------+  X11  +-------------+ |
| |  Xvfb  |<----->|   Desktop   | |
| +--------+       | Environment | |
|                  + ------------+ |
|                                  |
|                       Linux host |
+----------------------------------+
```

### UX

#### Setup/discovery

Setup will require creating new node or updating existing one with new `linux_desktop` role and `linux_desktop_service` 
enabled (it will be disabled by default).

To help with onboarding, there will be new tile in `Enroll a New Resource` view for Linux desktops.
For the first release it will lead to documentation. Fully fledged guided installation, similar to enrolling SSH nodes, 
will be added later.

#### User logging in

Linux Desktop Service will create `LinuxDesktop` resource with its UUID as name. They will be presented in the UI as
one of unified resources, the same way we present Windows desktops. 

After user selects username to log in, UI will redirect to `/web/cluster/:cluster/linux_desktops/:uuid/:login`.
User will be presented with list of available xsessions (i.e. desktop environments). After selecting one of the items, 
user will be redirected to `/web/cluster/:cluster/linux_desktops/:uuid/:login/:xsession`. This will enable user to 
create bookmarks both to session selection screen and to specific xsession. 

If there's only one entry in `/usr/share/xsessions` selection screen will be skipped.

Started session will reuse visual components used for Windows desktop sessions to make the experience consistent.

### Xsessions/desktop environments

List of xsessions available on the target machine will be obtained by listing files in `/usr/share/xsessions`.
This is the same mechanism that is used by different display managers, like GDM and LightDM, to populate their 
list of xsessions. 

On connection, Linux Desktop Service will read selected desktop entry file to get command to execute stored in `Exec=`
section. It will then find free display number, start `Xvfb` with requested screen size and run command obtained 
earlier as user requested by UI. It will use X11 protocol to interact with `Xvfb`. 

Only X11 environments will be supported, there will be no support for Wayland. Tested desktop environments should
include at least Xfce, KDE Plasma and GNOME 48 (that's the last version that supports X11).

Desktop environment will be started using similar mechanism as starting shell for SSH access (re-executing `teleport` 
binary)

### Authentication

On connection, Linux Desktop Service will verify user using mTLS certificate. No other authentication is required.

Unix socket created by `Xvfb` will be secured using `Xauthority` file generated by Teleport and shared between `Xvfb`,
desktop environment and Linux Desktop Service. `Xvfb` will not create any TCP sockets.

### Frame encoding

Modified regions will be discovered using [DAMAGE](https://www.x.org/archive/X11R7.5/doc/damageproto/damageproto.txt)
extension. Each region will be encoded using [QOI](https://en.wikipedia.org/wiki/QOI_(image_format)) + [zSTD](https://github.com/facebook/zstd)
combination using Rust encoder to maximize performance. This encoding is supported by IronRDP in `qoiz` feature, so
we can leverage their decoder in UI.

### Screen resize

Screen will be resized using [XRANDR](https://gitlab.freedesktop.org/xorg/proto/xorgproto/-/raw/master/randrproto.txt?ref_type=heads)
extension. `Xvfb` will be started using maximum supported screen size (8192x8192) and immediately resized down to 
requested size. This is needed as `Xvfb` won't allow resizes to size bigger than the initial one.

### Mouse and keyboard input

Mouse and keyboard events will be translated into [XTEST](https://www.x.org/releases/X11R7.7-RC1/doc/xextproto/xtest.html)
extensions call. It supports all currently supported events.

Information about pointer changes will be obtained using [XFIXES](https://cgit.freedesktop.org/xorg/proto/fixesproto/plain/fixesproto.txt)
extension: `CursorNotify` and `GetCursorImage`

### Clipboard sharing

Clipboard will be shared by monitoring and managing `CLIPBOARD` selection. Data will be copied both ways as soon as
it is available, the same way we do it for Windows Desktop. The message flow between UI and Linux Desktop Service
and permission model will be the same as defined in RFD 49 for Windows Desktop.

### Directory sharing
   
FUSE file system will be created using [go-fuse](https://github.com/hanwen/go-fuse). It will be mounted in user's home 
directory, and it will redirect and translate all requests to TDPB messages that will be handled by UI.

If FUSE is not available on Linux host directory sharing will be disabled and warning will be emitted.

### Concurrent sessions

Each login will start a separate session. This is in contrast to how Windows Desktop Access works, as it will reuse
existing session on log out current user, but it's similar to how SSH session works.

### Session recordings

Sessions will be recorded in the same way as they do for Windows desktops. Playback will reuse most of the code as well.

### Locking and client idle timeout

`srv.StartMonitor` will be used for tracking client activity and lock status.

### MFA

In-band MFA mechanism currently used by Windows desktops will be reused for Linux desktops.

### Configuration

New `teleport.yaml` section for `linux_desktop_service`:

```yaml
linux_desktop_service:
  enabled: yes # default false
  listen_addr: 0.0.0.0:3029
  public_addr: linux.desktop.example.com:3029
  # optional, xsessions will provide regexes for filtering available sessions to present in UI
  xsessions:
    included: "^Xfce.*" # defaults to ^.*$
    excluded: ".*restricted" #defaults to no excludes
```

For entry to be included and shown to the user, it has to match `included` filter and must not be excluded by `excluded`.

### CLI changes

`tctl desktops ls` will no longer be alias for `tctl windows_desktops ls`. It will be modified to show both Windows and 
Linux desktops with additional column showing the type of the desktop. 

`tctl linux_desktops ls` will be added that will show only Linux desktops.

`tctl get/rm linux_desktop/:uuid` will be added.

New flag `--linux-desktop` will be added to `tctl lock`. `tctl lock --server-id` will also support Linux desktops.

`tctl token add` will support new system role `linux_desktop`. 

No changes to `tsh` are needed.
