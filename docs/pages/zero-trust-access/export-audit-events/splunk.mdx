---
title: Export Teleport Audit Events to Splunk
sidebar_label: Splunk
description: How to configure the Teleport Event Handler plugin to send audit events to Splunk
tags:
 - how-to
 - zero-trust
 - audit
---

Teleport's Event Handler plugin receives audit events from the Teleport Auth
Service and forwards them to your log management solution, letting you perform
historical analysis, detect unusual behavior, and form a better understanding of
how users interact with your Teleport cluster.

In this guide, we will show you how to configure the Teleport Event Handler
plugin to send your Teleport audit events to Splunk. 

## How it works

In this setup, the Teleport Event Handler plugin receives audit events from the
Teleport Auth Service over a gRPC channel and sends them to a local Fluentd
instance as HTTP requests. The Fluentd instance forwards these requests to the
Splunk HTTP Event Collector (HEC), which in turn sends them to Splunk Cloud Platform
or Splunk Enterprise for visualization and alerting.

## Prerequisites

(!docs/pages/includes/edition-prereqs-tabs.mdx!)

- (!docs/pages/includes/machine-id/plugin-prerequisites.mdx!)

- Splunk Cloud Platform or Splunk Enterprise v9.0.1 or above.

- A Linux host where you will run the Teleport Event Handler plugin and Splunk
  HEC. The HEC must be installed on the host.

  <Admonition type="warning">
  If you run the HEC on a separate host from the Teleport Event Handler, you
  will need to open a port on the HEC host to traffic from the Teleport Event
  Handler. This guide assumes that the HEC is listening on port `9061`.
  </Admonition>

- On Splunk Enterprise, port `8088` should be open to traffic from the host
  running the Teleport Event Handler and Universal Forwarder.

- (!docs/pages/includes/tctl.mdx!)

## Step 1/4. Set up the Teleport Event Handler plugin

The Event Handler plugin is a binary that runs independently of your Teleport
cluster. It authenticates to your Teleport cluster using mutual TLS and to the
HEC using a token. In this section, you will install the Teleport Event Handler
plugin on the Linux host where you are running your Universal Forwarder and
generate credentials that the plugin will use for authentication.

### Install the Teleport Event Handler plugin

Follow the instructions for your environment to install the Teleport Event
Handler plugin on your Universal Forwarder host:

(!docs/pages/includes/install-event-handler.mdx!)

### Generate a starter config file

Generate a configuration file with placeholder values for the Teleport Event Handler plugin. Later in this guide, we will edit the configuration file for your environment.

(!docs/pages/includes/configure-event-handler.mdx!)

### Define RBAC resources

(!docs/pages/includes/plugins/event-handler-role-user.mdx!)

### Enable issuing of credentials for the Event Handler role

<Tabs>
<TabItem label="Machine & Workload Identity">
(!docs/pages/includes/plugins/rbac-impersonate-event-handler-machine-id.mdx!)
</TabItem>
<TabItem label="Long-lived identity files">
(!docs/pages/includes/plugins/rbac-impersonate-event-handler.mdx!)
</TabItem>
</Tabs>

### Export the plugin identity

Give the plugin access to a Teleport identity file. We recommend using Machine
ID for this in order to produce short-lived identity files that are less
dangerous if exfiltrated, though in demo deployments, you can generate
longer-lived identity files with `tctl`:

<Tabs>
<TabItem label="Machine & Workload Identity">
(!docs/pages/includes/plugins/tbot-identity.mdx secret="teleport-event-handler-identity"!)
</TabItem>
<TabItem label="Long-lived identity files">
(!docs/pages/includes/plugins/identity-export.mdx user="teleport-event-handler" secret="teleport-event-handler-identity"!)
</TabItem>
</Tabs>

## Step 2/5. Configure Splunk

In this section, you will configure Splunk to ingest and index Teleport audit
events, and create a token for the HEC to authenticate to Splunk. All steps
within this section take place within the Splunk web interface.

### Create an index for Teleport audit events

1. Visit the home page of the Splunk UI and navigate to **Settings > Indexes**.
   Click **New Index**. Name your index `teleport-audit-logs` and assign the
   **Index Data Type** field to `Events`.
1. Fill in the values of the remaining fields, **Max raw data size** and
   **Searchable retention (days)** based on the needs of your organization.
1. Click **Save**.

### [Optional] Create a source type for Teleport audit events

By default, Splunk's `_json` source type expects the `time` field to be in a
different format than that of Teleport audit events. This means that the event
will show up in Splunk at the time it was ingested, not at the time it was
generated. Adjust the format of the `time` field in Splunk so Teleport audit
events appear as expected.

1. Navigate to **Settings -> Source Types**. 
1. Find the `_json` source type and click **Clone**. 
1. Name the new source type `_json-gotime`. 
1. Under **Timestamp** click **Advanced**. 
1. Input `%Y-%m-%dT%H:%M:%S.%3NZ` and click **Save**.

### Create a token for the HTTP Event Collector

1. Visit the home page of the Splunk UI. 
1. Navigate to **Settings > Data inputs**.
1. In the **Local inputs** table, find the HTTP Event Collector row and click
   **Add new**.
1. Enter a name you can use to recognize the token later so you can manage it,
   e.g., `Teleport Audit Events`. 
1. **Click Next**.
1. In the **Input Settings** view, next to the **Source type** field, click
   **Select**.
1. In the **Select Source Type** dropdown menu, click **Structured**, then
   choose the `_json-gotime` type you created earlier. If you skipped that
   optional step, choose `_json`. Splunk will index incoming logs as JSON, which
   is the format the Event Handler uses to send logs to Splunk.
1. In the **Index** section, select the `teleport-audit-logs` index you created
   earlier. 
1. Click **Review,** then view the summary and click **Submit**. 
1. Copy the **Token Value** field and assign <Var name="TOKEN" /> to it so you
   can use it later in this guide.

## Step 3/4. Run the Teleport Event Handler plugin

Now that you have configured your Universal Forwarder to receive logs via HTTP
and forward them to Splunk, you will ensure that the Teleport Event Handler
plugin is configured to authenticate to the Universal Forwarder and your
Teleport cluster, then run the Teleport Event Handler.

### Connect Fluentd to the Splunk HTTP Event Collector

While Splunk used to maintain a dedicated output plugin at
https://github.com/splunk/fluent-plugin-splunk-hec, this has been deprecated.
We can still connect Fluentd to the HEC using Fluentd's built-in HTTP output
plugin.

In Step 1, you generated a configuration file for Fluentd at `fluent.conf`. Edit
your `fluent.conf` file as follows:

1. Edit the `<parse>` section to add the following: 

   ```diff
       <parse>
         @type json
         json_parser oj
   
         # This time format is used by the plugin. This field is required.
         time_type string
         time_format %Y-%m-%dT%H:%M:%S
   +     keep_time_key true
       </parse>
   ```

   This will preserve the `time` field in the JSON when it is sent to Splunk.
   Some Fluentd output plugins require having a parsed time available.

1. Remove the `stdout` output, and add the following section in its place. This
   configures Fluentd to authenticate to the HEC using the token you generated
   earlier:

   ```diff
    <match test.log>
   -  @type stdout
   +  @type http
   +  endpoint https://splunk-hec.example.com:9061/services/collector/raw
   +  headers {"Authorization": "Splunk <Var name="TOKEN" />"}
   +  # tls_verify_mode none
   +  <buffer>
   +    flush_interval 2s
   +  </buffer>
    </match>
   ```

1. Test your changes by running Fluentd:

   ```code
   $ docker run -u $(id -u ${USER}):$(id -g ${USER}) -p 8888:8888 -v $(pwd):/keys -v $(pwd)/fluent.conf:/fluentd/etc/fluent.conf fluent/fluentd:edge
   ```

### Start the Teleport Event Handler

(!docs/pages/includes/start-event-handler.mdx!)

## Step 4/4. Visualize your audit events in Splunk

Since our setup forwards audit events to Splunk in the structured JSON format,
Splunk automatically indexes them, so fields will be available immediately for
use in visualizations. You can use these fields to create dashboards that track
the way users are interacting with your Teleport cluster.

For example, from the Splunk UI home page, navigate to **Search & Reporting** >
**Dashboards** > **Create New Dashboard**. Enter "Teleport Audit Log Types" for
the title of your dashboard and click **Classic Dashboards**. Click **Create**
then, in the **Edit Dashboard** view, click **Add Panel**.

In the **Add Panel** sidebar, click **New** > **Column Chart**. For the **Search
String** field, enter the following:

```text
index="teleport-audit-logs" | timechart count by event
```

Once you click **Add to Dashboard** you will see a count of Teleport event types
over time, which gives you a general sense of how users are interacting with
Teleport:

![Event Types over Time](../../../img/enterprise/plugins/splunk/splunk-dashboard.png)

## Troubleshooting connection issues

If the Teleport Event Handler is displaying error logs while connecting to your
Teleport Cluster, ensure that:

- The certificate the Teleport Event Handler is using to connect to your
  Teleport cluster is not past its expiration date. This is the value of the
  `--ttl` flag in the `tctl auth sign` command, which is 12 hours by default.
- Ensure that in your Teleport Event Handler configuration file
  (`teleport-event-handler.toml`), you have provided the correct host *and* port
  for the Teleport Proxy Service.

## Next steps

Now that you are exporting your audit events to Splunk, consult our [audit event
reference](../../reference/deployment/monitoring/audit.mdx) so you can plan
visualizations and alerts.
