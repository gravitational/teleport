---
title: Teleport Authentication with Microsoft Entra ID (OIDC)
description: How to configure Teleport access with Microsoft Entra ID (formerly Azure AD) as an OIDC identity provider.
labels:
 - how-to
 - zero-trust
---

This guide shows how to configure Entra ID as an OIDC identity provider for 
Teleport. With this configuration, users can access Teleport by authenticating 
with Entra ID, and be granted with permissions to access or manage resource in 
Teleport based on their group membership in Entra ID.

A SAML-based Entra ID IdP configuration version is available in this [guide](entra-id.mdx).

## How it works

In Entra ID, you will create an enterprise application and set up Teleport as an
OIDC relying party. You will also configure the `groups` claim, which will be 
included in the user's OIDC ID Token. 

In Teleport, you will create an Auth Connector resource and set up Entra ID as 
an OIDC identity provider. You will also map Entra ID groups to Teleport roles. 

When Entra ID user signs in to Teleport by authenticating with Entra ID, the following 
things happen in Teleport:
- Teleport verifies the ID Token issued by Entra ID.
- Teleport creates a temporary user account for the authenticated user with roles 
  that are mapped from the user's OIDC `groups` claim values.
- Teleport issues a pair of short-lived TLS and SSH certificates for user session. 
  These certificates encodes user's Teleport roles (mapped via groups claim mapping), 
  granting permission to manage or access resources in Teleport. 

For demonstration, we will have two user groups created in Entra ID: 
1. `ad-app-support`. We will map this group to Teleport preset `requester` role. 
    The preset `requester` role grants permission to request access to resources 
    that are enrolled in Teleport. 
2. `ad-app-admin`. We will map this group to Teleport preset `reviewer` and `editor` 
roles. The preset `editor` role grants permission to manage resource in Teleport. 
The preset `reviewer` grants permission to review access to resources in Teleport.

Instead of creating new groups, you may use an existing Entra ID groups to follow 
through this guide. 

## Prerequisites

- Permissions to create an enterprise application, configure and grant Microsoft 
  Graph API permissions and manage groups in Entra ID.
- Teleport user with a preset `editor` or an equivalent role that allows to 
read and write Auth Connector, users and roles.
- (!docs/pages/includes/tctl.mdx!)

## Step 1/5. Create groups

<Admonition type="info" title="New Group">
  You may skip this step if you are using an existing Entra ID 
  groups to follow through this guide.
</Admonition>

In the Azure portal, select the "Groups" menu under "Azure services". 

From the "Groups" page, click the "New group" button to create a new user group 
named `ad-app-admin`. You may add desired users to this group. 

![Entra ID create group](../../../img/sso/entraid/oidc/entra-id-create-group.png) 

Repeat this step to create another group named `ad-app-support`.

## Step 2/5. Create an enterprise application

In the Azure Portal, under “Azure services”, select “Enterprise applications”.
Click on `+ New Application` button, then click `+ Create your own application` 
button. Enter a name for your application and create the application.

![Entra ID create application](../../../img/sso/entraid/oidc/entra-id-create-application.png) 

## Step 3/5. Assign groups

In the Azure Portal, in the enterprise application UI, select "Users and groups" 
menu which can be located under the "Manage" menu.

In the "Users and groups" UI, click `+Add user/group` button. 

Now assign the two groups you created in Step 1. If you are following this guide 
with an existing user groups, select those groups in this step.

![Entra ID assign](../../../img/sso/entraid/oidc/entra-id-assign-group.png) 

## Step 3/5. Configure OIDC

Configuring OIDC involves setting up a redirect URI for the relying party, 
setting up OIDC claim and a client credential. 

These OIDC configurations are available in the "App registrations" service.

In the Azure Portal, under “Azure services”, select "App registrations".
In the "App registrations" UI, search and select the enterprise application you 
created in Step 2.

### Configure redirect URI

In the "App registrations" UI for the enterprise application, under the “Manage” menu, 
select “Authentication”. In this configuration UI, under the "Platform configurations" 
section, click `+ Add a platform` button. 

OIDC redirect URI for Teleport should point to the OIDC callback endpoint, which 
has the following URI format: `https://example.teleport.sh/v1/webapi/oidc/callback`.

Enter the Teleport Proxy Service hostname of your Teleport cluster below to 
generate the OIDC callback URI. Then copy and paste the value in the Azure Portal
to configure OIDC redirect URI. 
```code
https://<Var name="example.teleport.sh" />/v1/webapi/oidc/callback
```

![Entra ID OIDC redirect URI](../../../img/sso/entraid/oidc/entra-id-oidc-redirect-uri.png)

Save the configuration once redirect URI is configured.

### Setup Client credential 

Teleport uses OIDC authorization code flow to exchange OIDC code for the 
user's ID Token. To exchange the ID Token, a client credential must be set up for 
Teleport. 

In the "App registrations" UI for the enterprise application, under the "Manage" 
menu, select "Certificates & secrets". Now select "Client secrets" tab and click 
on the `+ New client secret` button. Create a new client secret. 

![Entra ID OIDC client credential](../../../img/sso/entraid/oidc/entra-id-oidc-client-credential.png)

Once the secret is created, copy the value and save it in your working environment: 
```bash 
$ echo 'secret value copied from entra id' > /tmp/client-secret
``` 

### Configure OIDC claims

Teleport expects `openid`, `email`, `profile` and 
`groups` claim at minimum.

The `openid`, `email` claims are requested by Teleport as a default. You must 
configure the `groups` claim to configure access in Teleport. You may configure 
other claims as desired. All the claims issued by Entra ID are preserved
as user's traits in the user resource.

In the "App registrations" UI for the enterprise application, under the "Manage" 
menu, select "Token configuration".

In the "Token configuration" UI, click `+ Add groups claim` button.

Select group type you wish to include in user's OIDC `groups` claim. 

The reference image below shows that a "Security groups" type is selected. 

![Entra ID OIDC groups claim](../../../img/sso/entraid/oidc/entra-id-oidc-group-claim.png)

<Admonition type="warning" title="Email Claim">
  Microsoft discourages using `email` claim value for uniquely identifying user 
  as the value is not guaranteed to come from a verified email address. 

  As a precaution, ensure that user's with unverified domain are not assigned to 
  the enterprise application created in Step 2.
</Admonition>

### (Optional) Groups claim overage

If user's group membership exceeds 200 groups limit, Entra ID issues a groups 
overage claim instead of the expected `groups` claim. To follow through the 
groups overage claim, Teleport needs to query Microsoft Graph API and fetch 
user's group membership details.

If your user's group membership do not exceed this 200 max groups claim item limit, 
you can skip this step. Otherwise, you will need to grant Teleport with a Microsoft
Graph API permission so it can retrieve user's group membership using the Microsoft 
Graph API. 

Teleport requires `User.ReadBasic.All` permission to query user's group membership.
To grant this permission, in the "App registrations" UI for the enterprise 
application, under the "Manage" menu, select "API permissions".

Next, click `+ Add a permission` button and then select "Microsoft APIs > Microsoft Graph >
Application permissions". In the permission filter search bar, type `User.ReadBasic.All`.

Select the permission and add it to the application by clicking on the `Add permissions` button.

![Entra ID OIDC graph permission](../../../img/sso/entraid/oidc/entra-id-oidc-graph-permission.png)

Once you add the permission, you will need to grant an admin consent.

In the same "API permissions" UI, click the `Grant admin consent` button.

A consent confirmation prompt will appear, click "Yes" to grant the consent. 

The Graph API permission to fetch user's group membership is now configured.
Should the user's group membership exceed 200 groups, Teleport will follow through 
the groups overage claim issued by Entra ID and fetch user's groups detail using the 
Microsoft Graph API. 

## Step 4/5 Create OIDC connector 

Before creating the Auth Connector resource, its useful to first generate the 
configuration spec and test the configuration.

The Auth Connector spec can be created by using the `tctl sso configure` command. 

```code
$ tctl sso configure oidc --name "entra-id" \
  --display "Entra ID" \
  --issuer-url https://login.microsoftonline.com/<Var name="Entra ID tenant ID" />/v2.0 \
  --id <Var name="Enterprise application client ID" /> \
  --secret $(cat /tmp/client-secret) \
  --claims-to-roles groups,<Var name="Object ID of ad-app-admin group" />,editor,reviewer \
  --claims-to-roles groups,<Var name="Object ID of ad-app-support group" />,requester \
  --scope openid \
  --scope email \
  --scope profile > entraid-oidc-connector.yaml
```

- `--name`: Usually the name of the IdP, this is how the connector will be
  identified in Teleport.
- `--issuer-url`: This is the base path to the IdP's OIDC configuration endpoint,
  excluding `.well-known/openid-configuration`. If, for example, the endpoint
  is `https://example.com/.well-known/openid-configuration`, you would use
  `https://example.com`.
- `--id`: The client ID as defined in the IdP. Depending on your identity
  provider this may be something you can define (for example, `teleport`), or 
  may be an assigned string.
- `--secret`: The client token/secret provided by the IdP to authorize this client.
- `--claims-to-roles`: A mapping of OIDC claims/values to be associated with
  Teleport roles. Note that the Entra ID `groups` claim includes group's object ID.
  As such, you will need to map groups by using groups object ID.

Test the connector resource by piping the file to `tctl sso test` command:

```code
$ cat entraid-oidc-connector.yaml | tctl sso test
```
If the configuration test fails, the `tctl sso test` command will print helpful 
information to debug the issue.

If the configuration is working for you, proceed creating the connector resource 
by using the `tctl create` command:

```code
$ tctl create -f entraid-oidc-connector.yaml
```

## Troubleshooting

(!docs/pages/includes/sso/loginerrortroubleshooting.mdx!)

### Identity provider callback failed, missing parameter "Name"

Teleport uses the `email` claim as user's username. 
This error indicates that an `email` claim was not found in user's OIDC ID Token
claims.

This can happen if the user does not have a domain verified email account.

Alternatively, you can update the connector spec to use `preferred_username` value
as an alternative of `email` claim.

```yaml
  username_claim: preferred_username
```

## Next steps

- Learn more about other [OIDC](oidc.mdx#oidc-connector-configuration) related 
  configuration that Teleport supports.
- Learn more about [Role and Resource Access Request](../../identity-governance/access-requests/access-requests.mdx).
- Learn more about [role templates](../rbac-get-started/role-templates.mdx).
- [Teleport Configuration Resources Reference](../../reference/resources.mdx)