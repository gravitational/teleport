---
title: Configure Entra ID as an OIDC Identity Provider
description: How to configure Teleport access with Entra ID using OIDC.
labels:
 - how-to
 - zero-trust
---

This guide shows how to configure Entra ID as an OIDC identity provider for 
Teleport. With this configuration, users can access Teleport by authenticating 
with Entra ID, and be granted with permissions to access or manage resource in 
Teleport based on their group membership in Entra ID.

See [Teleport authentication with Entra ID as an SAML identity provider](azuread.mdx) 
if you want to configure Entra ID as an SAML identity provider for Teleport. 

## How it works

In Entra ID, you will create an enterprise application and set up Teleport as an
OIDC relying party. You will also configure the `groups` claim, which will be 
included in the user's OIDC ID Token. 

In Teleport, you will create an Auth Connector resource and set up Entra ID as 
an OIDC identity provider. You will also map Entra ID group IDs to Teleport roles. 

When user signs in to Teleport by authenticating with Entra ID, the following 
things happen in Teleport:
- Teleport verifies the ID Token issued by Entra ID,
- Teleport creates a temporary user account for the authenticated user with roles 
  that are mapped from the user's OIDC `groups` membership claim values.
- Teleport issues a pair of short-lived TLS and SSH certificates for user session. 
  These certificates encodes user's Teleport roles (mapped via groups claim mapping), 
  effectively granting permission to manage or access resources in Teleport. 

For demonstration, will have two user groups created in Entra ID: 
1. `ad-app-support`. We will map this group to Teleport preset `requester` role. 
    The preset `requester` role grants permission to request access to resources 
    that are enrolled in Teleport. 
2. `ad-app-admin`. We will map this group to Teleport preset `reviewer` and `editor` 
roles. The preset `editor` role grants permission to manage resource in Teleport. 
The preset `reviewer` grants permission to review access to resources in Teleport, 
granting Just-in-Time access. 

## Prerequisites

- Teleport user with preset `editor` or an equivalent role that allows to 
read and write Auth Connector, roles and Access Lists. 
- Permission to create an enterprise application and manage groups in Entra ID.
- (!docs/pages/includes/tctl.mdx!)

## Step 1/5. Create groups

<Admonition type="info" title="New Group">
  You may skip this step if you are using an existing Entra ID 
  groups to follow through this guide.
</Admonition>

In the Azure portal, select the "Groups" menu under "Azure services". 

From the "Groups" page, click the "New group" button to create a new user group 
named `ad-app-support`. You may add desired users to this group. 

![Entra ID create group](../../../img/sso/entraid/oidc/entra-id-create-group.png) 

Repeat this step to create another group named `ad-app-support`.

## Step 2/5. Create an enterprise application

In the Azure Portal, under “Azure services”, select “Enterprise applications”.
Click on `+ New Application` button, then click `+ Create your own application` 
button. Enter a name for your application and create the application.

![Entra ID create application](../../../img/sso/entraid/oidc/entra-id-create-application.png) 

## Step 3/5. Assign groups

In the enterprise application UI in the Azure Portal, from the side navigation 
menu, select "Users and groups" menu and click `+Add user/group` button. 

Now assign the two groups you created in Step 1. If you are following this guide 
with an existing user groups, select those groups in this step.

![Entra ID assign](../../../img/sso/entraid/oidc/entra-id-assign-group.png) 

## Step 3/5. Configure OIDC

Configuring OIDC involves setting up a redirect URI for the relying party, 
setting up OIDC claim and client credential. 

These OIDC configurations are available in the "App registrations" menu.

In the Azure Portal, under “Azure services”, select "App registrations".
In the "App registrations" UI, search and select the enterprise application you 
created in Step 2.

### Configure redirect URI

In the "App registrations" UI for the enterprise application, under “Manage” menu, 
select “Authentication”. In this configuration UI, under "Platform configurations" 
section, click `+ Add a platform` button. 

OIDC redirect URI for Teleport should point to the OIDC callback endpoint, which 
has the following format: `https://example.teleport.sh/v1/webapi/oidc/callback`.

Enter the Teleport Proxy Service hostname of your Teleport cluster below to 
generate the OIDC callback URI. Then copy and paste the value in the Azure Portal
to configure OIDC redirect URI. 
```code
https://<Var name="example.teleport.sh" />/v1/webapi/oidc/callback
```

![Entra ID OIDC redirect URI](../../../img/sso/entraid/oidc/entra-id-oidc-redirect-uri.png)

Save the configuration once redirect URI is configured.

### Setup Client credential 

Teleport uses OIDC authorization code flow to exchange authorized code for the 
user's ID Token. To exchange the ID Token, a client credential must be set up for 
Teleport. 

In the "App registrations" UI for the enterprise application, under "Manage" menu, 
select "Certificates & secrets". Now select "Client secrets" tab and click on 
`+ New client secret` button. Create a new client secret. 

![Entra ID OIDC client credential](../../../img/sso/entraid/oidc/entra-id-oidc-client-credential.png)

Once the secret is created, copy the value and save it in your working environment: 
```bash 
$ echo 'secret copied from entra id' > /tmp/client-secret
``` 

### Configure groups claim

In the "App registrations" UI for the enterprise application, under "Manage" menu, 
select "Token configuration".

In the "Token configuration" page, click `+ Add groups claim` button.

Select group type you wish to include in user's OIDC `groups` claim. 

The reference image below shows "Security groups" is selected. 

![Entra ID OIDC groups claim](../../../img/sso/entraid/oidc/entra-id-oidc-group-claim.png)

### (Optional) Groups claim overage

Entra ID imposes maximum 200 items limit for the user's `groups` claim. 
If user's group membership exceeds this limit, Entra ID sends a groups overage 
claim instead of a `groups` claim. To follow through the groups overage claim, 
Teleport needs to query Microsoft Graph API and fetch user's group membership details.

If your user's group membership do not exceed this 200 max item limit, you can skip this step. 
Otherwise, you will need to grant Teleport a Graph API permission so it can retrieve user's 
group membership using the Microsoft Graph API. 

To configure Graph API permission, in the "App registrations" UI for the enterprise 
application, under "Manage" menu, select "API permissions".

Next, click `+ Add a permission` button and then select "Microsoft APIs > Microsoft Graph >
Application permissions". In the permission filter search bar, type `User.ReadBasic.All`.

For this purpose, the client credential that you configured above must be granted 
with `User.ReadBasic.All` Graph API permission. This permission must be of "Application" type.

![Entra ID OIDC graph permission](../../../img/sso/entraid/oidc/entra-id-oidc-graph-permission.png)

Once you add the permission, you will need to grant an admin consent.

A consent confirmation prompt will appear, click "Yes" to grant the consent. 

The Graph API permission to fetch user's group membership is now configured.
Should the user's group membership exceed 200 groups, Teleport will follow through 
the groups overage claim sent by Entra ID and fetch user's group using the 
Microsoft Graph API. 

## Step 4/5 Create OIDC connector 

To create a new connector, use `tctl sso configure`. The following example creates a
connector resource file in YAML format named `oidc-connector.yaml`:

```code
$ tctl sso configure oidc --name "Entra ID" \
  --issuer-url https://login.microsoftonline.com/<Var name="Entra id tenant ID" />/v2.0 \
  --id <Var name="enterprise app client id" /> \
  --secret $(cat /tmp/client-secret) \
  --claims-to-roles groups,<Var name="Object ID of ad-app-admin group" />,editor,reviewer \
  --claims-to-roles groups,<Var name="Object ID of ad-app-support group" />,requester \
  --scope openid \
  --scope email \
  --scope profile > entraid-oidc-connector.yaml
```

- `--name`: Usually the name of the IdP, this is how the connector will be
  identified in Teleport.
- `--issuer-url`: This is the base path to the IdP's OIDC configuration endpoint,
  excluding `.well-known/openid-configuration`. If, for example, the endpoint
  is `https://example.com/.well-known/openid-configuration`, you would use
  `https://example.com`.
- `--id`: The client ID as defined in the IdP. Depending on your identity
  provider this may be something you can define (for example, `teleport`), or 
  may be an assigned string.
- `--secret`: The client token/secret provided by the IdP to authorize this client.
- `--claims-to-roles`: A mapping of OIDC claims/values to be associated with
  Teleport roles.


Test the connector resource by piping the file to `tctl sso test`:

```code
$ cat entraid-oidc-connector.yaml | tctl sso test
```

By default, Teleport looks for an `email` claim to be present in the ID Token.
The value contained in the `email` claim is used as a username and is used to 
uniquely identify user in Teleport.

<Admonition type="warning" title="Email Claim">
  Microsoft discourages using `email` claim value for uniquely identifying user 
  as the value is not guarenteed to come from a verified email address. 

  As a precaution, ensure that user's with unverified domain are not assigned to 
  the enterprise application created in Step 2.
</Admonition>

Create the connector using `tctl` tool:

```code
$ tctl create -f entraid-oidc-connector.yaml
```

## Troubleshooting

### Identity provider callback failed, missing parameter Name

This error occurs when an `email` claim was not found in user's ID Token. 
This can happen if the user does not have a domain verified email account.

Alternatively, you can update the connector spec to use `preferred_username` value
as an alternative of `email` claim.

```yaml
  username_claim: preferred_username
```