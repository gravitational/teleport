---
title: Register Services via Join Token
description: How to register services with your Teleport cluster via a join token
---

In this guide, we will show you how to register a Teleport service with your
cluster by presenting a **join token**. 

In this approach, you declare your intention to register a new service, and
Teleport generates a secure token for the service. When the service starts, it
presents the token, indicating to your Teleport cluster that it is trustworthy.

## Prerequisites

(!docs/pages/includes/edition-prereqs-tabs.mdx!)

- A Linux server that you will use to host your Teleport service. 

  In this guide, we will show you how to register a Teleport SSH Service
  instance. This approach applies to new Proxy Service instances as well as the
  Kubernetes Service, Database Service, and other Teleport services for
  accessing resources in your infrastructure.

(!docs/pages/includes/tctl.mdx!)

## Step 1/3. Install Teleport

Install Teleport on the host where you will run your Teleport service.

(!docs/pages/includes/install-linux.mdx!)

## Step 2/3. Join your service to the cluster

In this section, we will join your Teleport service to the Teleport cluster by:

- Obtaining a join token
- Running your Teleport service with the join token

### Generate a token

Teleport only allows access to services that have joined the cluster.

Once a service joins, it receives a host certificate signed by the cluster's
Auth Service. To receive a host certificate upon joining a cluster, a new
Teleport host must present an **invite token**.

An invite token also defines which role a new host can assume within a cluster:

- `proxy`
- `node`
- `auth`
- `app`
- `db`
- `kube`
- `windowsdesktop`

Administrators can generate tokens as they are needed. A token can be used
multiple times until its time to live (TTL) expires.

On your local machine, use the `tctl` tool to generate a new token. In the
following example, a new token is created with a TTL of five minutes:

```code
# Generate a short-lived invite token for a new node:
$ export INVITE_TOKEN=$(tctl nodes add --ttl=5m --roles=node | grep "invite token:" | grep -Eo "[0-9a-z]{32}")
$ echo $INVITE_TOKEN
# (=presets.tokens.first=)

# You can also list all generated non-expired tokens:
$ tctl tokens ls
# Token                            Type            Expiry Time
# ------------------------         -----------     ---------------
# (=presets.tokens.first=)         service            25 Sep 18 00:21 UTC
```

<Details title="Provide your own token value">

Rather than automatically generating a token, you can create one with a known
value by using the `--token` flag:

```code
$ tctl nodes add --ttl=5m --roles=node,proxy --token=secret-value
# The invite token: secret-value
```

The value of `--token` should be cryptographically secure. For example, you can
create an SHA256 hash to reduce the risk that a malicious actor will produce
a token with the same value as yours:

```code
$ head -n 1 /dev/random | sha256sum
```

</Details>

<Details scope={["oss","enterprise"]} title="An insecure alternative: static tokens" scopeOnly={false} >

<Notice type="Danger">
Use short-lived tokens instead of long-lived static tokens.
Static tokens are easier to steal, guess, and leak.
</Notice>

Static tokens are defined ahead of time by an administrator and stored in the
auth server's config file:

```yaml
# Config section in `/etc/teleport.yaml` file for the auth server
auth_service:
    enabled: true
    tokens:
    # This static token allows new hosts to join the cluster as "proxy" or "node"
    - "proxy,node:secret-token-value"
    # A token can also be stored in a file. In this example the token for adding
    # new auth servers are stored in /path/to/tokenfile
    - "auth:/path/to/tokenfile"
```
</Details>

### Start your service with the invite token

Execute the following commands on the host where you will run your service so you
can use the `INVITE_TOKEN` variable to start Teleport.

```code
$ export INVITE_TOKEN=<Var name="invite-token" />
```

Still on the host where you will run your service, assign the address of your
Teleport Cloud tenant to an environment variable, including the domain name (or
IP address) and port `443`:

```code
$ export ADDR=mytenant.teleport.sh:443
```

<Details title="Ensuring the correct ports are opened">

If you are have disabled TLS Routing, the Teleport Proxy Service listens on
separate ports in order to register new services, rather than performing all
activity via port 443. 

Using the ports in Teleport's default configuration, your service needs to be
able to talk to ports `3080` and `3024` on the Proxy Service. Port `3080` is
used to initially fetch the credentials (SSH and TLS certificates) and for
discovering the reverse tunnel. Port `3024 `is used to establish a connection to
the Auth Service through the Proxy.

</Details> 

<Details
  type="tip"
  title="Using multiple Proxy Service instnaces behind a load balancer"
>

  The setup above also works even if the cluster uses multiple Proxy Service
  instances behind a load balancer (LB) or a DNS entry with multiple values. In
  this case, the service establishes a tunnel to every Proxy Service instance.
  
  This requires that an LB use a round-robin or a similar balancing algorithm.
  Do not use sticky load balancing algorithms (a.k.a. "session affinity") with
  Teleport Proxy Service instances.  

</Details>

Execute the following command on your service to add it to a cluster:

```code
$ sudo teleport start \
   --roles=node \
   --token=${INVITE_TOKEN?} \
   --auth-server=${ADDR?}
```

As new services come online, they start sending ping requests every few seconds to
the Auth Service. This allows users to explore cluster membership and size.

Run the following command on your local machine to see all of the Teleport services
in your cluster:

```code
$ tctl nodes ls

service Name     service ID                                  Address            Labels
---------     -------                                  -------            ------
turing        d52527f9-b260-41d0-bb5a-e23b0cfe0f8f     10.1.0.5:3022      distro:ubuntu
dijkstra      c9s93fd9-3333-91d3-9999-c9s93fd98f43     10.1.0.6:3022      distro:debian
```

## Step 3/3. Revoke an invitation

Tokens used for joining services to a cluster can be revoked before they are used.

Run the following command on your local machine to create a token for a new
Proxy Service:

```code
$ tctl nodes add --ttl=5m --roles=proxy 
# The invite token: (=presets.tokens.first=).
# This token will expire in 5 minutes.
# 
# Run this on the new node to join the cluster:
# 
# > teleport start \
#    --roles=proxy \
#    --token=(=presets.tokens.first=) \
#    --ca-pin=(=presets.ca_pin=) \
#    --auth-server=123.123.123.123:443
# 
# Please note:
# 
#   - This invitation token will expire in 5 minutes
#   - 123.123.123.123 must be reachable from the new node
```

Next, run the following command to see a list of outstanding tokens:

```
$ tctl tokens ls

# Token                                Role       Expiry Time (UTC)
# -----                                ----       -----------------
# (=presets.tokens.first=)     Proxy      never
# (=presets.tokens.second=)     Service    17 May 16 03:51 UTC
# (=presets.tokens.third=)     Signup     17 May 16 04:24 UTC
```

<Admonition type="tip" title="Signup tokens">

The output of `tctl tokens ls` includes tokens used for adding users alongside
tokens used for adding services to your cluster.

</Admonition>

In this example, the first token has a `never` expiry date because it is a
static token configured via a config file.

The token with the `service` role was generated to invite a new service to this
cluster. And the third token was generated to invite a new user to sign up.

Tokens created via `tctl` can be deleted (revoked) via the `tctl tokens del`
command. Run the following command to delete a token:

```code
$ tctl tokens del (=presets.tokens.first=)
# Token (=presets.tokens.first=) has been deleted
```

## Next steps

- If you have workloads split across different networks or clouds, we recommend
  setting up Trusted Clusters. Read how to get started in our [Trusted Clusters
  guide](../admin/trustedclusters.mdx).

