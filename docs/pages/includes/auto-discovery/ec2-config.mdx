If you are running the Discovery Service on its own host, the service requires a
valid invite token to connect to the cluster. Generate one by running the
following command against your Teleport Auth Service:

```code
$ tctl tokens add --type=discovery
```

Save the generated token in `/tmp/token` on the Node (EC2 instance) that will
run the Discovery Service.

(!docs/pages/includes/discovery/discovery-group.mdx!)

Assign <Var name="teleport.example.com:443" /> to the host and port of the Teleport Proxy Service in your cluster,
and <Var name="aws-prod" /> to a name that identifies a group of resources that you will enroll:

```yaml
# teleport.yaml
version: v3
teleport:
  join_params:
    token_name: "/tmp/token"
    method: token
  proxy_server: "<Var name="teleport.example.com:443" />"
auth_service:
  enabled: false
proxy_service:
  enabled: false
ssh_service:
  enabled: false
discovery_service:
  enabled: true
  discovery_group: <Var name="aws-prod" />
```

Create a matcher for the resources you want to enroll.

<Admonition type="tip">
Dynamic configuration uses Discovery Configs which can be managed using Terraform.
See the [Terraform `discovery_config` reference](../../reference/infrastructure-as-code/terraform-provider/resources/discovery_config.mdx) for more information.

Static configuration while simpler at first, has less flexibility because enrollment changes require edits to `teleport.yaml` and the restart of the Discovery Service.
</Admonition>

<Tabs>
<TabItem label="Dynamic configuration (recommended)">
  Create a Discovery Config resource, that has the same discovery group you configured earlier, to enable EC2 instance discovery.

  Create a file named `discovery-aws-prod.yaml` with the following content:
  ```yaml
  kind: discovery_config
  version: v1
  metadata:
    name: example-discovery-config
  spec:
    discovery_group: <Var name="aws-prod" />
    aws:
    - types: ["ec2"]
      regions: ["us-east-1", "us-west-1"]
      tags:
        "env": "prod" # Match EC2 instances where tag:env=prod
      ssm:
        document_name: "AWS-RunShellScript"
      install:
        enroll_mode: 1
        install_teleport: true
        join_method: iam
        join_token: aws-discovery-iam-token
  ```
  Adjust the keys under `spec.aws` to match your EC2 environment,
  specifically the regions and tags you want to associate with the Discovery Service.

  Create the Discovery Config by running the following command:
  ```code
  $ tctl create -f discovery-aws-prod.yaml
  ```

  Matching instances will be added to the Teleport cluster automatically.

  You can update the Discovery Config at any time, and the service will automatically re-apply the changes.
</TabItem>

<TabItem label="Static configuration">
  In order to enable EC2 instance discovery the `discovery_service.aws` section
  of `teleport.yaml` must include at least one entry:

  ```yaml
  # teleport.yaml
  # ...
  discovery_service:
    enabled: true
    discovery_group: <Var name="aws-prod" />
    aws:
    - types: ["ec2"]
      regions: ["us-east-1", "us-west-1"]
      tags:
        "env": "prod" # Match EC2 instances where tag:env=prod
      ssm:
        document_name: "AWS-RunShellScript"
      install:
        enroll_mode: script
        install_teleport: true
        join_params:
          token_name: aws-discovery-iam-token
          method: iam
  ```
  
  Adjust the keys under `discovery_service.aws` to match your EC2 environment, 
  specifically the regions and tags you want to associate with the Discovery Service.
</TabItem>

</Tabs>
