---
title: Relay service
description: How to deploy and use a Teleport Relay service
---

<Admonition type="warning">

This page refers to an unreleased Teleport feature and is thus subject to change. The following documentation applies to version `v18.1.2-dev.relay.2`.

<details>
<summary>Download links</summary>
- [Linux ARM64/ARMv8 (64-bit) RPM](https://cdn.cloud.gravitational.io/teleport-ent-18.1.2-dev.relay.2-1.arm64.rpm)
- [Linux ARMv7 (32-bit) RPM](https://cdn.cloud.gravitational.io/teleport-ent-18.1.2-dev.relay.2-1.arm.rpm)
- [Linux 32-bit RPM](https://cdn.cloud.gravitational.io/teleport-ent-18.1.2-dev.relay.2-1.i386.rpm)
- [Linux 64-bit RPM](https://cdn.cloud.gravitational.io/teleport-ent-18.1.2-dev.relay.2-1.x86_64.rpm)
- [Linux 64-bit DEB](https://cdn.cloud.gravitational.io/teleport-ent_18.1.2-dev.relay.2_amd64.deb)
- [Linux ARM64/ARMv8 (64-bit) DEB](https://cdn.cloud.gravitational.io/teleport-ent_18.1.2-dev.relay.2_arm64.deb)
- [Linux ARMv7 (32-bit) DEB](https://cdn.cloud.gravitational.io/teleport-ent_18.1.2-dev.relay.2_arm.deb)
- [Linux 32-bit DEB](https://cdn.cloud.gravitational.io/teleport-ent_18.1.2-dev.relay.2_i386.deb)
- [MacOS Universal .pkg installer](https://cdn.cloud.gravitational.io/teleport-ent-18.1.2-dev.relay.2.pkg)
- [Teleport Connect 64-bit DEB](https://cdn.cloud.gravitational.io/teleport-connect_18.1.2-dev.relay.2_amd64.deb)
- [Teleport Connect](https://cdn.cloud.gravitational.io/Teleport%20Connect-18.1.2-dev.relay.2.dmg)
- [Teleport Connect 64-bit](https://cdn.cloud.gravitational.io/teleport-connect-18.1.2-dev.relay.2-x64.tar.gz)
- [Teleport Connect 64-bit RPM](https://cdn.cloud.gravitational.io/teleport-connect-18.1.2-dev.relay.2.x86_64.rpm)
- [Teleport Connect](https://cdn.cloud.gravitational.io/Teleport%20Connect%20Setup-18.1.2-dev.relay.2.exe)
- [MacOS Intel](https://cdn.cloud.gravitational.io/teleport-ent-v18.1.2-dev.relay.2-darwin-amd64-bin.tar.gz)
- [MacOS ARM](https://cdn.cloud.gravitational.io/teleport-ent-v18.1.2-dev.relay.2-darwin-arm64-bin.tar.gz)
- [MacOS Universal](https://cdn.cloud.gravitational.io/teleport-ent-v18.1.2-dev.relay.2-darwin-universal-bin.tar.gz)
- [Windows (64-bit)](https://cdn.cloud.gravitational.io/teleport-v18.1.2-dev.relay.2-windows-amd64-bin.zip)
- [Linux 32-bit](https://cdn.cloud.gravitational.io/teleport-ent-v18.1.2-dev.relay.2-linux-386-bin.tar.gz)
- [Linux 64-bit](https://cdn.cloud.gravitational.io/teleport-ent-v18.1.2-dev.relay.2-linux-amd64-bin.tar.gz)
- [Linux 64-bit (RHEL/CentOS 7.x compatible)](https://cdn.cloud.gravitational.io/teleport-ent-v18.1.2-dev.relay.2-linux-amd64-centos7-bin.tar.gz)
- [Linux ARM64/ARMv8 (64-bit)](https://cdn.cloud.gravitational.io/teleport-ent-v18.1.2-dev.relay.2-linux-arm64-bin.tar.gz)
- [Linux ARMv7 (32-bit)](https://cdn.cloud.gravitational.io/teleport-ent-v18.1.2-dev.relay.2-linux-arm-bin.tar.gz)
</details>

</Admonition>

A Relay service group consists of one or more Teleport instances configured to run the Relay service with the same relay group name, all accessible behind the same load balancer. The Relay service uses two endpoints, one for "transport" access used by clients for the SSH transport and, in the future, for Kubernetes access forwarding, and one for "tunnel" access used by agents to fetch the relay group configuration and to run reverse tunnels. Both of those ports should be accessible through a load balancer that forwards connections to all the agents in the same Relay group. The Relay service instances connect to each other for the purpose of forwarding connections over the internal "peer" port.

The configuration for the Relay service is described as follows:

```yaml
version: v3
teleport:
  # the join method should be valid for joining as a Relay, creating such a token
  # currently requires using the `tctl` tool from the same prerelease version
  join_params:
  # ...
  proxy_server: teleport.example.com:443
  # optional duration value, how long the Relay should wait while broadcasting
  # its termination status before actually beginning its shutdown; should be set
  # to a value long enough for all agents pointed at the group to successfully
  # open new connections to new members of the group during rollouts
  shutdown_delay: '1m'
auth_service:
  enabled: false
proxy_service:
  enabled: false
ssh_service:
  enabled: false
relay_service:
  enabled: true

  # a name assigned to the group, should be the same across instances
  # for the same group and should be unique in the cluster
  relay_group: groupname

  # how many tunnels to distinct Relays should be opened by the Teleport
  # instances pointed at this group
  target_connection_count: 2

  # hostnames or IP addresses that the endpoints is expected to be reached at
  # by clients and agents alike; normally it will just be one, but can be set to
  # multiple names in case the address should be changed, for seamless migrations
  public_hostnames:
    - relay-api-load-balancer.example.com

  transport_listen_addr: 0.0.0.0:3040
  peer_listen_addr: 0.0.0.0:3041
  tunnel_listen_addr: 0.0.0.0:3042

  # set to true to require (and trust) a PROXY protocol v2 header for connections
  # to the two listeners
  #transport_proxy_protocol: false
  #tunnel_proxy_protocol: false
```

<Admonition type="warning">

The current version of the Relay service requires agents to make use of a single Relay tunnel address behind a load balancer. Direct connections from agents to individual Relay instances is planned as an optional mode of operation in future versions.

</Admonition>

<Admonition type="warning">

The intended way to deploy the Relay service is through some container orchestrator that can launch new replicas and terminate old ones as necessary, to maintain high availability and uptime even during upgrades or configuration changes. As such, the Relay service is not designed to support in-place restarts or reusing the same host ID, manual installations in "stateful" virtual machines are discouraged, and the `teleport-relay` chart runs the Relay instances as a Kubernetes deployment and does not maintain any state (unlike the `teleport-kube-agent` chart), so the use of a secretless join method (`iam` through EKS Pod Identity, for example) is strongly recommended.

</Admonition>

Teleport agents running the SSH service can be configured to use a Relay by specifying `teleport.relay_server` to point at the Relay tunnel endpoint in their configuration file:

```yaml
version: v3
teleport:
  join_params:
    # ...
  proxy_server: teleport.example.com:443
  relay_server: relay-api-load-balancer.example.com:3042
auth_service:
  enabled: false
proxy_service:
  enabled: false
ssh_service:
  enabled: true
```

If `teleport.relay_server` is set, the agent will open reverse tunnels against the Relay in addition to its usual reverse tunnels against the Teleport control plane. Setting the `TELEPORT_UNSTABLE_DISABLE_REVERSE_TUNNEL` envvar to `yes` will disable the standard reverse tunnels (during testing, it can be useful to confirm that the connections are using the Relay). The relay is only used if the agent is using "tunnel mode" (i.e. when the agent is pointed at a proxy rather than directly to an auth).

Inspecting the node heartbeat should show the indication that it's available through the Relay group, and the host IDs of the Relay Service instances it's connected to:

```shell
$ tsh ls --format yaml --search nodename
- kind: node
  metadata:
    expires: "2025-08-08T14:49:15Z"
    name: 58b5c8e3-7742-4d5d-99e8-78c5fa882294
    revision: 6a17a77d-b52c-4290-b497-ca1bfc71cbb9
  spec:
    addr: ""
    hostname: nodename
    proxy_ids:
    - 2d38cd31-da30-4de6-9222-afa2a905a825
    - 542d7955-dd4b-4ad9-b219-8c8b71010691
    relay_group: groupname
    relay_ids:
    - 9f233419-1a4d-4497-882a-cf4983d40929
    - 16509408-41d8-4308-920d-0293331eb92a
    use_tunnel: true
    version: 18.1.2-dev.relay.2
  version: v2

```

Likewise, inspecting the list of Relay Service heartbeats should show one entry for each instance:

```shell
$ tctl get relay_server
kind: relay_server
metadata:
  expires: "2025-08-08T14:55:09.914279Z"
  name: 9f233419-1a4d-4497-882a-cf4983d40929
  revision: 7c93d70a-3898-445b-8bc1-82b847d626e0
spec:
  hostname: relayhostname
  nonce: 29f3b44b-ff02-4353-b026-4f98f8cc6883
  peer_addr: 10.12.41.121:3041
  relay_group: groupname
version: v1
---
kind: relay_server
# ...
```

All Teleport SSH clients can make use of a relay by setting the `TELEPORT_UNSTABLE_RELAY_ADDR` envvar to point at the Relay API endpoint address (using port 443 if unspecified). The envvar should be set at connection time when using `tsh`, the `tsh` OpenSSH integration or a Machine ID `identity` output. The envvar must be set for the `tbot` process when using an `ssh-multiplexer` service. The final release of the Relay feature will include CLI options to set the desired Relay address at `tsh login` time and ways to enable and choose the Relay to use for each output and service in the `tbot` configuration file.

If the `TELEPORT_UNSTABLE_RELAY_ADDR` envvar is set, all Teleport SSH client connection are guaranteed to either fail or result in a connection to the relay, which will potentially connect to a different relay of its group, and then forward the connection along through the relay connection to the appropriate agent, without any SSH traffic going through the regular Teleport control plane.

## Deploying a Relay with the `teleport-relay` chart

The `teleport-relay` chart (available in the `https://charts.releases.development.teleport.dev` Helm repository, or usable directly through the `https://charts.releases.development.teleport.dev/teleport-relay-18.1.2-dev.relay.2.tgz` URL) sets up a deployment with two replicas and a load balancer, using ports 443 and 3042. Use of the chart requires setting some values:

```yaml
proxyAddr: teleport.example.com:443

# the `teleport.join_params` section of the Teleport config file, the join method should be
# valid for joining as a Relay; creating such a token currently requires using the `tctl` tool
# from the same prerelease version
joinParams:
  method: iam
  token_name: tokenname

relayGroup: groupname
#targetConnectionCount: 2
shutdownDelay: '1m'

publicHostnames:
  - relay-api-load-balancer.example.com

# set to true to require (and trust) a PROXY protocol v2 header for connections
# to the two listeners
#transportProxyProtocol: false
#tunnelProxyProtocol: false

image:
  # required for the prerelease, will be automatic on final
  # release (except maybe for an "enterprise" flag)
  repository: 'public.ecr.aws/gravitational-staging/teleport-ent-distroless-debug'
  # defaults to the version of the chart, can be overridden
  #tag: '18.1.2-dev.relay.2'

#deploymentSpec:
#  replicas: 2

# should account for the optional shutdown delay
terminationGracePeriodSeconds: 300
```

Other options are described in [the chart's default `values.yaml`](https://github.com/gravitational/teleport/blob/v18.1.2-dev.relay.2/examples/chart/teleport-relay/values.yaml); options such as `serviceSpec` and `serviceAnnotations` can be quite useful to configure the properties of the load balancer, for example.
