---
title: Configuring Workload Identity and AWS OIDC Federation with JWTs
description: Configuring AWS to accept Workload Identity JWTs as authentication using OIDC Federation
---

<Admonition type="tip" title="Preview">
Teleport Workload Identity is currently in Preview. This means that some
features may be missing. We're actively looking for design partners to help us
shape the future of Workload Identity and would love to
[hear your feedback](mailto:product@goteleport.com).
</Admonition>

Teleport Workload Identity issues flexible short-lived identities in JWT format.
AWS OIDC Federation allows you to use these JWTs to authenticate to AWS
services.

This can be useful in cases where a machine needs to securely authenticate with
AWS services without the use of a long-lived credential. This is because the
machine can authenticate with Teleport without using any shared secrets by
using one of our delegated join methods.

In this guide, we'll configure Teleport Workload Identity and AWS to allow our
workload to authenticate to the AWS S3 API and upload content to a bucket.

## How it works

This implementation differs from using the Teleport Application Service to protect
AWS APIs in a few ways:

- Requests to AWS are not proxied through the Teleport Proxy Service, meaning
  reduced latency but also less visibility, as these requests will not be
  recorded in Teleport's audit log.
- Workload Identity works with any AWS client, including the command-line tool
  but also their SDKs.
- Using the Teleport Application Service to access AWS does not work with Machine
  ID and therefore cannot be used when a machine needs to authenticate with AWS.

## OIDC Federation vs Roles Anywhere

The AWS platform offers two routes for workload identity federation: OIDC
Federation and Roles Anywhere. Teleport Workload Identity supports both of these
methods.

There are a number of differences between the two methods:

- OIDC Federation exchanges a JWT SVID for an AWS credential, whereas Roles
  Anywhere exchanges an X509 SVID for an AWS credential. The use of X509 SVIDs
  is generally considered more secure.
- OIDC Federation does not require the additional installation of an AWS
  credential helper alongside workloads, whereas Roles Anywhere does.
- OIDC Federation requires that your Teleport Proxy Service is reachable by
  AWS, whereas Roles Anywhere does not.

This guide covers configuring OIDC federation, for Roles Anywhere, see
[Configuring Workload Identity and AWS Roles Anywhere](./aws-roles-anywhere.mdx).

## Prerequisites

(!docs/pages/includes/edition-prereqs-tabs.mdx!)

- (!docs/pages/includes/tctl.mdx!)
- `tbot` must already be installed and configured on the host where the
workloads which need to access Teleport Workload Identity will run. For more
information, see the [deployment guides](../machine-id/deployment.mdx).

### Deciding on a SPIFFE ID structure

Within Teleport Workload Identity, all identities are represented using a
SPIFFE ID. This is a URI that uniquely identifies the entity that the identity
represents. The scheme is always `spiffe://`, and the host will be the name of
your Teleport cluster. The structure of the path of this URI is up to you.

For the purposes of this guide, we will be granting access to GCP to the
`spiffe://example.teleport.sh/svc/example-service` SPIFFE ID.

If you have already deployed Teleport Workload Identity, then you will already
have a SPIFFE ID structure in place. If you have not, then you will need to
decide on a structure for your SPIFFE IDs.

If you are only using Teleport Workload Identity with AWS OIDC Federation, you
may structure your SPIFFE IDs so that they explicitly specify the AWS role they
are allowed to assume. However, it often makes more sense to name the workload
or person that will use the SPIFFE ID. See the
[best practices guide](./best-practices.mdx) for further advice.

## Step 1/4. Configure AWS

Configuring AWS OIDC Federation for the first time involves a few steps. Some of
these may not be necessary if you have previously configured AWS OIDC Federation
for your Teleport cluster.

### Create an OpenID Connect Identity Provider

First, you'll need to create a

When configuring the provider, you need to specify the issuer URI. This will be
the public address of your Teleport Proxy Service with the path
`/workload-identity` appended. Your Teleport Proxy Service must be accessible
by AWS in order for OIDC federation to work.

<Tabs>
<TabItem label="Terraform">

When using the AWS Terraform Provider, you must also determine the thumbprint of
the certificate used by the Teleport Proxy Service.

```hcl
resource "aws_iam_openid_connect_provider" "leaf_tele_ottr_sh_workload_identity" {
    // Replace "example.teleport.sh" with the hostname used to access your
    // Teleport Proxy Service.
    url = "https://example.teleport.sh/workload-identity"

    client_id_list = [
        "sts.amazonaws.com",
    ]

    thumbprint_list = [
        "5f28d9c589ee4bf31a11b78c72b8d13f079ddc45"
    ]
}
```

</TabItem>
<TabItem label="AWS Console">
Use the `aws` CLI to create an OpenID connect identity provider:

```code
# Replace "workload-id-pool" with a meaningful, unique name.
$ aws iam create-open-id-connect-provider \
    --url "https://example.teleport.sh/workload-identity" \
    --client-id-list "sts.amazonaws.com"
```

</TabItem>

</Tabs>

### Create an S3 bucket and RBAC

For the purposes of this guide, we'll be granting the workload access to an
AWS S3 bucket. You can substitute this step to grant access to a different
service within AWS of your choice.

To grant our workload access to the bucket, we'll create a new IAM role for it
to assume, and create an IAM policy that grants the necessary permissions to
bucket.

When creating the IAM role, we'll create a trust policy that controls which
workload identities are able to assume the role. This policy will contain
conditions which will be evaluated against the claims within the JWT SVID
issued by Teleport Workload Identity.

<Tabs>
<TabItem label="Terraform">

```hcl
resource "google_storage_bucket" "demo" {
    // Replace with a meaningful, unique name.
    name          = "example"
    location      = "EU"
    force_destroy = true

    uniform_bucket_level_access = true
}

locals {
    // Replace with the SPIFFE ID of the workload that will access the bucket.
    allow_spiffe_id = "spiffe://example.teleport.sh/svc/example-service"
}

resource "google_storage_bucket_iam_binding" "binding" {
    bucket = google_storage_bucket.demo.name
    role = "roles/storage.admin"
    members = [
        "principal://iam.googleapis.com/projects/${data.google_project.project.number}/locations/global/workloadIdentityPools/${google_iam_workload_identity_pool.leaf_cluster.workload_identity_pool_id}/subject/${local.allow_spiffe_id}",
    ]
}
```

</TabItem>
<TabItem label="AWS Console">

Create a storage bucket using the `gcloud` CLI:

```code
# Replace "example" with a meaningful, unique name.
$ gcloud storage buckets create gs://example \
    --location=EU \
    --uniform-bucket-level-access
```

Use the `gcloud` CLI to grant our workload access to the bucket:

```code
$ ROLE="roles/storage.admin"
# Replace PROJECT_NUMBER with your GCP project number.
$ PROJECT_NUMBER="123456789000"
# Replace POOL_ID with the ID of the Workload Identity Pool you created.
$ POOL_ID="workload-id-pool"
# Replace SPIFFE_ID with the SPIFFE ID of the workload that will access the bucket.
$ SPIFFE_ID="spiffe://example.teleport.sh/svc/example-service"
$ MEMBER="principal://iam.googleapis.com/projects/${PROJECT_NUMBER}/locations/global/workloadIdentityPools/${POOL_ID}/subject/${SPIFFE_ID}"
$ gcloud storage buckets add-iam-policy-binding gs://example --member=$MEMBER --role=$ROLE
```

</TabItem>
</Tabs>

## Step 2/4. Configure Teleport RBAC

Now we need to configure Teleport to allow a JWT to be issued containing the
SPIFFE ID we have chosen.

Create `role.yaml` with the following content:

```yaml
kind: role
version: v6
metadata:
  name: my-workload-gcp
spec:
  allow:
    spiffe:
      - path: /svc/example-service
```

Replace:

- `my-workload-gcp` with a descriptive name for the role.
- `/svc/example-service` with the path part of the SPIFFE ID you have chosen.

Apply this role to your Teleport cluster using `tctl`:

```code
$ tctl create -f role.yaml
```

You now need to assign this role to the bot:

```code
$ tctl bots update my-bot --add-roles my-workload-gcp
```

## Step 3/4. Issue Workload Identity JWTs

You'll now configure `tbot` to issue and renew the short-lived JWT SVIDs for
your workload. It'll write the JWT as a file on disk, where you can then
configure GCP clients and SDKs to read it.

Before configuring this, you'll need to determine the correct audience to
request in the JWT SVIDs. This is specific to the Workload Identity Federation
configuration you have just created and contains three components:

- The project number of your GCP project
- The name of your Workload Identity Federation pool as configured in GCP
- The name of your Workload Identity Federation provider as configured in GCP

It has the following format: `https://iam.googleapis.com/projects/$PROJECT_NUMBER/locations/global/workloadIdentityPools/$POOL_NAME/providers/$PROVIDER_NAME`.

Take your already deployed `tbot` service and configure it to issue SPIFFE SVIDs
by adding the following to the `tbot` configuration file:

```yaml
outputs:
  - type: spiffe-svid
    destination:
      type: directory
      path: /opt/workload-identity
    svid:
      path: /svc/example-service
    jwts:
      - audience: https://iam.googleapis.com/projects/123456789000/locations/global/workloadIdentityPools/workload-id-pool/providers/workload-id-oidc
        file_name: gcp-jwt
```

Replace:

- `123456789000` with your GCP project number.
- `workload-id-pool` with the name of your Workload Identity Federation pool.
- `workload-id-oidc` with the name of your Workload Identity Federation provider.

Restart your `tbot` service to apply the new configuration. You should see a
file created at `/opt/workload-identity/gcp-jwt` containing the JWT.

## Step 4/4. Configure GCP CLIs and SDKs

Finally, you need to create a configuration file to configure the GCP CLIs and
SDKs to authenticate using Workload Identity. This configuration file will
specify the path to the JWT file that `tbot` is writing and will specify which
Workload Identity Federation pool and provider to use.

You can generate this configuration file using the `gcloud` CLI:

```code
$ gcloud iam workload-identity-pools create-cred-config \
    projects/123456789000/locations/global/workloadIdentityPools/workload-id-pool/providers/workload-id-oidc \
    --output-file=gcp-workload-identity.json \
    --credential-source-file=/opt/workload-identity/gcp-jwt \
    --credential-source-type=text
```

Replace:

- `123456789000` with your GCP project number.
- `workload-id-pool` with the name of your Workload Identity Federation pool.
- `workload-id-oidc` with the name of your Workload Identity Federation provider.
- `/opt/workload-identity/gcp-jwt` with the path to the JWT file that `tbot` is
  writing.

The command should have created a file called `gcp-workload-identity.json` in
the current directory.

### `gcloud` CLI

To configure the `gcloud` CLI to authenticate using Workload Identity, you use
the `gcloud auth login` command and specify the path to the configuration file
that you have just created:

```code
$ gcloud auth login --cred-file gcp-workload-identity.json
```

You can now test authenticating to the GCP Storage API. Create a file which
you can upload to your bucket:

```code
$ echo "Hello, World!" > hello.txt
```

Now, use the `gcloud` CLI to upload this file to your bucket:

```code
$ gcloud storage cp hello.txt gs://example
```

If everything is configured correctly, you should see this file uploaded to your
bucket. Inspecting the audit logs on GCP should indicate that the request was
authenticated using Workload Identity and specify the SPIFFE ID of the workload
that made the request.

### GCP SDKs

To configure the GCP SDKs to authenticate using Workload Identity, you need to
set the `GOOGLE_APPLICATION_CREDENTIALS` environment variable to the path of the
configuration file that you have just created:

```code
$ export GOOGLE_APPLICATION_CREDENTIALS=gcp-workload-identity.json
```

## Next steps

- [AWS OIC Federation](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_providers_oidc.html):
The official AWS documentation for OIDC federation.
- [Workload Identity Overview](./introduction.mdx): Overview of Teleport
Workload Identity.
- [JWT SVID Overview](./jwt-svids.mdx): Overview of the JWT SVIDs issued by
Teleport Workload Identity.
- [Best Practices](./best-practices.mdx): Best practices for using Workload
Identity in Production.
- Read the [configuration reference](../../reference/machine-id/configuration.mdx) to explore
all the available configuration options.
