---
title: Configuring Workload Identity and AWS OIDC Federation with JWTs
description: Configuring AWS to accept Workload Identity JWTs as authentication using OIDC Federation
---

<Admonition type="tip" title="Preview">
Teleport Workload Identity is currently in Preview. This means that some
features may be missing. We're actively looking for design partners to help us
shape the future of Workload Identity and would love to
[hear your feedback](mailto:product@goteleport.com).
</Admonition>

Teleport Workload Identity issues flexible short-lived identities in JWT format.
AWS OIDC Federation allows you to use these JWTs to authenticate to AWS
services.

This can be useful in cases where a machine needs to securely authenticate with
AWS services without the use of a long-lived credential. This is because the
machine can authenticate with Teleport without using any shared secrets by
using one of our delegated join methods.

In this guide, we'll configure Teleport Workload Identity and AWS to allow our
workload to authenticate to the AWS S3 API and upload content to a bucket.

## How it works

This implementation differs from using the Teleport Application Service to protect
AWS APIs in a few ways:

- Requests to AWS are not proxied through the Teleport Proxy Service, meaning
  reduced latency but also less visibility, as these requests will not be
  recorded in Teleport's audit log.
- Workload Identity works with any AWS client, including the command-line tool
  but also their SDKs.
- Using the Teleport Application Service to access AWS does not work with Machine
  ID and therefore cannot be used when a machine needs to authenticate with AWS.

## OIDC Federation vs Roles Anywhere

The AWS platform offers two routes for workload identity federation: OIDC
Federation and Roles Anywhere. Teleport Workload Identity supports both of these
methods.

There are a number of differences between the two methods:

- OIDC Federation exchanges a JWT SVID for an AWS credential, whereas Roles
  Anywhere exchanges an X509 SVID for an AWS credential. The use of X509 SVIDs
  is generally considered more secure.
- OIDC Federation does not require the additional installation of an AWS
  credential helper alongside workloads, whereas Roles Anywhere does.
- OIDC Federation requires that your Teleport Proxy Service is reachable by
  AWS, whereas Roles Anywhere does not.

This guide covers configuring OIDC federation, for Roles Anywhere, see
[Configuring Workload Identity and AWS Roles Anywhere](./aws-roles-anywhere.mdx).

## Prerequisites

(!docs/pages/includes/edition-prereqs-tabs.mdx!)

- (!docs/pages/includes/tctl.mdx!)
- `tbot` must already be installed and configured on the host where the
workloads which need to access Teleport Workload Identity will run. For more
information, see the [deployment guides](../machine-id/deployment.mdx).

<Notice type="warning">
Issuing JWT SVIDs with Teleport Workload Identity requires at minimum version
16.4.3.
</Notice>

### Deciding on a SPIFFE ID structure

Within Teleport Workload Identity, all identities are represented using a
SPIFFE ID. This is a URI that uniquely identifies the entity that the identity
represents. The scheme is always `spiffe://`, and the host will be the name of
your Teleport cluster. The structure of the path of this URI is up to you.

For the purposes of this guide, we will be granting access to GCP to the
`spiffe://example.teleport.sh/svc/example-service` SPIFFE ID.

If you have already deployed Teleport Workload Identity, then you will already
have a SPIFFE ID structure in place. If you have not, then you will need to
decide on a structure for your SPIFFE IDs.

If you are only using Teleport Workload Identity with AWS OIDC Federation, you
may structure your SPIFFE IDs so that they explicitly specify the AWS role they
are allowed to assume. However, it often makes more sense to name the workload
or person that will use the SPIFFE ID. See the
[best practices guide](./best-practices.mdx) for further advice.

## Step 1/4. Configure AWS

Configuring AWS OIDC Federation for the first time involves a few steps. Some of
these may not be necessary if you have previously configured AWS OIDC Federation
for your Teleport cluster.

### Create an OpenID Connect Identity Provider

First, you'll need to create an OIDC identity provider in AWS. This will define
a trust relationship between AWS and your Teleport cluster's Workload Identity
issuer. You can reuse this OIDC identity provider to grant different workloads
using Teleport Workload Identity access to AWS services.

When configuring the provider, you need to specify the issuer URI. This will be
the public address of your Teleport Proxy Service with the path
`/workload-identity` appended. Your Teleport Proxy Service must be accessible
by AWS in order for OIDC federation to work.

<Tabs>
<TabItem label="Terraform">

Before you can configure the OIDC identity provider, you need to determine the
thumbprint of the TLS certificate used by your Teleport Proxy Service. You can
do this using `curl`:

```code
$ curl https://example.teleport.sh/webapi/thumbprint
"example589ee4bf31a11b78c72b8d13f0example"%
```

```hcl
resource "aws_iam_openid_connect_provider" "leaf_tele_ottr_sh_workload_identity" {
  // Replace "example.teleport.sh" with the hostname used to access your
  // Teleport Proxy Service.
  url = "https://example.teleport.sh/workload-identity"

  client_id_list = [
    "sts.amazonaws.com",
  ]

  thumbprint_list = [
    // Replace with the thumbprint you determined using curl.
    "example589ee4bf31a11b78c72b8d13f0example"
  ]
}
```

</TabItem>
<TabItem label="AWS Console">

1. Browse to IAM
2. Select "Identity Providers" from the sidebar
3. Select "Add provider"
4. Select "OpenID Connect" as the "Provider type".
5. Specify the public hostname of your Teleport Proxy Service, with
  "/workload-identity" appended as the "Provider URL", e.g
  `https://example.teleport.sh/workload-identity`
6. Specify `sts.amazonaws.com` as the Audience
7. Click "Add Provider".

</TabItem>
</Tabs>

### Create an S3 bucket

For the purposes of this guide, you'll be granting the workload access to an
AWS S3 bucket. Before we can dive into configuring the RBAC, we'll need to
create our bucket.

You can omit this step if you wish to grant access to a different service
within AWS.

<Tabs>
<TabItem label="Terraform">
```hcl
// Create an S3 bucket
resource "aws_s3_bucket" "example" {
  // Replace "example" with a meaningful, unique name.
  bucket = "workload-id-demo"
}
```
</TabItem>
<TabItem label="AWS Console">

1. Browse to S3
2. Select "Create bucket"
3. Enter a meaningful, unique name for your bucket, e.g `workload-id-demo`
4. Leave other settings as default
5. Click "Create bucket".

</TabItem>
</Tabs>

### Configuring RBAC

First, you'll create an IAM role. This role will be assumed by the workload
after it authenticates to AWS using the JWT SVID issued by Teleport Workload
Identity.

When creating the IAM role, you'll define a trust policy that controls which
workload identities are able to assume the role. This policy will contain
conditions which will be evaluated against the claims within the JWT SVID
issued by Teleport Workload Identity. In our case, the only claim we want to 
evaluate is the `sub` claim, which will contain our workload's SPIFFE ID.

With the IAM role created, you will then attach an IAM policy to it to define
what privileges the workload will have when it assumes the role.

<Tabs>
<TabItem label="Terraform">

```hcl
// Create a role that the workload identity will assume.
resource "aws_iam_role" "example" {
  // Choose a unique, meaningful name that describes the role and the workload
  // that will assume it.
  name = "workload-id-demo"
  assume_role_policy = jsonencode({
    Version = "2012-10-17"
    Statement = [{
      Effect = "Allow"
      Principal = {
        Federated = aws_iam_openid_connect_provider.example.arn
      }
      Action = "sts:AssumeRoleWithWebIdentity"
      Condition = {
        StringEquals = {
          "${aws_iam_openid_connect_provider.example.url}:aud" = "sts.amazonaws.com"
          "${aws_iam_openid_connect_provider.example.url}:sub" = "spiffe://example.teleport.sh/svc/example-service"
        }
      }
    }]
  })
}

resource "aws_iam_policy" "example" {
  // Choose a unique, meaningful name that describes what the policy grants
  // access to.
  name        = "workload-id-s3-full-access"
  path        = "/"

  // This example policy grants full access to AWS S3. In production, you
  // may wish to grant a less permissive policy.
  policy = jsonencode({
    Version = "2012-10-17"
    Statement = [{
      Action = "s3:*"
      Effect = "Allow"
      Resource = [
        aws_s3_bucket.workload_id_demo.arn,
        "${aws_s3_bucket.workload_id_demo.arn}/*"
      ]
    }]
  })
}

// Attach the policy to the role
resource "aws_iam_role_policy_attachment" "example" {
    role       = aws_iam_role.example.name
    policy_arn = aws_iam_policy.example.arn
}
```

</TabItem>
<TabItem label="AWS Console">

### Creating an IAM Policy

1. Browse to IAM
2. Select "Policies" from the sidebar
3. Click "Create policy"
4. Choose the "S3" service
5. Under "Actions allowed", choose "All S3 actions"
6. Under "Resources", choose "Specific"
  6a. For "bucket" enter the name of the bucket you created earlier.
  6b. For "object" enter the name of the bucket you created earlier and select
    "All objects"
7. Click "Next"
8. Enter a unique and meaningful name for this policy, in our example, this will
  be `workload-id-s3-full-access`
9. Click "Create policy"

### Creating an IAM Role

1. Browse to IAM
2. Select "Roles" from the sidebar
3. Click "Create role"
4. Select "Web identity" for the "Trusted entity type"
5. Select your identity provider
6. Select the `sts.amazonaws.com` audience
7. Click "Add condition"
  7a. Select `example.teleport.sh:sub` for the key
  7b. Select "StringEquals" for the condition
  7c. Enter the SPIFFE ID of your workload for the value. In our example, this 
    will be `spiffe://example.teleport.sh/svc/example
8. Click "Next"
9. Select the IAM policy you created earlier, and click "Next"
10. Enter a unique and meaningful name for this role, in our example, this will
  be `workload-id-demo`
11. Click "Create role"

</TabItem>
</Tabs>

## Step 2/4. Configure Teleport RBAC

Now we need to configure Teleport to allow a JWT to be issued containing the
SPIFFE ID we have chosen.

Create `role.yaml` with the following content:

```yaml
kind: role
version: v6
metadata:
  name: my-workload-aws
spec:
  allow:
    spiffe:
      - path: /svc/example-service
```

Replace:

- `my-workload-aws` with a descriptive name for the role.
- `/svc/example-service` with the path part of the SPIFFE ID you have chosen.

Apply this role to your Teleport cluster using `tctl`:

```code
$ tctl create -f role.yaml
```

You now need to assign this role to the bot:

```code
$ tctl bots update my-bot --add-roles my-workload-aws
```

## Step 3/4. Issue Workload Identity JWTs

You'll now configure `tbot` to issue and renew the short-lived JWT SVIDs for
your workload. It'll write the JWT as a file on disk, where you can then
configure AWS clients and SDKs to read it.

Take your already deployed `tbot` service and configure it to issue SPIFFE SVIDs
by adding the following to the `tbot` configuration file:

```yaml
outputs:
  - type: spiffe-svid
    destination:
      type: directory
      path: /opt/workload-identity
    svid:
      path: /svc/example-service
    jwts:
      - audience: sts.amazonaws.com
        file_name: aws-jwt
```

Replace:

-

Restart your `tbot` service to apply the new configuration. You should see a
file created at `/opt/workload-identity/aws-jwt` containing the JWT.

## Step 4/4. Configure AWS CLIs and SDKs

Finally, you need to create a configuration file to configure the GCP CLIs and
SDKs to authenticate using Workload Identity. This configuration file will
specify the path to the JWT file that `tbot` is writing and will specify which
Workload Identity Federation pool and provider to use.

You can generate this configuration file using the `gcloud` CLI:

```code
$ gcloud iam workload-identity-pools create-cred-config \
    projects/123456789000/locations/global/workloadIdentityPools/workload-id-pool/providers/workload-id-oidc \
    --output-file=gcp-workload-identity.json \
    --credential-source-file=/opt/workload-identity/gcp-jwt \
    --credential-source-type=text
```

Replace:

- `123456789000` with your GCP project number.
- `workload-id-pool` with the name of your Workload Identity Federation pool.
- `workload-id-oidc` with the name of your Workload Identity Federation provider.
- `/opt/workload-identity/gcp-jwt` with the path to the JWT file that `tbot` is
  writing.

The command should have created a file called `gcp-workload-identity.json` in
the current directory.

### `gcloud` CLI

To configure the `gcloud` CLI to authenticate using Workload Identity, you use
the `gcloud auth login` command and specify the path to the configuration file
that you have just created:

```code
$ gcloud auth login --cred-file gcp-workload-identity.json
```

You can now test authenticating to the GCP Storage API. Create a file which
you can upload to your bucket:

```code
$ echo "Hello, World!" > hello.txt
```

Now, use the `gcloud` CLI to upload this file to your bucket:

```code
$ gcloud storage cp hello.txt gs://example
```

If everything is configured correctly, you should see this file uploaded to your
bucket. Inspecting the audit logs on GCP should indicate that the request was
authenticated using Workload Identity and specify the SPIFFE ID of the workload
that made the request.

### GCP SDKs

To configure the GCP SDKs to authenticate using Workload Identity, you need to
set the `GOOGLE_APPLICATION_CREDENTIALS` environment variable to the path of the
configuration file that you have just created:

```code
$ export GOOGLE_APPLICATION_CREDENTIALS=gcp-workload-identity.json
```

## Next steps

- [AWS OIC Federation](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_providers_oidc.html):
The official AWS documentation for OIDC federation.
- [Workload Identity Overview](./introduction.mdx): Overview of Teleport
Workload Identity.
- [JWT SVID Overview](./jwt-svids.mdx): Overview of the JWT SVIDs issued by
Teleport Workload Identity.
- [Best Practices](./best-practices.mdx): Best practices for using Workload
Identity in Production.
- Read the [configuration reference](../../reference/machine-id/configuration.mdx) to explore
all the available configuration options.
