---
title: Deploying tbot on Kubernetes
description: How to install and configure Machine ID on Kubernetes with Static JWKS Keys
tags:
 - how-to
 - mwi
 - infrastructure-identity
---

This guide shows you how to deploy the Machine ID daemon `tbot`, on a Kubernetes
cluster using a static set of JWKS keys.

## How it works

In the setup we demonstrate in this guide, `tbot` runs as a Kubernetes
deployment. It writes output credentials to a Kubernetes secret, which can then
be mounted in the pods that need to use the credentials. While `tbot` can also
run as a sidecar within the same pod as the service that needs to use the
credentials it generates, we recommend running `tbot` as a standalone deployment
due the limited support Kubernetes has for sidecars.

In this guide, we demonstrate the `kubernetes` join method, in which `tbot`
proves its identity to the Teleport Auth Service by presenting a JSON web token
(JWT) signed by the Kubernetes API server. This JWT contains identifies the
service account, the pod and the namespace in which `tbot` is running. The
Teleport Auth Service checks the signature of the JWT against the Kubernetes
cluster's public signing key.

<Admonition type="warning" title="OIDC Joining">
Certain cloud providers like Amazon EKS regularly rotate their OIDC signing
keys, which will cause the `static_jwks` configuration you create in this guide
to become invalid after a short period of time.

On Kubernetes providers with OIDC support, like Amazon's Elastic Kubernetes
Service (EKS), Google Kubernetes Engine (GKE), and Azure Kubernetes Service
(AKS), consider using [Kubernetes OIDC joining](./kubernetes-oidc.mdx) instead.
</Admonition>

<details>
<summary>Using another join method</summary>

When deploying `tbot` to a Teleport cluster, it is generally recommended to use
the `kubernetes` join method. This will work with most Kubernetes clusters.
The guide that follows will demonstrate configuring this join method.

However, when using certain cloud Kubernetes services, it is possible to use the
join method associated with that platform rather than the `kubernetes` join
method. This may be beneficial if you wish to manage the joining of `tbot`
within the Kubernetes clusters and on standard VMs on the same platform with
a single join token. These services are:

- Google Kubernetes Engine: Where
  [GCP Workload Identity](https://cloud.google.com/kubernetes-engine/docs/how-to/workload-identity)
  is configured for the cluster, it is possible to use the `gcp` join method.
  See the [GCP Platform Guide](./gcp.mdx) for further information.
- Amazon Elastic Kubernetes Service: Where
  [IAM Roles for Service Accounts (IRSA)](https://docs.aws.amazon.com/eks/latest/userguide/iam-roles-for-service-accounts.html)
  is configured for the cluster, it is possible to use the `iam` join method.
  See the [AWS Platform Guide](./aws.mdx) for further information.

</details>

## Prerequisites

(!docs/pages/includes/edition-prereqs-tabs.mdx!)

- (!docs/pages/includes/tctl.mdx!)
- A Kubernetes cluster with support for Token Request Projection (which
  graduated to a generally available feature in Kubernetes 1.20).
- `kubectl` authenticated with the ability to create resources in the cluster
  you wish to deploy `tbot` into.
- The `helm` CLI tool installed.

The examples in this guide will install a `tbot` deployment in the `default`
Namespace of the Kubernetes cluster. Adjust references to `default` to the
Namespace you wish to use.

## Step 1/4. Create a Bot

(!docs/pages/includes/machine-id/create-a-bot.mdx!)

## Step 2/4. Create a join token

Next, a join token needs to be configured. This will be used by `tbot` to join
the cluster. As the `kubernetes` join method will be used, the public key of the
Kubernetes cluster must first be determined. The public key used to sign JWTs
is exposed on the "JWKS" endpoint of the Kubernetes API server. This public key
can then be used by the Teleport Auth  to verify that the Service Account JWT
presented by `tbot` is signed legitimately by the Kubernetes cluster.

Run the following commands to determine the JWKS formatted public key:

```code
$ kubectl proxy -p 8080
$ curl http://localhost:8080/openid/v1/jwks
{"keys":[--snip--]}%
```

Create `bot-token.yaml`, ensuring you insert the value from the JWKS endpoint
in `spec.kubernetes.static_jwks.jwks`:

```yaml
kind: token
version: v2
metadata:
  # name will be specified in the `tbot` to use this token
  name: example-bot
spec:
  roles: [Bot]
  # bot_name should match the name of the bot created earlier in this guide.
  bot_name: example
  join_method: kubernetes
  kubernetes:
    # static_jwks configures the Auth Service to validate the JWT presented by
    # `tbot` using the public key from a statically configured JWKS.
    type: static_jwks
    static_jwks:
      jwks: |
        # Place the data returned by the curl command here
        {"keys":[--snip--]}
    # allow specifies the rules by which the Auth Service determines if `tbot`
    # should be allowed to join.
    allow:
    - service_account: "default:tbot" # service_account
```

Use `tctl` to apply this file:

```code
$ tctl create -f bot-token.yaml
```

## Step 3/4. Create a `tbot` deployment

Now, you'll deploy `tbot` to your Kubernetes cluster using the Teleport `tbot`
Helm chart. This will be configured using values provided to the Helm CLI tool.

First, create a file called `tbot-values.yaml` to hold the configuration values
for the Helm chart:

```yaml
# Replace the cluster name with the name of your Teleport cluster.
# This is not necessarily the public address of your Teleport Proxy Service.
clusterName: "example.teleport.sh"
# Replace this with the address of your Teleport Proxy Service.
teleportProxyAddress: "example.teleport.sh:443"
# Ensure this matches the name of the join token you created earlier.
token: "example-bot"
```

<Admonition type="warning" title="FIPS Compliance">
The default `tbot-distroless` image does not contain the FIPS-compliant
binaries. If you operate in an environment where FIPS compliance is required,
additionally set the `image: public.ecr.aws/gravitational/tbot-fips-distroless`.
</Admonition>

Before you can deploy the Helm chart, if you have not previously deployed a
Teleport Helm chart, you'll need to add the Teleport chart repository to your
CLI:

```code
$ helm repo add teleport (=teleport.helm_repo_url=)
$ helm repo update
```

You can now deploy the `tbot` Helm chart using the configuration you created
earlier, ensuring you specify the namespace you wish to deploy `tbot` into:

```code
$ helm install tbot teleport/tbot \
  --namespace default \
  --values tbot-values.yaml
```

Use `kubectl` to verify that the deployment is healthy:

```code
$ kubectl describe deployment/tbot
$ kubectl logs deployment/tbot
```

With this complete, `tbot` is now successfully deployed to your cluster.

## Step 4/4. Using the output

By default, the `tbot` Helm chart is configured to write an identity file to a
Kubernetes Secret called `tbot-out` in the namespace where `tbot` has been
deployed.

This identity file can be mounted into other pods and used with `tsh` or `tctl`
to access and configure your Teleport cluster. For example:

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: tsh
  namespace: default
spec:
  containers:
    - name: tsh
      image: public.ecr.aws/gravitational/teleport-distroless:(=teleport.version=)
      command:
        - tsh
      args:
       - -i
       - /identity-output/identity
       - --proxy
       - example.teleport.sh:443
       - ls
      volumeMounts:
        - name: identity-output
          mountPath: /identity-output
  volumes:
    - name: identity-output
      secret:
        secretName: tbot-out
```

If you wish to use `tbot` for a different kind of access, you can override the
type of output using the `services` value of the Helm chart and setting
`defaultOutput.enabled` to `false`.

Follow one of the [access guides](../access-guides/access-guides.mdx) to find
out more about how to configure `tbot` for your use case.

## Next steps

- Explore the [Helm chart configuration reference](../../../reference/helm-reference/tbot.mdx).
- Follow the [access guides](../access-guides/access-guides.mdx) to finish
  configuring `tbot` for your environment.
- Read the [configuration reference](../../../reference/machine-workload-identity/machine-id/configuration.mdx) to explore
  all the available configuration options.
- [More information about `TELEPORT_ANONYMOUS_TELEMETRY`.](../../../reference/machine-workload-identity/machine-id/telemetry.mdx)
