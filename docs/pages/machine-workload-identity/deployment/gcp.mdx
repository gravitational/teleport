---
title: Deploying tbot on GCP
description: How to install and configure the Machine & Workload Identity agent, `tbot`, on a GCP VM
sidebar_label: GCP VM
tags:
 - how-to
 - mwi
 - infrastructure-identity
 - google-cloud
---

This guide explains how to deploy the Machine & Workload Identity agent, `tbot`,
on a Google Cloud Platform GCE instance and connect it to your Teleport cluster.

<Admonition type="note">
The steps in this guide provide an example configuration to help you get started. 
Your environment or use case may require additional or different settings. 
Adjust the configuration to fit your specific requirements.
</Admonition>


## How it works

On GCP, virtual machines can be assigned a service account. These machines can
then request a signed JSON web token from GCP, which allows third parties to
verify information about them, including their service accounts, using the GCP
public key. The Teleport `gcp` join method instructs `tbot` to use this service
account JWT to prove its identity to the Teleport Auth Service and join your
Teleport cluster without using long-lived secrets.

Whilst the guide on this page focuses explicitly on deploying `tbot` on a GCP
Virtual Machine, it is also possible to use the `gcp` join method with workloads
running on Google Kubernetes Engine. To do so, you must configure
[GCP Workload
Identity](https://cloud.google.com/kubernetes-engine/docs/how-to/workload-identity)
for the cluster and the Kubernetes service account that will be used by the
`tbot` pod. See the [Kubernetes platform guide](kubernetes.mdx) for further
guidance on deploying `tbot` as a workload on Kubernetes.

## Prerequisites

(!docs/pages/includes/edition-prereqs-tabs.mdx!)

- (!docs/pages/includes/tctl.mdx!)
- A GCP service account you wish to grant access to your Teleport cluster that
  is not the GCP compute default service account.
- A GCP Compute Engine VM that you wish to install `tbot` onto that has been
  configured with the GCP service account.

## Step 1/5. Install `tbot`

**This step is completed on the GCP VM.**

First, `tbot` needs to be installed on the VM that you wish to use Machine &
Workload Identity on.

Download and install the appropriate Teleport package for your platform:

(!docs/pages/includes/install-linux.mdx!)

## Step 2/5. Create a Bot

**This step is completed on your local machine.**

(!docs/pages/includes/machine-id/create-a-bot.mdx!)

## Step 3/5. Create a join token

**This step is completed on your local machine.**

Create `bot-token.yaml`:

```yaml
kind: token
version: v2
metadata:
  # name will be specified in the `tbot` to use this token
  name: example-bot
spec:
  roles: [Bot]
  # bot_name should match the name of the bot created earlier in this guide.
  bot_name: example
  join_method: gcp
  gcp:
    # allow specifies the rules by which the Auth Service determines if `tbot`
    # should be allowed to join.
    allow:
    - project_ids:
        - my-project-123456
      service_accounts:
        # This should be the full "name" of a GCP service account. The default
        # compute service account is not supported.
        - my-service-account@my-project-123456.iam.gserviceaccount.com
```

Replace:

- `my-project-123456` with the ID of your GCP project
- `example` with the name of the bot you created in the second step.
- `my-service-account@my-project-123456.iam.gserviceaccount.com` with the email
  of the service account configured in the previous step. The default compute
  service account is not supported.

Use `tctl` to apply this file:

```code
$ tctl create -f bot-token.yaml
```

## Step 4/5. Configure `tbot`

**This step is completed on the GCP VM.**

Next, you'll create a file to configure `tbot`. In this example, we'll be
configuring `tbot` to use the `identity` service. This will generate a set of
short-lived certificates which can be used by `tsh` or `tctl` to authenticate to
your Teleport cluster as the bot.

Create `/etc/tbot.yaml`:

```yaml
version: v2
proxy_server: example.teleport.sh:443
onboarding:
  join_method: gcp
  token: example-bot
storage:
  type: memory
# services will be filled in during the completion of an access guide.
services:
- type: identity
  destination:
    type: directory
    path: /opt/machine-id
```

Replace:

- `example.teleport.sh:443` with the address of your Teleport Proxy or
  Auth Service. Prefer using the address of a Teleport Proxy.
- `example-bot` with the name of the token you created in the second step.
- `/opt/machine-id` with a path to a directory where `tbot` should write the
  short-lived credentials. Ensure that the user `tbot` is running and has the
  appropriate permissions to create this directory.

(!docs/pages/includes/machine-id/daemon-or-oneshot.mdx!)

## Step 5/5. Testing your `tbot` configuration

`tbot` will now be producing a set of short-lived credentials within
`/opt/machine-id`. To verify that is working correctly, we'll now test these
credentials using `tsh`.

On the host where you have deployed `tbot`, run the following, replacing
`--proxy` with the address of your Teleport Proxy Service and `-i` with the
path to the `identity` file within your configured directory:

```code
$ tsh --proxy example.teleport.sh:443 -i /opt/machine-id/identity status                                                                                                                                                                                                                                         127 â†µ
> Profile URL:        https://example.teleport.sh:443
Logged in as:       bot-example
Cluster:            example.teleport.sh
Roles:              access
Logins:             support, ubuntu
Kubernetes:         disabled
Valid until:        2025-11-12 14:08:34 +0000 GMT [valid for 58m]
Extensions:         bot-instance-id@goteleport.com, bot-name@goteleport.com, disallow-reissue, impersonator, login-ip, permit-agent-forwarding, permit-port-forwarding, permit-pty, private-key-policy
```

You have now prepared a basic deployment of `tbot` for your platform, and
verified that it can produce a simple output that can be used with `tsh` and
`tctl`. For guidance on how to configure `tbot` for your use case, follow one
of the [access guides](../../machine-workload-identity/access-guides/access-guides.mdx)
and replace the example `identity` service you configured in this guide.

## Next steps

- Follow the [access guides](../access-guides/access-guides.mdx) to finish configuring `tbot` for
  your environment.
- Read the [configuration reference](../../reference/machine-workload-identity/configuration.mdx) to explore
  all the available configuration options.
- [More information about `TELEPORT_ANONYMOUS_TELEMETRY`.](../../reference/machine-workload-identity/telemetry.mdx)
