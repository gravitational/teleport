---
title: Deploying tbot on Azure
description: How to install and configure the Machine & Workload Identity agent, `tbot`, on an Azure VM
sidebar_label: Azure VM
tags:
 - how-to
 - mwi
 - infrastructure-identity
 - azure
---

In this guide, you will install Machine & Workload Identity's agent, `tbot`, on
an Azure VM. The bot will be configured to use the `azure` delegated joining
method to authenticate to your Teleport cluster. This eliminates the need for
long-lived secrets.

## How it works

On the Azure platform, virtual machines can be assigned a managed identity. The
Azure platform will then make available to the virtual machine an attested
data document and JWT that allows the virtual machine to act as this identity.
This identity can be validated by a third party by attempting to use this token
to fetch its own identity from the Azure identity service.

The `azure` join method instructs the bot to use this attested data document and
JWT to prove its identity to the Teleport Auth Service. This allows joining to
occur without the use of a long-lived secret.

## Prerequisites

(!docs/pages/includes/edition-prereqs-tabs.mdx!)

- (!docs/pages/includes/tctl.mdx!)
- An Azure managed identity with a role granting the
  `Microsoft.Compute/virtualMachines/read` permission. You will need to know
  the UID of this identity.
- An Azure VM you wish to install Machine & Workload Identity onto with the
  managed identity configured as a user-assigned managed identity.

## Step 1/6. Install `tbot`

**This step is completed on the Azure VM.**

First, `tbot` needs to be installed on the VM that you wish to use Machine &
Workload Identity on.

Download and install the appropriate Teleport package for your platform:

(!docs/pages/includes/install-linux.mdx!)

## Step 2/6. Create a Bot

**This step is completed on your local machine.**

(!docs/pages/includes/machine-id/create-a-bot.mdx!)

## Step 3/6. Create a join token

**This step is completed on your local machine.**

Create `bot-token.yaml`:

```yaml
kind: token
version: v2
metadata:
  # name will be specified in the `tbot` to use this token
  name: example-bot
spec:
  roles: [Bot]
  # bot_name should match the name of the bot created earlier in this guide.
  bot_name: example
  join_method: azure
  azure:
    allow:
      # subscription should be the UID of an Azure subscription. Only VMs within
      # this subscription will be able to join.
    - subscription: 11111111-1111-1111-1111-111111111111
      # resource_groups allows joining to be restricted to VMs in a specific
      # resource group. It can be omitted to allow joining from any VM within
      # a subscription.
      resource_groups: ["group1"]
```

Replace:

- `11111111-1111-1111-1111-111111111111` with the UID of your Azure subscription
- `example` with the name of the bot you created in the second step
- `group1` with the name of the resource group that the VM resides within or
  omit this entirely to allow joining from any VM within the subscription

Use `tctl` to apply this file:

```code
$ tctl create -f bot-token.yaml
```

## Step 4/6. Configure `tbot`

**This step is completed on the Azure VM.**

Create `/etc/tbot.yaml`:

```yaml
version: v2
proxy_server: example.teleport.sh:443
onboarding:
  join_method: azure
  token: example-bot
  azure :
    client_id: 22222222-2222-2222-2222-222222222222
storage:
  type: memory
# services will be filled in during the completion of an access guide.
services: []
```

Replace:

- `example.teleport.sh:443` with the address of your Teleport Proxy or
  Auth Service. Prefer using the address of a Teleport Proxy.
- `22222222-2222-2222-2222-222222222222` with the ID of the Azure managed
  identity that has been assigned to the VM.
- `example-bot` with the name of the token you created in the second step.

(!docs/pages/includes/machine-id/daemon-or-oneshot.mdx!)

## Step 5/6. Configure services

(!docs/pages/includes/machine-id/configure-services.mdx!)

## Step 6/6. Verify that tbot is running correctly

nce the configuration file and services are in place, verify that your tbot
instance successfully joined the cluster and is issuing credentials.

Run the following command on the Azure VM:

```code
$ tsh --proxy example.teleport.sh:443 -i /opt/machine-id/identity status
```

If tbot is running correctly, you’ll see output similar to:

```code
> Profile URL:        https://example.teleport.sh:443
  Logged in as:       bot-example
  Cluster:            example.teleport.sh
  Roles:              access, auditor, read
  Logins:             root, ubuntu, ec2-user, device-admin, device-enroll, editor
  Kubernetes:         disabled
  Valid until:        2025-11-20 22:02:39 -0800 PST [valid for 12h0m0s]
  Extensions:         bot-instance-id@goteleport.com, bot-name@goteleport.com, disallow-reissue, impersonator, login-ip, permit-agent-forwarding, permit-port-forwarding, permit-pty, private-key-policy
```

To further confirm that credentials are valid, list the generated identity files:

```code
$ ls /var/lib/tbot/destinations/default
```

You should see key and certificate files (`key`, `cert`, and `ca.pem`) that
your workloads can use to authenticate through Teleport.

If you’re using Workload Identity or SPIFFE, you can also run `spiffe-inspect` and see similar output:

```code
$ tbot spiffe-inspect --path=PATH

INFO [TBOT] Inspecting SPIFFE Workload API Endpoint unix:///opt/machine-id/workload.sock
INFO [TBOT] Received X.509 SVID context from Workload API bundles_count:1 svids_count:1
SVIDS
- spiffe://example.teleport.sh/svc/foo
  - Expiry: 2025-11-20 18:05:10 -0800 PST
Trust Bundles
- example.teleport.sh
```

This confirms that your bot successfully authenticated using Azure managed
identity and can issue short-lived credentials for your workloads.

## Next steps

- Follow the [access guides](../access-guides/access-guides.mdx) to finish configuring `tbot` for
  your environment.
- Read the [configuration reference](../../reference/machine-workload-identity/configuration.mdx) to explore
  all the available configuration options.
- [More information about `TELEPORT_ANONYMOUS_TELEMETRY`.](../../reference/machine-workload-identity/telemetry.mdx)
