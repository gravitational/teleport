---
title: Deploying Machine ID on GCP
description: How to install and configure Machine ID on a GCP VM
---

This page contains relevant background information and specific steps for
deploying Machine ID on Google Cloud Platform.

## Background

### The `gcp` join method

The process of `tbot` initially authenticating with the Teleport cluster is
known as joining. A join method is a specific technique for the bot to prove
its identity.

On the GCP platform, virtual machines can be assigned a service account. The
GCP platform will then make available to the virtual machine a signed JWT that
references this service account. This signed JWT can be validated by a third
party using GCP's public key.

The `gcp` join method instructs the bot to use this service account JWT to
prove its identity to the Teleport Auth Server. This allows joining to be
restricted to VMs that have access to a specific GCP service account and
avoids the use of long-lived secrets.

### Google Kubernetes Engine

Whilst the guide on this page focuses explicitly on deploying Machine ID on a
GCP Virtual Machine, it is also possible to use the `gcp` join method with
workloads (e.g Pods) running on a GKE Kubernetes cluster.

It is a requirement that
[GCP Workload Identity](https://cloud.google.com/kubernetes-engine/docs/how-to/workload-identity)
has been configured for the cluster and the Kubernetes service account that will
be used by the `tbot` pod.

See the [Kubernetes platform guide](kubernetes.mdx) for further guidance
on deploying Machine ID as a workload on Kubernetes.

## Guide

In this guide, you will install Machine ID's agent, `tbot`, on a GCP GCE
instance. The bot will be configured to use the `gcp` delegated joining method
to eliminate the need for long-lived secrets.

### Prerequisites

(!docs/pages/includes/edition-prereqs-tabs.mdx!)

- (!docs/pages/includes/tctl.mdx!)
- A GCP service account you wish to grant access to your Teleport cluster that
  is not the GCP compute default service account.
- A GCP Compute Engine VM that you wish to install Machine ID onto that has
  been configured with the GCP service account.

### Step 1/4. Install `tbot`

**This step is completed on the GCP VM.**

First, `tbot` needs to be installed on the VM that you wish to use Machine ID
on.

Download and install the appropriate Teleport package for your platform:

(!docs/pages/includes/install-linux.mdx!)

### Step 2/4. Create a join token, role and bot user

**This step is completed on your local machine.**

(!docs/pages/includes/machine-id/blank-role.mdx!)

Create `bot-token.yaml`:

```yaml
kind: token
version: v2
metadata:
  # name will be specified in the `tbot` to use this token
  name: example-bot
spec:
  roles: [Bot]
  # bot_name will match the name of the bot created later in this guide.
  bot_name: example
  join_method: gcp
  gcp:
    # allow specifies the rules by which the Auth Server determines if `tbot`
    # should be allowed to join.
    allow:
    - project_ids:
        - my-project-123456
      service_accounts:
        # This should be the full "name" of a GCP service account. The default
        # compute service account is not supported.
        - my-service-account@my-project-123456.iam.gserviceaccount.com
```

Replace:

- `my-project-123456` with the ID of your GCP project
- `my-service-account@my-project-123456.iam.gserviceaccount.com` with the email
  of the service account configured in the previous step. The default compute
  service account is not supported.

Use `tctl` to apply this file:

```code
$ tctl create -f bot-token.yaml
```

Create the bot, specifying the token and role that you have created:

```code
$ tctl bots add example --token example-bot --roles example-bot
```

### Step 3/4. Configure `tbot`

**This step is completed on the GCP VM.**

Create `/etc/tbot.yaml`:

```yaml
version: v2
auth_server: example.teleport.sh:443
onboarding:
  join_method: gcp
  token: example-bot
storage:
  type: memory
# outputs will be filled in during the completion of an access guide.
outputs: []
```

Replace:

- `example.teleport.sh:443` with the address of your Teleport Proxy or
  Auth Server. Prefer using the address of a Teleport Proxy.
- `example-bot` with the name of the token you created in the second step.

(!docs/pages/includes/machine-id/daemon-or-oneshot.mdx!)

### Step 4/4. Configure outputs

(!docs/pages/includes/machine-id/configure-outputs.mdx!)

## Next steps

- Follow the [access guides](../access-guides.mdx) to finish configuring `tbot` for
  your environment.
- Read the [configuration reference](../reference/configuration.mdx) to explore
  all the available configuration options.