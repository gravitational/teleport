---
title:  Configure Entra ID integration using Terraform
description: Describes how to set up Entra ID integration with Terraform
sidebar_position: 3
labels:
 - how-to
 - identity-governance
 - terraform
---

This guide shows Entra ID integration configuration using Terraform and `tctl`.
See [getting started with Entra ID integration](getting-started.mdx) for a guided Entra ID configuration. 

The set up is based on the [OIDC IdP authentication method](entra-id.mdx#choosing-the-microsoft-graph-api-authentication-method).

## Prerequisites

- Teleport Identity Governance enabled for your Teleport cluster.
- Your user must have privileged administrator permissions in the Microsoft Entra ID tenant.
- Terraform with `azuread` [provider](https://registry.terraform.io/providers/hashicorp/azuread/latest/docs).

## Step 1/4. Create enterprise application

```hcl
resource "azuread_application" "teleport-entraid-iac" {
  display_name = "teleport-entraid-iac"

  # These resources will be updated later and should not 
  # be overridden.
  lifecycle {
    ignore_changes = [
      identifier_uris,
      required_resource_access,
    ]
  }

  feature_tags {
    enterprise            = true
    custom_single_sign_on = true
  }
}
```


## Step 2/4. Configure SAML SSO

Configure Entra ID enterprise application as an SAML SSO provider for Teleport.
```hcl
resource "azuread_service_principal" "teleport-entraid-iac-sp" {
  client_id = azuread_application.teleport-entraid-iac.client_id

  preferred_single_sign_on_mode = "saml"

  login_url = "https://sshah0825entra.cloud.gravitational.io/v1/webapi/saml/acs/entra-id"

  feature_tags {
    enterprise            = true
    custom_single_sign_on = true
  }
}
```

Configure a certificate to be used for SAML assertion signing.
```hcl
resource "azuread_service_principal_token_signing_certificate" "teleport-entraid-iac-saml-cert" {
  service_principal_id = azuread_service_principal.teleport-entraid-iac-sp.id
  display_name         = "CN=teleport-tf-example-sso"
  end_date             = "2026-05-01T01:02:03Z"
}
```

Configure `identifier_uri`, which will be used as the "Entity ID" value for the SAML service provider. 
```hcl
resource "azuread_application_identifier_uri" "teleport-entraid-iac" {
  application_id = azuread_application.teleport-entraid-iac.id

  # Configures SAML Entity ID.
  identifier_uri = "https://sshah0825entra.cloud.gravitational.io/v1/webapi/saml/acs/entra-id"
}
```

Now, you will need to update the enterprise application created in Step 1 
with `group_membership_claims` and `redirect_uris` values. 

```hcl
resource "azuread_application" "teleport-entraid-iac" {
  display_name = "teleport-entraid-iac"

  # Adds group attribute to SAML response.
  group_membership_claims = ["SecurityGroup"]

  # Redirect URI configures SAML Assertion Consumer Service URL. 
  web {
    redirect_uris = ["https://sshah0825entra.cloud.gravitational.io/v1/webapi/saml/acs/entra-id"]
  }

  lifecycle {
    ignore_changes = [
      identifier_uris,
      required_resource_access,
    ]
  }

  feature_tags {
    enterprise            = true
    custom_single_sign_on = true
  }
}
```

By default, the `azuread` provider configures `NameID` format of `emailAddress` type. 
Teleport expects the format to be of `unspecified` type. To change this value, you 
will need to create a new claim policy and attach it to the service principal 
created in Step 2.
```hcl
resource "azuread_claims_mapping_policy" "teleport-entraid-iac-nameid" {
  definition = [
    jsonencode(
      {
        ClaimsMappingPolicy = {
          ClaimsSchema = [
            {
              ID            = "userprincipalname"
              SamlClaimType = "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/nameidentifier"
              Source        = "user"
            },
          ]
          IncludeBasicClaimSet = "true"
          Version              = 1
        }
      }
    ),
  ]
  display_name = "teleport-entraid-iac-nameid"
}


resource "azuread_service_principal_claims_mapping_policy_assignment" "teleport-entraid-iac-nameid-policy-assignment" {
  claims_mapping_policy_id = azuread_claims_mapping_policy.teleport-entraid-iac-nameid.id
  service_principal_id     = azuread_service_principal.teleport-entraid-iac-sp.id
}
```

## Step 3/4. Set up authentication for Microsoft Graph client

In this step, you configure authentication method for Microsoft Graph client used 
by Teleport. 

Recall that Teleport supports [OIDC IdP and system credential](http://localhost:4000/ver/19.x/identity-governance/entra-id/#choosing-the-microsoft-graph-api-authentication-method)
based authentication method.

For OIDC IdP method, a federated credential is set up for Teleport by configuring 
Teleport as an OIDC IdP. For system credential method, a managed identity that is assigned to the 
Teleport Auth service is updated with permission that grants access to the Graph API.  

<Tabs>
<TabItem default label="Teleport as an OIDC provider" name="entra-oidc">

To set up Teleport as OIDC IdP, you must set up federated credential for the enterprise 
application created in Step 1. 

```hcl
resource "azuread_application_federated_identity_credential" "teleport-entraid-iac-oidc-idp" {
  application_id = azuread_application.teleport-entraid-iac.id
  display_name   = "teleport-entraid-iac-oidc"
  description    = "Teleport as an OIDC IdP"
  audiences      = ["api://AzureADTokenExchange"]
  issuer         = "https://sshah0825entra.cloud.gravitational.io"
  subject        = "teleport-azure"
}
```

Next, grant Microsoft Graph API permission to the enterprise application.
These permissions allows Teleport Graph client to import users and groups 
from Entra ID to Teleport.

```hcl
data "azuread_application_published_app_ids" "well_known" {}

data "azuread_service_principal" "graph-api" {
  client_id = data.azuread_application_published_app_ids.well_known.result["MicrosoftGraph"]
}

# Assign API permissions. 
resource "azuread_application_api_access" "teleport-entraid-iac-graph-permission" {
  application_id = azuread_application.teleport-entraid-iac.id
  api_client_id  = data.azuread_application_published_app_ids.well_known.result["MicrosoftGraph"]

  role_ids = [
    data.azuread_service_principal.graph-api.app_role_ids["Application.ReadWrite.OwnedBy"],
    data.azuread_service_principal.graph-api.app_role_ids["Group.Read.All"],
    data.azuread_service_principal.graph-api.app_role_ids["User.Read.All"],
  ]
}

# Grant admin consent to each permissions assigned above.
resource "azuread_app_role_assignment" "teleport-entraid-iac-app" {
  app_role_id         = data.azuread_service_principal.graph-api.app_role_ids["Application.ReadWrite.OwnedBy"]
  principal_object_id = azuread_service_principal.teleport-entraid-iac-sp.object_id
  resource_object_id  = data.azuread_service_principal.graph-api.object_id
}

resource "azuread_app_role_assignment" "teleport-entraid-iac-group" {
  app_role_id         = data.azuread_service_principal.graph-api.app_role_ids["Group.Read.All"]
  principal_object_id = azuread_service_principal.teleport-entraid-iac-sp.object_id
  resource_object_id  = data.azuread_service_principal.graph-api.object_id
}

resource "azuread_app_role_assignment" "teleport-entraid-iac-user" {
  app_role_id         = data.azuread_service_principal.graph-api.app_role_ids["User.Read.All"]
  principal_object_id = azuread_service_principal.teleport-entraid-iac-sp.object_id
  resource_object_id  = data.azuread_service_principal.graph-api.object_id
}
```
</TabItem>
<TabItem label="System Credential" name="entra-system-cred">

To set up system credential, you need to grant Graph API permission to the Managed Identity 
that is assigned to the Teleport Auth service. 

Azure supports two kinds of Managed Identity - system assigned and user assigned. 
For simplicity, we only demonstrate updating permission for a system assigned Managed Identity
that is configured for a VM instance. 

First, ensure that system assigned Managed Identity is enabled for you VM.
This can be configured by using the [`identity`](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/virtual_machine#identity-1)
block in your VM configuration. 

```hcl 
resource "azurerm_virtual_machine" "main" {
  identity {
    type = "SystemAssigned"
  }
}
```

To assign the permission, first, you will need the object ID of the Graph API permission. 
For the three permissions we need for the integration:
- `Application.Read.All`
- `Group.Read.All`
- `User.Read.All`

The ID of these permissions are not directly exposed in the Azure Portal, thus needs to be 
manually retrieved using powershell. 

```bash
# Universal UUID of the MS graph application.
$GraphAppId = "00000003-0000-0000-c000-000000000000"  

# Get service principal object of the MS graph application.
$GraphServicePrincipal = Get-AzureADServicePrincipal -Filter "appId eq '$GraphAppId'"

# API permission name
$Permission = "Application.Read.All" # Update this value to get id for `Group.Read.All` and `User.Read.All`. 

# Get service principal of the role that assigns API permission to the global graph application. 
$AppRole = $GraphServicePrincipal.AppRoles | Where-Object { $_.Value -eq $AppPermission -and $_.AllowedMemberTypes -contains "Application" }

# Printing the value of $AppRole will list the ID associated with the "Application.Read.All" permission.
$AppRole
```

Next, update the system assigned Managed Identity with the API permission. 

```hcl
resource "azuread_app_role_assignment" "teleport-entraid-iac-permissions" {
  # ID of the API permission retrieved using PowerShell. 
  app_role_id         = <UUID of the permission>
  # Principal ID of the system assigned Managed identity
  principal_object_id = azurerm_virtual_machine.example.identity[0].principal_id
  # Object ID of the MS graph API application. 
  resource_object_id  = data.azuread_service_principal.graph-api.object_id
}
```

Repeat this step to grab permission ID for `Group.Read.All` and `User.Read.All` permissions and then 
assign the permission to the system assigned Managed Identity. 

</TabItem>

</Tabs>


## Step 4/4. Install the Entra ID plugin

Now run the `tctl plugins install entraid` command.

```code
$ tctl plugins install entraid \
    --name entra-id-default \
    --auth-connector-name entra-id \
    --default-owner=<Var name="Access List Owner"/> \
    --no-access-graph \
    –-manual-setup
```

The `--name` flag specifies the resource name of the Entra ID plugin. 
The `--auth-connector-name` flag specifies the name of the auth connector this integration will create.
The `--default-owner` flag specifies default owners for the Access Lists that will be created
in Teleport based on the groups imported from the Entra ID.
The `--no-access-graph` flag specifies Identity Security integration is to be skipped.
The `--manual-setup` flag specifies a manual Entra ID configuration is selected by the user.

`tctl` will then prompt for Entra ID tenant ID and application ID of the enterprise 
application created in step 1.

After you enter these values, Entra ID plugin will be installed with the OIDC IdP based authentication method.

## Next steps

- Take a deeper look into setting up [Entra ID auth connector](../../zero-trust-access/sso/azuread.mdx). 
- Learn more about [Access List](../access-lists/access-lists.mdx) management.
- Learn how the [Identity Security integration with Entra ID](../../identity-security/integrations/entra-id.mdx) works. 
- See [FAQs](faq.mdx) related to the Teleport Entra ID integration. 
