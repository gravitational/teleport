---
title: OpenSSH Recording Proxy Guide
description: How to use Teleport Session Recording with OpenSSH and sshd.
---

Teleport is fully compatible with a range of SSH servers (including OpenSSH). Since Teleport is a standards-compliant SSH proxy, it can therefore augment your existing SSH tool with powerful features like enhancing recording and auditing for all SSH activity. 

This Guide details how to:

1. Configure an OpenSSH server (`sshd`) to join a Teleport cluster. Existing fleets of OpenSSH servers can be configured to accept SSH certificates dynamically issued by a Teleport Certificate Authority (CA).
2. Use Teleport to record and audit all SSH activity into and within the cluster.

To learn more about choosing your SSH client and server read [OpenSSH vs Teleport SSH for Servers?](https://gravitational.com/blog/openssh-vs-teleport/).

<Admonition
  type="note"
  title="Note"
>
  OpenSSH 6.9 is the minimum OpenSSH version compatible with Teleport. View your OpenSSH version with the command: 
  
  ```bash
  ssh -V
  ```
</Admonition>

### Follow along with our video guide

<iframe
  width="712"
  height="400"
  src="https://www.youtube-nocookie.com/embed/x0eYFUEIOrM?rel=0&modestbranding=1"
  frameBorder="0"
  allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture"
  allowFullScreen
/>

## Overview

<Figure
  align="center"
  bordered
  caption="Teleport OpenSSH Recording Proxy"
>
  ![Teleport OpenSSH Recording Proxy](../../../img/server-access/openssh-proxy.svg)
</Figure>

The recording proxy mode, although less secure, was added to allow Teleport users to enable session recording for OpenSSH's servers running `sshd`, which is helpful when gradually transitioning large server fleets to Teleport.

We consider the "recording proxy mode" to be less secure for two reasons:

- It grants additional privileges to the Teleport proxy. In the default "node recording" mode, the proxy stores no secrets and cannot "see" the decrypted data. This makes a proxy less critical to the security of the overall cluster. But if an attacker gains physical access to a proxy node running in the "recording" mode, they will be able to see the decrypted traffic and client keys stored in the proxy's process memory.
- Recording proxy mode requires the use of SSH agent forwarding. Agent forwarding is required because without it, a proxy will not be able to establish the 2nd connection to the destination node.

Teleport proxy should be available to clients and be set up with TLS.

Teleport OpenSSH supports:

- FQDN `ec2-user@ip-172-31-14-137.us-west-2.compute.internal`
- IPv4 `ubuntu@184.45.45.30`
- IPv6 `root@2001:db8::2`

(!docs/pages/server-access/includes/ssh-hardening.mdx!)

## Set up OpenSSH recording proxy mode

(!docs/pages/includes/backup-warning.mdx!)

The first step is install and setup Teleport, we recommend starting with our [Getting Started Guide](../../getting-started.mdx) and [Admin Manual](../../admin-guide.mdx).

To enable session recording for `sshd` nodes, the cluster must be switched to
["recording proxy" mode](../../architecture/proxy.mdx#recording-proxy-mode).

In this mode, the recording will be done on the proxy level:

```yaml
# Snippet from /etc/teleport.yaml
auth_service:
   # Session Recording must be set to Proxy to work with OpenSSH
   session_recording: "proxy"  # can also be "off" and "node" (default)
```

(!docs/pages/includes/permission-warning.mdx!)

Next, `sshd` must be told to allow users to log in with certificates generated
by the Teleport User CA. Start by exporting the Teleport CA public key:

Export the Teleport CA certificate into a file:

```bash
# tctl needs to be run on the auth server.
tctl auth export --type=user > teleport_user_ca.pub
```

To allow access for all users:

1. Edit `teleport_user_ca.pub` and remove `cert-authority` from the start of the line.
2. Copy `teleport_user_ca.pub` to `/etc/ssh/teleport_user_ca.pub`
3. Update `sshd` configuration (usually `/etc/ssh/sshd_config` ) to point to this file:

  ```
  TrustedUserCAKeys /etc/ssh/teleport_user_ca.pub
  ```

Now, `sshd` will trust users who present a Teleport-issued certificate. The next step is to configure host authentication.

When in recording mode, Teleport will check that the host certificate of any
node a user connects to is signed by a Teleport CA. By default, this is a strict
check. If the node presents just a key or a certificate signed by a different
CA, Teleport will reject this connection with the error message saying *"ssh:
handshake failed: remote host presented a public key, expected a host
certificate"*

You can disable strict host checks as shown below. However, this opens the
possibility for Man-in-the-Middle (MITM) attacks and is not recommended.

```yaml
# Snippet from /etc/teleport.yaml
auth_service:
  proxy_checks_host_keys: no
```

The recommended solution is to ask Teleport to issue valid host certificates for
all OpenSSH nodes. To generate a host certificate, run this on your Teleport auth server:

```bash
# Creating host certs, with an array of every host to be accessed.
# Wildcard certs aren't supported by OpenSSH, must be full FQDN.
# Management of the host certificates can become complex, this is another
# reason we recommend using Teleport SSH on nodes.
tctl auth sign \
      --host=api.example.com,ssh.example.com,64.225.88.175,64.225.88.178 \
      --format=openssh \
      --out=api.example.com

The credentials have been written to api.example.com, api.example.com-cert.pub

# You can use ssh-keygen to verify the contents.
ssh-keygen -L -f api.example.com-cert.pub
```

The certificate file `api.example.com-cert.pub`:

```bash
api.example.com-cert.pub:
      Type: ssh-rsa-cert-v01@openssh.com host certificate
      Public key: RSA-CERT SHA256:nCoCc50c/EhP6z/hRxdMj1a0zeUaUNXIBVia4kmJvAY
      Signing CA: RSA SHA256:vZ9pk6l4krR5DU8freGr1pKo7wvmCJOLjleBI2+nQ8k (using rsa-sha2-512)
      Key ID: ""
      Serial: 0
      Valid: after 2021-05-29T02:49:34
      Principals:
            api.example.com
            ssh.example.com
            64.225.88.175
            64.225.88.178
      Critical Options: (none)
      Extensions: 
            x-teleport-authority UNKNOWN OPTION (len 27)
            x-teleport-role UNKNOWN OPTION (len 8)
```

Then add the following lines to `/etc/ssh/sshd_config` on all OpenSSH nodes, and restart `sshd`.

```bash
HostKey /etc/ssh/api.example.com
HostCertificate /etc/ssh/api.example.com-cert.pub
```

Now you can use [`tsh ssh --port=22 user@api.example.com`](../../cli-docs.mdx#tsh) to login
into any `sshd` node in the cluster and the session will be recorded.

```bash
# tsh ssh to use default ssh port:22
tsh ssh --port=22 user@host.example.com
# Example for a Amazon EC2 Host
# tsh ssh --port=22 ec2-user@ec2-54-EXAMPLE.us-west-2.compute.amazonaws.com
```

If you want to use OpenSSH `ssh` client for logging into `sshd` servers behind a proxy
in "recording mode", you have to tell the `ssh` client to use the jump host and
enable SSH agent forwarding, otherwise, a recording proxy will not be able to
terminate the SSH connection to record it:

```bash
# Note that agent forwarding is enabled twice: one from a client to a proxy
# (mandatory if using a recording proxy), and then optionally from a proxy
# to the end server if you want your agent running on the end server or not
ssh -o "ForwardAgent yes" \
    -o "ProxyCommand ssh -o 'ForwardAgent yes' -p 3023 %r@p.example.com -s proxy:%h:%p" \
    user@host.example.com
```

<Admonition
  type="tip"
  title="Tip"
>
  To avoid typing all this and use the usual `ssh user@host.example.com`, users can update their `~/.ssh/config` file.
</Admonition>

### Setup SSH agent forwarding

It's important to remember that SSH agent forwarding must be enabled on the client. Verify that a Teleport certificate is loaded into the agent after logging in:

```bsh
# Login as Joe
tsh login --proxy=proxy.example.com --user=joe
# see if the certificate is present (look for "teleport:joe") at the end of the cert
ssh-add -L
```

<Admonition
  type="warning"
  title="GNOME Keyring SSH Agent and GPG Agent"
>
  It is well-known that the Gnome Keyring SSH agent, used by many popular Linux desktops like Ubuntu, and `gpg-agent` from GnuPG do not support SSH
  certificates. We recommend using the `ssh-agent` from OpenSSH.
  Alternatively, you can disable SSH agent integration entirely using the
  `--no-use-local-ssh-agent` flag or `TELEPORT_USE_LOCAL_SSH_AGENT=false`
  environment variable with `tsh`.
</Admonition>

## OpenSSH rate limiting

When using a Teleport proxy in "recording mode", be aware of OpenSSH built-in rate-limiting. On large numbers of proxy connections, you may encounter errors like:

```bash
channel 0: open failed: connect failed: ssh: handshake failed: EOF
```

See `MaxStartups` setting in `man sshd_config`. 

This setting means that by default OpenSSH only allows `10` unauthenticated connections at a time and starts dropping connections `30%` of the time when the number of connections goes over `10`.

When it hits `100` authentication connections, all new connections are dropped.

To increase the concurrency level, increase the value to something like `MaxStartups 50:30:100`. This allows `50` concurrent connections and a max of `100`.

## Revoke an SSH certificate

To revoke the current Teleport Certificate Authority and generate a new one, run `tctl auth rotate`. 

Unless you've highly automated your infrastructure, we would suggest you proceed with caution as this will invalidate the user and host Certificate Authority's, meaning that the new Certificate Authority will need to be exported to every OpenSSH-based machine again using `tctl auth export` as above.