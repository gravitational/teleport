---
title: Teleport Server Access SSH Guide
description: Teleport Server Access SSH guide.
---

Teleport Server Access can be used with third-party SSH tools like [OpenSSH](./openssh-client.mdx). Each Teleport Node can also be configured into a dedicated SSH mode ("Node" mode) and run as an enhanced SSH server.

`tsh` is a command line client with support for both SCP and SSH that's used to interact with Teleport Nodes. As such, Teleport admins can choose to use `tsh` alone for SSH-related server access and reduce the complexity of their stack.

This Guide describes common scenarios one is likely to encounter when using Teleport as an SSH server, as an SSH client, or both.

<Figure
  align="center"
  bordered
  caption="Teleport SSH agent forwarding."
>
  ![Example cluster arrangement](../../../img/server-access/teleport-ssh.svg)
</Figure>

## Choose your SSH solution

SSH tools are now commonly distributed as clients, servers, or some combination of both.  

Teleport is unopinionated and agnostic about which client and/or server you choose. Admins can select specific Teleport features like [Session Recording](../../features/enhanced-session-recording.mdx) while opting to continue using some or all of their existing SSH solutions.

Teleport features can be used to "wrap" or enhance existing SSH tools while retaining the original, underlying, SSH access flows already in place.

<Admonition title="Tip" type="tip">
  For an added layer of secrecy, the default Teleport listening ports can be overridden by port numbers of your choice using Teleport YAML configuration files.
</Admonition>

### Clients

Teleport is compatible with popular clients like [OpenSSH](./openssh-client.mdx) and also provides its own [built-in SSH client](../../cli-docs.mdx#tsh) (`tsh`).

By default, SSH clients can connect to a Teleport cluster through the following port (exposed through the public proxy):

| Port | Service | Description |
| - | - | - |
| 3023 | Proxy | SSH port clients connect to. A proxy will forward this connection to port `#3022` on the destination Node. |

Teleport allows multi-client arrangments as well as unified solutions (using Teleport alone in both a dedicated SSH server and as a client through `tsh`). For example, one cluster may be accessible through OpenSSH, another through Teleport `tsh`, and another through, say, Putty CAC.

| Client | OS | Supported | Comments | 
| - | - | - | - |
| tsh | macOS, Linux, Windows | Yes | Teleport's ssh client. Support for Windows is available from v3.0.1+. |
| OpenSSH | macOS, Linux, Windows Linux Subsystem 2, Cygwin on Windows | Yes | A popular SSH client with native support for SSH certificates. |
| Putty | Windows (All) | No | Lacks out-of-the-box support for SSH certificates. |
| Putty CAC | Windows 7+ | Yes | Fork of Putty. Support for SSH certificates through the Windows Certificate API. May require additional tooling. |
  
### Servers

Teleport is agnostic concerning your choice of SSH server backends and can be used to supplement existing features or serve as an intermediary between them and public clients.

A common strategy involves using Teleport Nodes in Proxy mode to get all the benefits of Audit Logging, Session Recording, and/or Two-Factor Authentication.

Most backends expose port `22` for inbound public clients and `tsh` will connect through the specified `--port` value on command:

```bash
# tsh ssh into a public proxy Node using a specific port
tsh ssh --port=22 user@tele.example.com
```

## Connect to a Teleport cluster using tsh ssh

Teleport SSH is robust enough that you can do all the things you'd do with OpenSSH, without it.

To `tsh` into a cluster at `tele.example.com` with user `tele-admin`:

1. On your local machine, log in through `tsh`: 

   ```bash
   # Log in through tsh
   tsh login --proxy=tele.example.com:443 --user=tele-admin
   ```
   
   You'll be prompted to supply the password and One Time Passcode you set up previously for `tele-admin`.

2. `tele-admin` will now see:

   ```bash
   > Profile URL:        https://proxy.go-teleport.com:443
     Logged in as:       tele-admin
     Cluster:            tele.example.com
     Roles:              access, editor
     Logins:             root, ubuntu, ec2-user
     Kubernetes:         disabled
     Valid until:        2021-05-27 02:15:27 -0500 CDT [valid for 12h0m0s]
     Extensions:         permit-agent-forwarding, permit-port-forwarding, permit-pty
   ```

   `tele-admin` is now logged into the `tele.example.com` cluster through Teleport SSH.

3. `tele-admin` can now execute the following to find the cluster's `nodenames`. `nodenames` are used for establishing SSH connections:

   ```bash
   # Display cluster resources
   tsh ls
   ```

   The *Proxy* Node is located on the bottom line below:

   ```bash                        
   Node Name        Address        Labels                                 
   ---------------- -------------- -------------------------------------- 
   ip-172-31-35-170 ‚üµ Tunnel                                              
   ip-172-31-41-144 127.0.0.1:3022 env=example, hostname=ip-172-31-41-144 
   ```

4. `tele-admin` can SSH any available Node they have been granted access to by running the following command locally:

   ```bash
   # Use tsh to ssh into a Node
   tsh ssh root@ip-xxx-xx-xx-xxx
   ```

   Now, `tele-admin` can:

   - Connect to other Nodes in the cluster by using the appropriate IP address in the `tsh ssh` command.  
   - Traverse the Linux file system.  
   - Execute desired commands.  

   All commands executed by `tele-admin` are recorded and can be replayed in the Teleport Web interface.
   
   The `tsh ssh` command allows one to do anything they would if they were to SSH into a server using a third-party tool. Compare the two equivalent commands:

<Tabs>
  <TabItem label="tsh">
    ```bash
    tsh ssh root@ip-172-31-41-144
    ```
  </TabItem>
  <TabItem label="ssh">
    ```bash
    ssh -J tele.example.com root@ip-172-31-41-144
    ```
  </TabItem>
</Tabs>

## SSH Agent support

If there is an [ssh agent](https://en.wikipedia.org/wiki/Ssh-agent) running,
`tsh login` will store the user certificate in the agent. This can be verified
via:

```bash
ssh-add -L
```

The SSH agent can be used to supply the certificate to other SSH clients once the certificate is stored. 
For example, to OpenSSH `ssh`.

If you wish to disable SSH agent integration, pass the flag `--no-use-local-ssh-agent` to `tsh`. 

You can also set the `TELEPORT_USE_LOCAL_SSH_AGENT` environment variable to `false` in your shell profile to make this permanent.

## Inspecting an SSH certificate

To inspect the SSH certificates in `~/.tsh`, a user may execute the following command:

```bash
tsh status
```

```bash
# Output
> Profile URL:  https://proxy.example.com:3080
  Logged in as: johndoe
  Cluster:      proxy.example.com
  Roles:        admin*
  Logins:       root, admin, guest
  Kubernetes:   disabled
  Valid until:  2017-04-25 15:02:30 -0700 PDT [valid for 1h0m0s]
  Extensions:   permit-agent-forwarding, permit-port-forwarding, permit-pty
```

Read the [CLI Docs - tsh status](../../cli-docs.mdx#tsh-status) for reference documentation.

## SSH mode and adding an SSH Node to your cluster

Teleport [Nodes](../../architecture/nodes.mdx) have three primary modes of operation: *Auth*, *Proxy*, and *Node* (SSH) mode (in addition to more advanced modes like *Database*, *Application*, *Trusted Cluster*, and *Kubernetes* mode). A single Node can run in up to all three modes. Optionally, you can configure a Node to act as the dedicated *Auth* or SSH Node for a cluster.

### Configuration

The two primary ways a Node can be configured into SSH (or any) mode is through a `teleport.yaml` configuration file or via the `sudo tctl tokens add` command which accepts the `--type` parameter to specify which of `auth`, `proxy`, or `node` (default) the Node will be automatically configured as.

In both cases, you'll likely use a *static* (fixed) or *dynamic* (valid for a limited duration of time) [join token](../../admin-guide.mdx#adding-nodes-to-the-cluster) to link your Nodes to existing clusters.

(!docs/pages/includes/permission-warning.mdx!)

To link an SSH Node with an existing `tele.example.com` cluster:

1. Create a *join token* to add the new Node to the `tele.example.com` cluster. On the existing Node run the following command to generate a join token:

   ```bash
   # Let's save the token to a file
   tctl tokens add --type=node | grep -oP '(?<=token:\s).*' > token.file
   ```
 
   Each Teleport Node can be configured into SSH mode (Teleport Node) and run as an enhanced SSH server. "Node" mode specifies that the Teleport Node will act and join as an SSH server.  
   
   `> token.file` indicates that you'd like to save the output to a file name `token.file`.
  
   <Admonition type="tip" title="Tip">
     This helps to minimize the direct sharing of tokens even when they are *dynamically* generated.   
   </Admonition>

2. Open a terminal on the new Node to be added and connect to `tele.example.com`.
   
   - Save `token.file` to an appropriate, secure, directory you have the rights and access to read on the second instance. 

   ```bash
   # Join cluster
   sudo teleport start \
     --roles=node \
     --token=/path/to/token.file \
     --auth-server=tele.example.com:443
   ```

   - Replace the `auth-server` value with the public proxy address of the machine you wish to connect to. By default, the subdomain `tele.example.com` will be available on port `443`.
   - Supply the secured path to the new Node's `token.file`.

3. You should now be able to view both Nodes in the Teleport Web interface after logging in with a user that has permission to view the cluster's resources:

   <Figure
     align="center"
     bordered
     caption="Both Nodes in the Web UI"
   >
     ![Both Nodes in the Web UI](../../../img/server-access/teleport_ui.png)
   </Figure>
