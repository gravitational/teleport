---
title: Set up Automatic Agent Updates
description: Describes how to set up automatic agent updates.
---

We strongly recommend that Teleport users set up automatic agent updates to
ensure that the version of Teleport running on agents remains compatible with
the version running on the Auth Service and Proxy Service. If an agent does not
maintain [version compatibility](./overview.mdx) with your Teleport cluster,
connections to those agents will become degraded or lost.

Cloud-hosted Teleport clusters are updated on a weekly basis. Major version
updates are performed every 4 months. You can monitor and subscribe to the
[Teleport Status](https://status.teleport.sh/) page to be notified of scheduled
updates.

Teleport supports automatic agent updates for systemd-based Linux distributions
using `apt`, `yum`, and `zypper` package managers, as well as Kubernetes
clusters. 

This guide explains how to enable automatic updates for Teleport agents on
cloud-hosted Teleport Enterprise clusters. 

## How it works

When automatic updates are enabled, a Teleport updater is installed alongside
each Teleport agent. The updater communicates with the Teleport Proxy Service to
determine when an update is available. When an update is available, the updater
will update the Teleport agent during the next maintenance window. However, if a
critical update is available, the Teleport agent will be updated outside the
regular maintenance window.

## Prerequisites

- A cloud-hosted Teleport Enterprise cluster. If you do not have one, [sign
  up](https://goteleport.com/signup) for a free trial or consult the [Update
  Reference](./reference.mdx) to read about manual updates or automatic agent
  updates for self-hosted clusters.

- Familiarity with the [Upgrading Compatibility Overview](./overview.mdx) guide,
  which describes the sequence in which to upgrade components in your cluster.

- (!docs/pages/includes/cloud/tctl-tsh-prerequisite.mdx!)

- (!docs/pages/includes/tctl.mdx!)

## Step 1/3. Find agents to enroll in automatic updates

Use the `tctl inventory ls` command to list connected agents along with their current
version. Use the `--upgrader=none` flag to list agents that are not enrolled in automatic
updates.


```code
$ tctl inventory ls --upgrader=none
Server ID                            Hostname      Services Version Upgrader
------------------------------------ ------------- -------- ------- --------
00000000-0000-0000-0000-000000000000 ip-10-1-6-130 Node     v14.4.5 none
...
```

Note that the `inventory ls` command will also list `teleport-auth` and
`teleport-proxy` services. These services are managed by the Teleport team, and
updates will be performed automatically.

## Step 2/3. Enroll agents on Linux servers in automatic updates

1. For each agent ID returned by the `tctl inventory ls` command, copy the ID
   and run the following `tctl` command to access the host via `tsh`:

   ```code
   $ HOST=00000000-0000-0000-0000-000000000000
   $ USER=root
   $ tsh ssh "${USER?}@${HOST?}"
   ```

1. Determine the Teleport version to install by querying your cloud-hosted
   Teleport Enterprise account. This way, the Teleport installation has the same
   major version as the cloud-hosted automatic updater. Replace 
   <Var name="example.teleport.sh" /> with the domain name of your cloud-hosted
   Teleport Enterprise account:

   ```code
   $ TELEPORT_VERSION="$(curl https://<Var name="example.teleport.sh" />/v1/webapi/automaticupgrades/channel/stable/cloud/version | sed 's/v//')"
   ```

1. Ensure that the Teleport repository is properly configured to use the
   `stable/cloud` channel, and install the `teleport-ent-updater` package. This
   must be completed on each agent you would like to enroll into automatic
   updates:

   ```code
   $ curl https://goteleport.com/static/install.sh | bash -s ${TELEPORT_VERSION?} cloud
   ```

   The installation script detects the package manager on your Linux server and
   uses it to install Teleport binaries. To customize your installation, learn
   about the Teleport package repositories in the [installation
   guide](../installation.mdx#linux).

1. Confirm that the version of the `teleport` binary is the one you expect:

   ```code
   $ teleport version
   ```

<Details title="Running the agent as a non-root user">

If you changed the agent user to run as non-root, create
`/etc/teleport-upgrade.d/schedule` and grant ownership to your Teleport user:

```code
$ sudo mkdir -p /etc/teleport-upgrade.d/
$ sudo touch /etc/teleport-upgrade.d/schedule
$ sudo chown <your-teleport-user> /etc/teleport-upgrade.d/schedule
```

</Details>

1. Verify that the upgrader can see your version endpoint by checking for
   upgrades:

   ```code
   $ sudo teleport-upgrade dry-run
   ```
   
1. You should see one of the following messages, depending on the target version
   you are currently serving:
    
   ```text
   no upgrades available (1.2.3 == 1.2.3)
   an upgrade is available (1.2.3 -> 2.3.4)
   ```
    
   `teleport-upgrade` may display warnings about not having a valid upgrade
   schedule. This is expected immediately after install as the maintenance
   schedule might not be exported yet.

## Step 3/3. Enroll Kubernetes agents in automatic updates

This section assumes that the name of your `teleport-kube-agent` release is
`teleport-agent`, and that you have installed it in the `teleport` namespace.

1. Confirm that you are using the Teleport Enterprise edition of the
   `teleport-kube-agent` chart. You should see the following when you query your
   `teleport-kube-agent` release:

   ```code
   $ helm -n `teleport` get values `teleport-agent` -o json | jq '.enterprise'
   true
   ```

   If another value such as `null` is returned, update your existing agent
   `values.yaml` to use the Enterprise version:

   ```yaml
   enterprise: true
   ```

1. Add the following chart values to the values file for the
   `teleport-kube-agent` chart:

   ```yaml
   updater:
     enabled: true
   ```

1. Update the Helm chart release with the new values:

   ```code
   $ helm -n <Var name="teleport" />  upgrade <Var name="teleport-agent" /> teleport/teleport-kube-agent \
   --values=values.yaml \
   --version=<Var name="(=cloud.version=)" />
   ```

1. You can validate the updater is running properly by checking if its pod is
   ready:

   ```code
   $ kubectl -n teleport-agent get pods
   NAME                               READY   STATUS    RESTARTS   AGE
   <your-agent-release>-0                         1/1     Running   0          14m
   <your-agent-release>-1                         1/1     Running   0          14m
   <your-agent-release>-2                         1/1     Running   0          14m
   <your-agent-release>-updater-d9f97f5dd-v57g9   1/1     Running   0          16m
   ```
   
1. Check for any deployment issues by checking the updater logs:
   
    ```code
    $ kubectl -n <Var name="teleport" /> logs deployment/<Var name="teleport-agent" />-updater
    2023-04-28T13:13:30Z	INFO	StatefulSet is already up-to-date, not updating.	{"controller": "statefulset", "controllerGroup": "apps", "controllerKind": "StatefulSet", "StatefulSet": {"name":"my-agent","namespace":"agent"}, "namespace": "agent", "name": "my-agent", "reconcileID": "10419f20-a4c9-45d4-a16f-406866b7fc05", "namespacedname": "agent/my-agent", "kind": "StatefulSet", "err": "no new version (current: \"v12.2.3\", next: \"v12.2.3\")"}
    ```

## Troubleshooting

Teleport agents are not updated immediately when a new version of Teleport is
released, and agent updates can lag behind the cluster by a few days.

If the Teleport agent has not been automatically updating for several weeks, you
can consult the updater logs to help troubleshoot the problem.

### Troubleshooting automatic agent upgrades on Kubernetes

The updater is a controller that periodically reconciles expected Kubernetes
resources with those in the cluster. The updater executes a reconciliation loop
every 30 minutes or in response to a Kubernetes event. If you don't want to wait
until the next reconciliation, you can trigger an event. 

1. Any deployment update will send an event, so you can trigger the upgrader by
   annotating the resource:

   ```code
   $ kubectl -n <Var name="teleport" /> annotate statefulset/<Var name="teleport-agent" /> 'debug.teleport.dev/trigger-event=1'
   ```

1. To suspend automatic updates for an agent, annotate the agent deployment
   with `teleport.dev/skipreconcile: "true"`, either by setting the
   `annotations.deployment` value in Helm, or by patching the deployment
   directly with `kubectl`.

### Troubleshooting automatic agent upgrades on Linux

1. If an agent is not automatically upgraded, you can invoke the upgrader
   manually and look at its logs:

   ```code
   $ sudo teleport-upgrade run
   ```

1. To suspend automatic updates, disable the systemd timer:

   ```code
   $ sudo systemctl disable --now teleport-upgrade.timer
   ```

1. To enable and start the systemd timer after suspending:

   ```code
   $ sudo systemctl enable --now teleport-upgrade.timer
   ```

