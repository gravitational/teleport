---
title: Managed Agent Updates (v2)
description: Describes how to set up managed agent updates using the next-generation updater.
---

<Notice type="warning">
This document describes the next-generation (v2) Teleport Agent updater, which
is currently in beta.

The original updater uses the `teleport-ent-updater` package and
`cluster_maintenance_config` resource, while the next-generation updater is
a binary called `teleport-update` that is included in the `teleport` package and
configured by the `autoupdate_version` and `autoupdate_config` resources
described in this document.

Please consider using the next-generation updater, which is distributed with
all versions of Teleport and provides a simpler, more flexible, and more reliable
update experience compared to the original updater.

For details about the original updater, see
[Managed Updates for Agents (v1)](./agent-managed-updates-v1.mdx).
</Notice>

On cloud-hosted Teleport Enterprise accounts, users must set up managed agent
updates to ensure that the version of Teleport running on agents remains
compatible with the version running on the Auth Service and Proxy Service. If an
agent does not maintain [version compatibility](./overview.mdx) with your
Teleport cluster, connections to those agents will become degraded or lost.

Cloud-hosted Teleport clusters are updated on a weekly basis. Major version
updates are performed every 4 months. You can monitor and subscribe to the
[Teleport Status](https://status.teleport.sh/) page to be notified of scheduled
updates.

Teleport supports managed agent updates for SystemD-based Linux distributions
as well as Kubernetes clusters.

This guide explains how to enable managed updates for Teleport agents on
Teleport Enterprise clusters, including both self-hosted and cloud-hosted
clusters.

## How it works

When managed updates are enabled, a Teleport updater runs alongside
each Teleport agent. The updater communicates with the Teleport Proxy Service to
determine when an update is available. When an update is available, the updater
will update the Teleport agent. Each agent belongs to an update group, and the
time each group is updated can be configured using `tctl`.

For Linux server-based installations, `teleport-update` command configures
managed updates locally on the server.

For Kubernetes-based installations, the `teleport-kube-agent` Helm chart
is configured to automatically update the Teleport container.

## Prerequisites

- A Teleport Enterprise cluster. If you do not have one, [sign
  up](https://goteleport.com/signup) for a free trial or consult the [Update
  Reference](upgrading-reference.mdx) to read about manual updates.
- Familiarity with the [Upgrading Compatibility Overview](./overview.mdx) guide,
  which describes the sequence in which to upgrade components in your cluster.
- Teleport agents that are not yet enrolled in managed updates.
- (!docs/pages/includes/tctl-tsh-prerequisite.mdx!)
- (!docs/pages/includes/tctl.mdx!)

## Quick Setup for Connected Linux Servers

Users of cloud-hosted Teleport Enterprise can enable managed updates
on Linux servers that are already connected with a single command:

```code
$ sudo teleport-update enable
```

<Notice type="note">
If this command is not available, update the `teleport` package
to the latest version that is supported by your cluster.
</Notice>

The `teleport-update enable` command will disable the original (v1)
updater if present. No other action is necessary.

If everything is working, the deprecated updater can be removed:

```code
$ sudo apt remove teleport-ent-updater
```

If the new updater does not work, your installation can be reverted
back to manual updates or the original updater (if it has not been removed):

```code
$ sudo teleport-update uninstall
```

For cloud-hosted Teleport Enterprise, updates will roll out automatically
during the first chosen maintenance window that is at least 36 hours after
the cluster version is updated. Keep reading to learn how to customize the time.

## Quick Setup for New Linux Servers

The [Install Script] is the fastest way to onboard new Linux servers with
a single command. However, you may also use `teleport-update` to setup
a Teleport agent manually.

Users of cloud-hosted Teleport Enterprise can create a new installation of
Teleport using any version of the `teleport-update` binary.
First, copy of the [Teleport tarball] from the downloads page.
Next, invoke `teleport-update` to install the correct version for your cluster.

```code
$ tar xf teleport-[version].tgz
$ cd teleport-[version]
$ sudo ./teleport-update enable --proxy example.teleport.sh
```

After Teleport is installed, you can create `/etc/teleport.yaml`, either manually
or using `teleport configure`. After, the Teleport agent can be enabled and
started via the `systemctl` command:

```code
$ sudo systemctl enable teleport --now
```

## Configuring managed agent updates

### Configuring roles

To configure managed updates in your cluster, you must have access to
the `autoupdate_config` and `autoupdate_version` resources.

1. Create a Teleport role that can manage these resources. No preset Teleport
   roles provide this ability, so you will need to create one.

   Create a file called `autoupdate-editor.yaml` with the following content:

   ```yaml
   kind: role
   version: v7
   metadata:
     name: autoupdate-editor
   spec:
     allow:
       rules:
       - resources: ['autoupdate_config', 'autoupdate_version']
         verbs: ['create', 'read', 'update', 'delete']
   ```

   Create the role resource:

   ```code
   $ tctl create autoupdate-editor.yaml
   ```

   (!docs/pages/includes/create-role-using-web.mdx!)

1. Add the role to your Teleport user:

(!docs/pages/includes/add-role-to-user.mdx role="autoupdate-editor"!)

### Configuring the schedule

For both cloud-hosted and self-hosted editions of Teleport, an update schedule
may be set with the `autoupdate_config` resource. The default resource looks
like this:

```yaml
kind: autoupdate_config
spec:
  agents:
    schedules:
      regular:
        - name: default
          days: [ "Mon", "Tue", "Wed", "Thu" ]
          start_hour: 16
```

For cloud-hosted Teleport Enterprise, the `days` are not configurable for most
customers, and the `start_hour` is defaulted to your selected maintenance window.

For example, a user of cloud-hosted Teleport with a staging environment and a
production environment might create a custom schedule that looks like this:

```yaml
kind: autoupdate_config
spec:
  agents:
    schedules:
      regular:
        - name: staging
          start_hour: 4
        - name: production
          start_hour: 5
          wait_hours: 24
```

This schedule would update agents in the `staging` group at 4 UTC, and then update
the `production` group at 5 UTC the next day. The `production` group will not execute
update until the staging group has updated. The `wait_hours` field sets a minimum
duration between groups, ensuring that `production` happens the day after `staging`,
and not one hour after.

<Notice type="warning">
While failed installations will revert automatically on the client-side,
server-side healthchecks are still in development. To prevent the `production`
group above from updating after `staging` has failed, you must manually suspend
the schedule by setting the `spec.agents.mode` to `suspended`.
</Notice>

You may wish to schedule groups of agents to update without any dependence between
them. For example, groups may represent geographic areas and not environments.
To accomplish this, you can change the default `halt-on-error` strategy to the
`time-based` strategy:

```yaml
kind: autoupdate_config
spec:
  agents:
    strategy: time-based
    maintenance_window_duration: 1h
    schedules:
      regular:
        - name: nyc
          start_hour: 4
        - name: sjc
          start_hour: 20
```

With this strategy, updates to `sjc` may occur before `nyc`, depending on when
new versions become available. The `maintenance_window_duration` restricts
updates to the specified duration after the `start_hour`. This ensures that
disruptions do not occur outside a known window.

The time-based strategy does not support the `wait_days` option.

To add agents to groups, run `teleport-update enable --group group-name`.
You may execute `teleport-update enable` repeatedly to change the group
(or other managed update settings).

### Setting the version

For cloud-hosted Teleport Enterprise, managed updates are enabled by default.
The `autoupdate_version` resource is managed for you, and cannot be edited.

For self-hosted Teleport Enterprise, the `autoupdate_version` resource must be
created and edited to enabled managed updates.

Create a file called `autoupdate_version.yaml` containing:

```yaml
kind: autoupdate_version
spec:
  agents:
    start_version: v17.2.0
    target_version: v17.2.1
    schedule: regular
    mode: enabled
```

This resource is used to deploy new versions of Teleport to your agents.
The `start_version` is the version used to install new agents before their
scheduled update time, while `target_version` is the version that agents
will be updated to according to the configured schedule.

The `schedule` may be changed from `regular` to `immediate` to force all
agents to update to the `target_version` immediately.

The `mode` is used to enable, disable, or suspend managed updates.
The `mode` may be set in both `autoupdate_version` or `autoupdate_config`,
such that `disabled` overrides `suspended`, which overrides `enabled` on either side.

Run the following command to create or update the resource:

```code
$ tctl create autoupdate_version.yaml
```
## Migrating agents on Linux servers to managed updates

### Finding unmanaged agents

Use the `tctl inventory ls` command to list connected agents along with their current
version. Use the `--upgrader=none` flag to list agents that are not enrolled in managed
updates.

```code
$ tctl inventory ls --upgrader=none
Server ID                            Hostname      Services Version Upgrader
------------------------------------ ------------- -------- ------- --------
00000000-0000-0000-0000-000000000000 ip-10-1-6-130 Node     v14.4.5 none
...
```

Use the `--upgrader=unit` flag to list agents that are enrolled in the outdated
updater and need to be configured to the next-generation updater:

```code
$ tctl inventory ls --upgrader=unit
Server ID                            Hostname      Services Version Upgrader
------------------------------------ ------------- -------- ------- --------
00000000-0000-0000-0000-000000000000 ip-10-1-6-131 Node     v14.4.5 unit
...
```

### Enrolling unmanaged agents

1. For each agent ID returned by the `tctl inventory ls` command, copy the ID
   and run the following `tctl` command to access the host via `tsh`:

   ```code
   $ HOST=00000000-0000-0000-0000-000000000000
   $ USER=root
   $ tsh ssh "${USER?}@${HOST?}"
   ```

1. Run `teleport-update enable` on each agent you would like
   to enroll into managed updates:

   ```code
   $ sudo teleport-update enable
   ```

1. Confirm that the version of the `teleport` binary is the one you expect:

   ```code
   $ teleport version
   ```

1. Remove the last-generation updater if present:

   ```code
   $ sudo apt remove teleport-ent-updater
   ```

<Details title="Running the agent as a non-root user">

If you changed the agent user to run as non-root, create
`/etc/teleport-upgrade.d/schedule` and grant ownership to your Teleport user:

```code
$ sudo mkdir -p /etc/teleport-upgrade.d/
$ sudo touch /etc/teleport-upgrade.d/schedule
$ sudo chown <your-teleport-user> /etc/teleport-upgrade.d/schedule
```

While `teleport-update` does not read this file, `teleport` will warn if it
cannot disable the last-generation updater using this file.

</Details>

## Step 4/4. Enroll Kubernetes agents in managed updates

This section assumes that the name of your `teleport-kube-agent` release is
`teleport-agent`, and that you have installed it in the `teleport` namespace.

1. Confirm that you are using the Teleport Enterprise edition of the
   `teleport-kube-agent` chart. You should see the following when you query your
   `teleport-kube-agent` release:

   ```code
   $ helm -n `teleport` get values `teleport-agent` -o json | jq '.enterprise'
   true
   ```

   If another value such as `null` is returned, update your existing agent
   `values.yaml` to use the Enterprise version:

   ```yaml
   enterprise: true
   ```

1. Add the following chart values to the values file for the
   `teleport-kube-agent` chart:

   ```yaml
   updater:
     enabled: true
   ```

1. Update the Teleport Helm repository to include any new versions of the
   `teleport-kube-agent` chart:

   ```code
   $ helm repo update teleport
   ```

1. Update the Helm chart release with the new values:

   <Tabs>
   <TabItem label="Cloud-Hosted">

   ```code
   $ helm -n <Var name="teleport" />  upgrade <Var name="teleport-agent" /> teleport/teleport-kube-agent \
   --values=values.yaml \
   --version="(=cloud.version=)"
   ```
   </TabItem>
   <TabItem label="Self-Hosted">

   ```code
   $ helm -n <Var name="teleport" />  upgrade <Var name="teleport-agent" /> teleport/teleport-kube-agent \
   --values=values.yaml \
   --version="(=teleport.version=)"
   ```
   </TabItem>
   </Tabs>

1. You can validate the updater is running properly by checking if its pod is
   ready:

   ```code
   $ kubectl -n teleport-agent get pods
   NAME                               READY   STATUS    RESTARTS   AGE
   <your-agent-release>-0                         1/1     Running   0          14m
   <your-agent-release>-1                         1/1     Running   0          14m
   <your-agent-release>-2                         1/1     Running   0          14m
   <your-agent-release>-updater-d9f97f5dd-v57g9   1/1     Running   0          16m
   ```

1. Check for any deployment issues by checking the updater logs:

   ```code
   $ kubectl -n <Var name="teleport" /> logs deployment/<Var name="teleport-agent" />-updater
   2023-04-28T13:13:30Z	INFO	StatefulSet is already up-to-date, not updating.	{"controller": "statefulset", "controllerGroup": "apps", "controllerKind": "StatefulSet", "StatefulSet": {"name":"my-agent","namespace":"agent"}, "namespace": "agent", "name": "my-agent", "reconcileID": "10419f20-a4c9-45d4-a16f-406866b7fc05", "namespacedname": "agent/my-agent", "kind": "StatefulSet", "err": "no new version (current: \"v12.2.3\", next: \"v12.2.3\")"}
   ```

## Troubleshooting

Teleport agents are not updated immediately when a new version of Teleport is
released, and agent updates can lag behind the cluster by a few days.

If the Teleport agent has not been automatically updating for several weeks, you
can consult the updater logs to help troubleshoot the problem:

```code
$ journalctl -u teleport-update
```

### Troubleshooting managed agent upgrades on Kubernetes

The updater is a controller that periodically reconciles expected Kubernetes
resources with those in the cluster. The updater executes a reconciliation loop
every 30 minutes or in response to a Kubernetes event. If you don't want to wait
until the next reconciliation, you can trigger an event.

1. Any deployment update will send an event, so you can trigger the upgrader by
   annotating the resource:

   ```code
   $ kubectl -n <Var name="teleport" /> annotate statefulset/<Var name="teleport-agent" /> 'debug.teleport.dev/trigger-event=1'
   ```

1. To suspend managed updates for an agent, annotate the agent deployment
   with `teleport.dev/skipreconcile: "true"`, either by setting the
   `annotations.deployment` value in Helm, or by patching the deployment
   directly with `kubectl`.

### Troubleshooting managed agent upgrades on Linux

1. If an agent is not automatically updated, you can invoke the updater
   manually and look at its logs:

   ```code
   $ sudo teleport-update update --now
   ```

