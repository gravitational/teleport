---
title: Managed Agent Updates (v2)
description: Describes how to set up managed agent updates using the next-generation updater.
---

<Notice type="warning">
This document describes the next-generation (v2) Teleport Agent updater, which
is currently in beta.

The original updater uses the `teleport-ent-updater` package and
`cluster_maintenance_config` resource, while the next-generation updater is
a binary called `teleport-update` that is included in the `teleport` package and
configured by the `autoupdate_version` and `autoupdate_config` resources
described in this document.

Please consider using the next-generation updater, which is distributed with
all versions of Teleport and provides a simpler, more flexible, and more reliable
update experience compared to the original updater.

For details about the original updater, see
[Managed Updates for Agents (v1)](./agent-managed-updates-v1.mdx).
</Notice>

On cloud-hosted Teleport Enterprise accounts, users must set up managed agent
updates to ensure that the version of Teleport running on agents remains
compatible with the version running on the Auth Service and Proxy Service. If an
agent does not maintain [version compatibility](./overview.mdx) with your
Teleport cluster, connections to those agents will become degraded or lost.

Cloud-hosted Teleport clusters are updated on a weekly basis. Major version
updates are performed every 4 months. You can monitor and subscribe to the
[Teleport Status](https://status.teleport.sh/) page to be notified of scheduled
updates.

Teleport supports managed agent updates for SystemD-based Linux distributions
as well as Kubernetes clusters.

This guide explains how to enable managed updates for Teleport agents on
Teleport Enterprise clusters, including both self-hosted and cloud-hosted
clusters.

## How it works

When managed updates are enabled, a Teleport updater runs alongside
each Teleport agent. The updater communicates with the Teleport Proxy Service to
determine when an update is available. When an update is available, the updater
will update the Teleport agent. Each agent belongs to an update group, and the
time each group is updated can be configured using `tctl`.

For Linux server-based installations, `teleport-update` command configures
managed updates locally on the server.

For Kubernetes-based installations, the `teleport-kube-agent` Helm chart
is configured to automatically update the Teleport container.

## Prerequisites

- A Teleport Enterprise cluster. If you do not have one, [sign
  up](https://goteleport.com/signup) for a free trial or consult the [Update
  Reference](upgrading-reference.mdx) to read about manual updates.
- Familiarity with the [Upgrading Compatibility Overview](./overview.mdx) guide,
  which describes the sequence in which to upgrade components in your cluster.
- Teleport agents that are not yet enrolled in managed updates.
- (!docs/pages/includes/tctl-tsh-prerequisite.mdx!)
- (!docs/pages/includes/tctl.mdx!)

## Quick Setup for Connected Linux Servers

Users of cloud-hosted Teleport Enterprise can enable managed updates
on Linux servers that are already connected with a single command:

```code
$ sudo teleport-update enable
```

This command will disable the original (v1) updater if present.
No other action is necessary.

If everything is working, the deprecated updater can be removed:

```code
$ sudo apt remove teleport-ent-updater
```

If the new updater does not work, your installation can be reverted
back to manual updates or the original updater (if it has not been removed):

```code
$ sudo teleport-update uninstall
```

For cloud-hosted Teleport Enterprise, updates will roll out automatically
during the first chosen maintenance window that is at least 36 hours after
the cluster version is updated. Keep reading to learn how to customize the time.

## Quick Setup for New Linux Servers

The [Install Script] is the fastest way to onboard new Linux servers with
a single command. However, it is also easy use `teleport-update` to setup
a Teleport agent manually.

Users of cloud-hosted Teleport Enterprise can install a fresh copy of Teleport
with managed updates already enabled using a single command. First, download a
copy of the [Teleport tarball] from the downloads page. Next, invoke
`teleport-update` to install the correct version for your cluster.

```code
$ tar xf teleport-[version].tgz
$ cd teleport-[version]
$ sudo ./teleport-update enable --proxy example.teleport.sh
```

After Teleport is installed, you can create `/etc/teleport.yaml`, either manually
or using `teleport configure`. After, the Teleport agent can be enabled and
started via the `systemctl` command:

```code
$ sudo systemctl enable teleport --now
```

## Step 1/4. Enable managed agent updates

For cloud-hosted Teleport Enterprise, managed updates are enabled by default.
The `autoupdate_version` resource is managed for you, and cannot be edited.

For self-hosted Teleport Enterprise, the `autoupdate_version` resource must be
created to enabled managed updates.

Create a file called `autoupdate_version.yaml` containing:

```yaml
kind: autoupdate_version
spec:
  agents:
    start_version: v17.2.0
    target_version: v17.2.1
    schedule: regular
    strategy: halt-on-error
    mode: enabled
```

- `start_version` is the version used to install new agents before their update window.
- `target_version` is the version that agents will be updated to during their update window, as well
  as the version used to install new agents during and after their update windows.
- `schedule` is `regular` or `immediate`, where `immediate` forces an immediate update for all agents.
- `strategy` is `time-based` or `halt-on-error`. `halt-on-error` will ensure groups listed first
  in `autoupdate_config` are updated before groups listed later in `autoupdate_config`. Note that
  client-side errors are not detected automatically. Set `mode` to `suspended` to stop the rollout.
- `mode` is `enabled`, `disabled`, or `suspended`.

Run the following command:

```code
$ tctl create autoupdate_version.yaml
```

For both cloud-hosted and self-hosted editions of Teleport, an update schedule
may be set with the `autoupdate_config` resource. The default resource looks
like this:

```yaml
kind: autoupdate_config
spec:
  agents:
    schedules:
      regular:
        - name: default
          days: [ "Mon", "Tue", "Wed", "Thu" ]
          start_hour: 16
```

For cloud-hosted Teleport Enterprise, the `days` are not configurable for most
customers, and the `start_hour` is defaulted to your selected maintenance window.

For example, a user of cloud-hosted Teleport with a staging environment and a
production environment might create a schedule that looks like this:

```yaml
kind: autoupdate_config
spec:
  agents:
    schedules:
      regular:
        - name: staging
          start_hour: 4
          wait_hours: 24
        - name: production
          start_hour: 5
```

This schedule would update agents in the `staging` group at 4 UTC, and then update
the `production` group at 5 UTC the next day. The `production` group will not execute
update until the staging group has updated.

<Notice type="warning">
While failed installations will revert automatically on the client-side,
server-side healthchecks are still in development. To prevent the `production`
group above from updating after `staging` has failed, you must manually suspend
the schedule by setting the `spec.agents.mode` to `suspended`.
</Notice>

You may wish to schedule groups of agents to update without any dependence between
them. For example, groups may represent geographic areas and not environments.
To accomplish this, you can change the default `halt-on-error` strategy to the
`time-based` strategy:

```yaml
kind: autoupdate_config
spec:
  agents:
    strategy: time-based
    schedules:
      regular:
        - name: nyc
          start_hour: 4
        - name: sjc
          start_hour: 20
```

With this strategy, updates to `sjc` may occur before `nyc`, depending on when
new versions become available.

To add agents to groups, run `teleport-update enable --group group-name`.
You may execute `teleport-update enable` repeatedly to change the group
(or other managed update settings).

### Configure a maintenance schedule

To enable managed upgrades in your cluster, you must create a cluster
maintenance configuration. This configures a maintenance schedule for the
Teleport cluster that agents use to determine when to check for upgrades.

1. Create a Teleport role that can manage cluster maintenance configurations
   through the `cluster_maintenance_config` dynamic resource. No preset Teleport
   roles provide this ability, so you will need to create one.

   Create a file called `cmc-editor.yaml` with the following content:

   ```yaml
   kind: role
   version: v7
   metadata:
     name: cmc-editor
   spec:
     allow:
       rules:
       - resources: ['cluster_maintenance_config']
         verbs: ['create', 'read', 'update', 'delete']
   ```

   Create the role resource:

   ```code
   $ tctl create cmc-editor.yaml
   ```

   (!docs/pages/includes/create-role-using-web.mdx!)

1. Add the role to your Teleport user:

(!docs/pages/includes/add-role-to-user.mdx role="cmc-editor"!)

1. Create a cluster maintenance config in a file called `cmc.yaml`. The
   following example allows maintenance on Monday, Wednesday and Friday between
   02:00 and 03:00 UTC:

   (!docs/pages/includes/cluster-maintenance-config-spec.mdx!)

1. Apply the manifest using `tctl`:

   ```code
   $ tctl create cmc.yaml
   maintenance window has been updated
   ```

### [Optional] Assign the version served by the version server

By default, the version server has a single `default` channel, serving the
version of the Teleport Proxy Service. If you want to override the default
version or add other channels you can use the `automatic_upgrades_channels`
field in the Proxy Service configuration file:

```yaml
proxy_service:
  enabled: "yes"
  automatic_upgrades_channels:
    # Override the default version channel reachable at
    # https://<Var name="teleport.example.com:443" />/v1/webapi/automaticupgrades/channel/default/version
    default:
      static_version: v14.2.1
    # Define a new version channel with a static version reachable at
    # https://<Var name="teleport.example.com:443" />/v1/webapi/automaticupgrades/channel/m-static-channel/version
    my-static-channel:
      static_version: v14.2.0
    # Define a new version channel forwarding requests to an upstream version server
    my-remote-channel:
      forward_url: https://updates.releases.teleport.dev/v1/stable/cloud
```

You must ensure that all Proxy Service instances share the same
`automatic_upgrades_channels` configuration. If some Proxy Service instances are
configured differently, you will experience agents flickering between versions
as the version served is not consistent across instances.

If your Proxy Service public address is <Var name="teleport.example.com:443" />,
you can query the version server with the following command:

```code
$ curl "https://<Var name="teleport.example.com:443" />/v1/webapi/automaticupgrades/channel/default/version"
(=teleport.version=)
```

## Step 2/4. Find agents to enroll in managed updates

Use the `tctl inventory ls` command to list connected agents along with their current
version. Use the `--upgrader=none` flag to list agents that are not enrolled in managed
updates.

```code
$ tctl inventory ls --upgrader=none
Server ID                            Hostname      Services Version Upgrader
------------------------------------ ------------- -------- ------- --------
00000000-0000-0000-0000-000000000000 ip-10-1-6-130 Node     v14.4.5 none
...
```

## Step 3/4. Enroll agents on Linux servers in managed updates

1. For each agent ID returned by the `tctl inventory ls` command, copy the ID
   and run the following `tctl` command to access the host via `tsh`:

   ```code
   $ HOST=00000000-0000-0000-0000-000000000000
   $ USER=root
   $ tsh ssh "${USER?}@${HOST?}"
   ```

1. Determine the Teleport version to install by querying the Teleport Proxy
   Service. This way, the Teleport installation has the same major version as
   the automatic updater.

   Replace <Var name="stable/cloud" /> with the name of your automatic update
   channel. For cloud-hosted Teleport Enterprise accounts, this is always
   `stable/cloud`:

   ```code
   $ TELEPORT_VERSION="$(curl https://<Var name="teleport.example.com:443" />/v1/webapi/automaticupgrades/channel/<Var name="stable/cloud" />/version | sed 's/v//')"
   ```

1. Ensure that the Teleport repository is properly configured to use the
   <Var name="stable/cloud" /> channel, and install the `teleport-ent-updater`
   package. You must install `teleport-ent-updater` on each agent you would like
   to enroll into managed updates:

   <Tabs>
   <TabItem label="Managed Teleport Enterprise">

   ```code
   $ curl (=teleport.teleport_install_script_url=) | bash -s ${TELEPORT_VERSION?} cloud
   ```

   </TabItem>
   <TabItem label="Self-Hosted Teleport Enterprise">

    1. Follow the instructions in the Teleport [installation
       guide](../installation.mdx#package-repositories) to install the `teleport`
       binary on your Linux server for your package manager.

    1. Using your package manager, install `teleport-ent-updater` on the
       server where you installed `teleport`. For example:

       ```code
       $ apt-get install -y teleport-ent-updater
       ```

   </TabItem>
   </Tabs>

   The installation script detects the package manager on your Linux server and
   uses it to install Teleport binaries. To customize your installation, learn
   about the Teleport package repositories in the [installation
   guide](../installation.mdx#linux).

1. Confirm that the version of the `teleport` binary is the one you expect:

   ```code
   $ teleport version
   ```

<Details title="Running the agent as a non-root user">

If you changed the agent user to run as non-root, create
`/etc/teleport-upgrade.d/schedule` and grant ownership to your Teleport user:

```code
$ sudo mkdir -p /etc/teleport-upgrade.d/
$ sudo touch /etc/teleport-upgrade.d/schedule
$ sudo chown <your-teleport-user> /etc/teleport-upgrade.d/schedule
```

</Details>

1. Verify that the upgrader can see your version endpoint by checking for
   upgrades:

   ```code
   $ sudo teleport-upgrade dry-run
   ```

1. You should see one of the following messages, depending on the target version
   you are currently serving:

   ```text
   no upgrades available (1.2.3 == 1.2.3)
   an upgrade is available (1.2.3 -> 2.3.4)
   ```

   `teleport-upgrade` may display warnings about not having a valid upgrade
   schedule. This is expected immediately after install as the maintenance
   schedule might not be exported yet.

## Step 4/4. Enroll Kubernetes agents in managed updates

This section assumes that the name of your `teleport-kube-agent` release is
`teleport-agent`, and that you have installed it in the `teleport` namespace.

1. Confirm that you are using the Teleport Enterprise edition of the
   `teleport-kube-agent` chart. You should see the following when you query your
   `teleport-kube-agent` release:

   ```code
   $ helm -n `teleport` get values `teleport-agent` -o json | jq '.enterprise'
   true
   ```

   If another value such as `null` is returned, update your existing agent
   `values.yaml` to use the Enterprise version:

   ```yaml
   enterprise: true
   ```

1. Add the following chart values to the values file for the
   `teleport-kube-agent` chart:

   ```yaml
   updater:
     enabled: true
   ```

1. Update the Teleport Helm repository to include any new versions of the
   `teleport-kube-agent` chart:

   ```code
   $ helm repo update teleport
   ```

1. Update the Helm chart release with the new values:

   <Tabs>
   <TabItem label="Cloud-Hosted">

   ```code
   $ helm -n <Var name="teleport" />  upgrade <Var name="teleport-agent" /> teleport/teleport-kube-agent \
   --values=values.yaml \
   --version="(=cloud.version=)"
   ```
   </TabItem>
   <TabItem label="Self-Hosted">

   ```code
   $ helm -n <Var name="teleport" />  upgrade <Var name="teleport-agent" /> teleport/teleport-kube-agent \
   --values=values.yaml \
   --version="(=teleport.version=)"
   ```
   </TabItem>
   </Tabs>

1. You can validate the updater is running properly by checking if its pod is
   ready:

   ```code
   $ kubectl -n teleport-agent get pods
   NAME                               READY   STATUS    RESTARTS   AGE
   <your-agent-release>-0                         1/1     Running   0          14m
   <your-agent-release>-1                         1/1     Running   0          14m
   <your-agent-release>-2                         1/1     Running   0          14m
   <your-agent-release>-updater-d9f97f5dd-v57g9   1/1     Running   0          16m
   ```

1. Check for any deployment issues by checking the updater logs:

   ```code
   $ kubectl -n <Var name="teleport" /> logs deployment/<Var name="teleport-agent" />-updater
   2023-04-28T13:13:30Z	INFO	StatefulSet is already up-to-date, not updating.	{"controller": "statefulset", "controllerGroup": "apps", "controllerKind": "StatefulSet", "StatefulSet": {"name":"my-agent","namespace":"agent"}, "namespace": "agent", "name": "my-agent", "reconcileID": "10419f20-a4c9-45d4-a16f-406866b7fc05", "namespacedname": "agent/my-agent", "kind": "StatefulSet", "err": "no new version (current: \"v12.2.3\", next: \"v12.2.3\")"}
   ```

## Troubleshooting

Teleport agents are not updated immediately when a new version of Teleport is
released, and agent updates can lag behind the cluster by a few days.

If the Teleport agent has not been automatically updating for several weeks, you
can consult the updater logs to help troubleshoot the problem:

```code
$ journalctl -u teleport-upgrade
```

### Troubleshooting managed agent upgrades on Kubernetes

The updater is a controller that periodically reconciles expected Kubernetes
resources with those in the cluster. The updater executes a reconciliation loop
every 30 minutes or in response to a Kubernetes event. If you don't want to wait
until the next reconciliation, you can trigger an event.

1. Any deployment update will send an event, so you can trigger the upgrader by
   annotating the resource:

   ```code
   $ kubectl -n <Var name="teleport" /> annotate statefulset/<Var name="teleport-agent" /> 'debug.teleport.dev/trigger-event=1'
   ```

1. To suspend managed updates for an agent, annotate the agent deployment
   with `teleport.dev/skipreconcile: "true"`, either by setting the
   `annotations.deployment` value in Helm, or by patching the deployment
   directly with `kubectl`.

### Troubleshooting managed agent upgrades on Linux

1. If an agent is not automatically upgraded, you can invoke the upgrader
   manually and look at its logs:

   ```code
   $ sudo teleport-upgrade run
   ```

1. To suspend managed updates, disable the systemd timer:

   ```code
   $ sudo systemctl disable --now teleport-upgrade.timer
   ```

1. To enable and start the systemd timer after suspending:

   ```code
   $ sudo systemctl enable --now teleport-upgrade.timer
   ```

