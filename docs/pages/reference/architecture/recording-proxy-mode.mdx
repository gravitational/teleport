---
title: Teleport Recording Proxy Mode
description: Use Recording Proxy Mode to capture OpenSSH server activity
tags:
 - session-recording
 - how-to
 - zero-trust
 - infrastructure-identity
---

Teleport Recording Proxy Mode was originally added to allow Teleport users
to enable session recording for servers running `sshd`, which is helpful
when gradually transitioning large server fleets to Teleport. In this mode,
the Proxy Service 

![Teleport OpenSSH Recording Proxy](../../../../img/server-access/openssh-proxy.png)

<Admonition type="warning" >

The use of Proxy Recording Mode across your cluster is no longer necessary to support
[OpenSSH Nodes](../../enroll-resources/server-access/openssh/openssh-agentless.mdx).
Proxy Recording Mode is automatically used for OpenSSH Nodes without the need for SSH
agent forwarding, which is the primary security concern for this mode.

Recording Proxy Mode will continue to be supported for legacy OpenSSH support and other
niche use case, but many existing and new features will not be supported in this mode due
to several technical limitations it introduces.

</Admonition>

<Admonition type="warning">

Teleport Cloud only supports session recording at the Node level, except for the
Proxy Recording automatically used for [OpenSSH Nodes](../../enroll-resources/server-access/openssh/openssh-agentless.mdx).

</Admonition>

## How it works

In Recording Proxy Mode, the Proxy Service terminates (decrypts) SSH connections
by presenting the client with a trusted host certificate dynamically generated by
the Auth Service and signed by the Teleport Host CA.

The Proxy Service then establishes its own connection to the OpenSSH server authenticating in one of two ways:

- For Teleport Nodes and legacy OpenSSH servers, the Proxy Service requires the client to provide its credentials through ssh-agent forwarding so that these credentials can be reused to connect to the OpenSSH server.
- For [OpenSSH Nodes](../../enroll-resources/server-access/openssh/openssh-agentless.mdx), the Proxy Service requests a certificate signed by the Teleport OpenSSH CA, which will be trusted by the OpenSSH server.

With both sides of the connections decrypted, the Proxy Service acts as a pipe between the client
and the OpenSSH server, performing RBAC checks, recording the session, and emitting audit events 
in the process.

### Security concerns

We consider Recording Proxy Mode to be less secure than recording at the Node
level for two reasons:

- It grants additional privileges to the Teleport Proxy Service. In the default Node Recording mode, the Proxy Service stores no secrets and cannot "see" the decrypted data. This makes a Proxy Server less critical to the security of the overall cluster. But if an attacker gains physical access to a Proxy Server running in Proxy Recording mode, they will be able to see the decrypted traffic and client keys stored in the Proxy Server's process memory.
- It requires the use of SSH agent forwarding (for Teleport Nodes and legacy OpenSSH server support).

## OpenSSH rate limiting

When using a Teleport proxy in "recording mode", be aware of OpenSSH's built-in
rate-limiting. On large numbers of Proxy Service connections, you may encounter errors
like:

```txt
channel 0: open failed: connect failed: ssh: handshake failed: EOF
```

See the `MaxStartups` setting in `man sshd_config`. This setting means that by
default, OpenSSH only allows 10 unauthenticated connections at a time and starts
dropping connections 30% of the time when the number of connections goes over 10.
When it hits 100 authentication connections, all new connections are
dropped.

To increase the concurrency level, increase the value to something like
`MaxStartups 50:30:100`. This allows 50 concurrent connections and a max of 100.

