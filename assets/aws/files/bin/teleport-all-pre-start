#!/bin/bash
# This script prepares a Let's Encrypt certificate before all-in-one Teleport starts for the first time (if needed)

set -e
if [[ "${DEBUG:-false}" == "true" ]]; then
    set -x
fi

# Source variables from user-data (if present)
if [ -f /etc/teleport.d/conf ]; then
    source /etc/teleport.d/conf
fi

# Check for Let's Encrypt
if [[ "${USE_LETSENCRYPT}" != "true" ]]; then
    echo "Not using Let's Encrypt, exiting with success"
    exit 0
fi

# Remove any pre-existing `debug.sock` file locally
if [[ -e /var/lib/teleport/debug.sock ]]; then
    echo "Removing existing debug.sock file locally"
    rm -f /var/lib/teleport/debug.sock
fi

# Copy certificates into place
/bin/aws s3 sync \
    --exact-timestamps \
    --exclude="debug.sock" \
    --exclude="*.sock" \
    s3://${TELEPORT_S3_BUCKET}/live/${TELEPORT_DOMAIN_NAME} /var/lib/teleport || {
    echo "Error during AWS S3 sync operation" >&2
    exit 1
}

# Validate that required files are present
if [[ ! -f /var/lib/teleport/fullchain.pem || ! -f /var/lib/teleport/privkey.pem ]]; then
    echo "Required certificate files not found, exiting with error" >&2
    exit 1
fi

echo "Certificates successfully synchronized"
exit 0
