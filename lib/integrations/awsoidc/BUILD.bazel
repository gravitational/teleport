load("@io_bazel_rules_go//go:def.bzl", "go_library", "go_test")

go_library(
    name = "awsoidc",
    srcs = [
        "accessgraph_sync.go",
        "aws_app_access_iam_config.go",
        "clients.go",
        "create_ec2ice.go",
        "deploydatabaseservice.go",
        "deployservice.go",
        "deployservice_iam_config.go",
        "deployservice_iam_jointoken.go",
        "deployservice_update.go",
        "ec2_ssm_iam_config.go",
        "eice_opentunnel.go",
        "eice_sendsshpublickey.go",
        "eks_enroll_clusters.go",
        "eks_iam_config.go",
        "eks_list_clusters.go",
        "externalauditstorage_iam_config.go",
        "idp_iam_config.go",
        "idp_thumbprint.go",
        "list_ec2ice.go",
        "list_security_groups.go",
        "list_subnets.go",
        "list_vpcs.go",
        "listdatabases.go",
        "listdatabases_iam_config.go",
        "listdeployeddatabaseservice.go",
        "listec2.go",
        "ping.go",
        "resource_tags.go",
        "token_generator.go",
    ],
    importpath = "github.com/gravitational/teleport/lib/integrations/awsoidc",
    visibility = ["//visibility:public"],
    deps = [
        "//:teleport",
        "//api/types",
        "//api/types/common",
        "//api/types/usertasks",
        "//api/utils",
        "//api/utils/aws",
        "//api/utils/retryutils",
        "//lib",
        "//lib/automaticupgrades",
        "//lib/cloud/aws",
        "//lib/cloud/aws/tags",
        "//lib/cloud/provisioning",
        "//lib/cloud/provisioning/awsactions",
        "//lib/cryptosuites",
        "//lib/defaults",
        "//lib/integrations/externalauditstorage/easconfig",
        "//lib/jwt",
        "//lib/modules",
        "//lib/services",
        "//lib/srv/discovery/common",
        "//lib/utils",
        "//lib/utils/aws",
        "//lib/utils/aws/iamutils",
        "//lib/utils/aws/stsutils",
        "//lib/utils/oidc",
        "//lib/utils/teleportassets",
        "@com_github_aws_aws_sdk_go_v2//aws",
        "@com_github_aws_aws_sdk_go_v2//aws/arn",
        "@com_github_aws_aws_sdk_go_v2//aws/retry",
        "@com_github_aws_aws_sdk_go_v2//aws/signer/v4:signer",
        "@com_github_aws_aws_sdk_go_v2_config//:config",
        "@com_github_aws_aws_sdk_go_v2_credentials//stscreds",
        "@com_github_aws_aws_sdk_go_v2_service_ec2//:ec2",
        "@com_github_aws_aws_sdk_go_v2_service_ec2//types",
        "@com_github_aws_aws_sdk_go_v2_service_ec2instanceconnect//:ec2instanceconnect",
        "@com_github_aws_aws_sdk_go_v2_service_ecs//:ecs",
        "@com_github_aws_aws_sdk_go_v2_service_ecs//types",
        "@com_github_aws_aws_sdk_go_v2_service_eks//:eks",
        "@com_github_aws_aws_sdk_go_v2_service_eks//types",
        "@com_github_aws_aws_sdk_go_v2_service_iam//:iam",
        "@com_github_aws_aws_sdk_go_v2_service_rds//:rds",
        "@com_github_aws_aws_sdk_go_v2_service_rds//types",
        "@com_github_aws_aws_sdk_go_v2_service_ssm//:ssm",
        "@com_github_aws_aws_sdk_go_v2_service_ssm//types",
        "@com_github_aws_aws_sdk_go_v2_service_sts//:sts",
        "@com_github_aws_smithy_go//middleware",
        "@com_github_aws_smithy_go//transport/http",
        "@com_github_coreos_go_semver//semver",
        "@com_github_google_uuid//:uuid",
        "@com_github_gorilla_websocket//:websocket",
        "@com_github_gravitational_trace//:trace",
        "@com_github_jonboulle_clockwork//:clockwork",
        "@io_k8s_cli_runtime//pkg/genericclioptions",
        "@io_k8s_client_go//rest",
        "@org_golang_x_crypto//ssh",
        "@org_golang_x_sync//errgroup",
        "@sh_helm_helm_v3//pkg/action",
        "@sh_helm_helm_v3//pkg/chart",
        "@sh_helm_helm_v3//pkg/chart/loader",
        "@sh_helm_helm_v3//pkg/cli",
        "@sh_helm_helm_v3//pkg/getter",
        "@sh_helm_helm_v3//pkg/release",
    ],
)

go_test(
    name = "awsoidc_test",
    srcs = [
        "accessgraph_sync_test.go",
        "aws_app_access_iam_config_test.go",
        "clients_test.go",
        "create_ec2ice_test.go",
        "deploydatabaseservice_test.go",
        "deployservice_iam_config_test.go",
        "deployservice_iam_jointoken_test.go",
        "deployservice_test.go",
        "deployservice_update_test.go",
        "deployservice_vcr_test.go",
        "ec2_ssm_iam_config_test.go",
        "eice_opentunnel_test.go",
        "eks_enroll_clusters_test.go",
        "eks_iam_config_test.go",
        "eks_list_clusters_test.go",
        "externalauditstorage_iam_config_test.go",
        "idp_iam_config_test.go",
        "idp_thumbprint_test.go",
        "list_ec2ice_test.go",
        "list_security_groups_test.go",
        "list_subnets_test.go",
        "list_vpcs_test.go",
        "listdatabases_iam_config_test.go",
        "listdatabases_test.go",
        "listdeployeddatabaseservice_test.go",
        "listec2_test.go",
        "ping_test.go",
    ],
    data = glob(["testdata/**"]),
    embed = [":awsoidc"],
    deps = [
        "//:teleport",
        "//api/types",
        "//lib",
        "//lib/automaticupgrades",
        "//lib/cloud/aws",
        "//lib/cloud/aws/tags",
        "//lib/integrations/externalauditstorage/easconfig",
        "//lib/utils/log/logtest",
        "//lib/utils/testutils/golden",
        "@com_github_aws_aws_sdk_go_v2//aws",
        "@com_github_aws_aws_sdk_go_v2//aws/transport/http",
        "@com_github_aws_aws_sdk_go_v2_service_ec2//:ec2",
        "@com_github_aws_aws_sdk_go_v2_service_ec2//types",
        "@com_github_aws_aws_sdk_go_v2_service_ecs//:ecs",
        "@com_github_aws_aws_sdk_go_v2_service_ecs//types",
        "@com_github_aws_aws_sdk_go_v2_service_eks//:eks",
        "@com_github_aws_aws_sdk_go_v2_service_eks//types",
        "@com_github_aws_aws_sdk_go_v2_service_iam//:iam",
        "@com_github_aws_aws_sdk_go_v2_service_iam//types",
        "@com_github_aws_aws_sdk_go_v2_service_rds//:rds",
        "@com_github_aws_aws_sdk_go_v2_service_rds//types",
        "@com_github_aws_aws_sdk_go_v2_service_ssm//:ssm",
        "@com_github_aws_aws_sdk_go_v2_service_ssm//types",
        "@com_github_aws_aws_sdk_go_v2_service_sts//:sts",
        "@com_github_aws_smithy_go//middleware",
        "@com_github_aws_smithy_go//transport/http",
        "@com_github_google_go_cmp//cmp",
        "@com_github_google_go_cmp//cmp/cmpopts",
        "@com_github_google_uuid//:uuid",
        "@com_github_gorilla_websocket//:websocket",
        "@com_github_gravitational_trace//:trace",
        "@com_github_jonboulle_clockwork//:clockwork",
        "@com_github_stretchr_testify//assert",
        "@com_github_stretchr_testify//require",
        "@in_gopkg_dnaeon_go_vcr_v3//cassette",
        "@in_gopkg_dnaeon_go_vcr_v3//recorder",
        "@io_k8s_cli_runtime//pkg/genericclioptions",
    ],
)
