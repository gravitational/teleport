load("@io_bazel_rules_go//go:def.bzl", "go_library", "go_test")

go_library(
    name = "auth",
    srcs = [
        "access.go",
        "accountrecovery.go",
        "apiserver.go",
        "app_access_aws_credentials.go",
        "auth.go",
        "auth_with_roles.go",
        "autoupdate_agent_version_report.go",
        "autoupdate_rollout.go",
        "aws_certs.go",
        "azure_certs.go",
        "bot.go",
        "client_tls_config_generator.go",
        "db.go",
        "desktop.go",
        "externalauditstorage.go",
        "github.go",
        "grpcserver.go",
        "helpers.go",
        "helpers_mfa.go",
        "init.go",
        "join.go",
        "join_azure.go",
        "join_azure_devops.go",
        "join_bitbucket.go",
        "join_bound_keypair.go",
        "join_circleci.go",
        "join_ec2.go",
        "join_gcp.go",
        "join_github.go",
        "join_gitlab.go",
        "join_iam.go",
        "join_kubernetes.go",
        "join_oracle.go",
        "join_spacelift.go",
        "join_terraformcloud.go",
        "join_tpm.go",
        "methods.go",
        "middleware.go",
        "oidc.go",
        "password.go",
        "periodic.go",
        "register.go",
        "rotate.go",
        "saml.go",
        "server_info.go",
        "server_monitor.go",
        "sessions.go",
        "sso_diag_context.go",
        "sso_mfa.go",
        "transport_credentials.go",
        "trustedcluster.go",
        "user.go",
        "usertoken.go",
        "version.go",
    ],
    embedsrcs = ["windows-configure-ad.ps1"],
    importpath = "github.com/gravitational/teleport/lib/auth",
    visibility = ["//visibility:public"],
    deps = [
        "//:teleport",
        "//api/accessrequest",
        "//api/breaker",
        "//api/client",
        "//api/client/proto",
        "//api/client/webclient",
        "//api/constants",
        "//api/defaults",
        "//api/gen/proto/go/teleport/accessmonitoringrules/v1:accessmonitoringrules",
        "//api/gen/proto/go/teleport/auditlog/v1:auditlog",
        "//api/gen/proto/go/teleport/autoupdate/v1:autoupdate",
        "//api/gen/proto/go/teleport/backendinfo/v1:backendinfo",
        "//api/gen/proto/go/teleport/clusterconfig/v1:clusterconfig",
        "//api/gen/proto/go/teleport/crownjewel/v1:crownjewel",
        "//api/gen/proto/go/teleport/dbobject/v1:dbobject",
        "//api/gen/proto/go/teleport/dbobjectimportrule/v1:dbobjectimportrule",
        "//api/gen/proto/go/teleport/decision/v1alpha1",
        "//api/gen/proto/go/teleport/devicetrust/v1:devicetrust",
        "//api/gen/proto/go/teleport/discoveryconfig/v1:discoveryconfig",
        "//api/gen/proto/go/teleport/dynamicwindows/v1:dynamicwindows",
        "//api/gen/proto/go/teleport/gitserver/v1:gitserver",
        "//api/gen/proto/go/teleport/header/v1:header",
        "//api/gen/proto/go/teleport/healthcheckconfig/v1:healthcheckconfig",
        "//api/gen/proto/go/teleport/identitycenter/v1:identitycenter",
        "//api/gen/proto/go/teleport/integration/v1:integration",
        "//api/gen/proto/go/teleport/kubewaitingcontainer/v1:kubewaitingcontainer",
        "//api/gen/proto/go/teleport/loginrule/v1:loginrule",
        "//api/gen/proto/go/teleport/machineid/v1:machineid",
        "//api/gen/proto/go/teleport/mfa/v1:mfa",
        "//api/gen/proto/go/teleport/notifications/v1:notifications",
        "//api/gen/proto/go/teleport/presence/v1:presence",
        "//api/gen/proto/go/teleport/recordingencryption/v1:recordingencryption",
        "//api/gen/proto/go/teleport/scopes/access/v1:access",
        "//api/gen/proto/go/teleport/scopes/joining/v1:joining",
        "//api/gen/proto/go/teleport/secreports/v1:secreports",
        "//api/gen/proto/go/teleport/stableunixusers/v1:stableunixusers",
        "//api/gen/proto/go/teleport/trust/v1:trust",
        "//api/gen/proto/go/teleport/userloginstate/v1:userloginstate",
        "//api/gen/proto/go/teleport/userprovisioning/v2:userprovisioning",
        "//api/gen/proto/go/teleport/users/v1:users",
        "//api/gen/proto/go/teleport/usertasks/v1:usertasks",
        "//api/gen/proto/go/teleport/vnet/v1:vnet",
        "//api/gen/proto/go/teleport/workloadidentity/v1:workloadidentity",
        "//api/gen/proto/go/userpreferences/v1:userpreferences",
        "//api/internalutils/stream",
        "//api/metadata",
        "//api/mfa",
        "//api/observability/tracing/http",
        "//api/trail",
        "//api/types",
        "//api/types/accesslist",
        "//api/types/autoupdate",
        "//api/types/backendinfo",
        "//api/types/clusterconfig",
        "//api/types/events",
        "//api/types/installers",
        "//api/types/vnet",
        "//api/types/wrappers",
        "//api/utils",
        "//api/utils/clientutils",
        "//api/utils/grpc/interceptors",
        "//api/utils/keys",
        "//api/utils/keys/hardwarekey",
        "//api/utils/retryutils",
        "//api/utils/sshutils",
        "//entitlements",
        "//gen/proto/go/prehog/v1alpha",
        "//lib",
        "//lib/auth/accessmonitoringrules/accessmonitoringrulesv1",
        "//lib/auth/accesspoint",
        "//lib/auth/authclient",
        "//lib/auth/autoupdate/autoupdatev1",
        "//lib/auth/clusterconfig/clusterconfigv1",
        "//lib/auth/crownjewel/crownjewelv1",
        "//lib/auth/dbobject/dbobjectv1",
        "//lib/auth/dbobjectimportrule/dbobjectimportrulev1",
        "//lib/auth/discoveryconfig/discoveryconfigv1",
        "//lib/auth/dynamicwindows/dynamicwindowsv1",
        "//lib/auth/gitserver/gitserverv1",
        "//lib/auth/healthcheckconfig/healthcheckconfigv1",
        "//lib/auth/integration/credentials",
        "//lib/auth/integration/integrationv1",
        "//lib/auth/join/iam",
        "//lib/auth/join/oracle",
        "//lib/auth/keystore",
        "//lib/auth/kubewaitingcontainer/kubewaitingcontainerv1",
        "//lib/auth/loginrule/loginrulev1",
        "//lib/auth/machineid/machineidv1",
        "//lib/auth/machineid/workloadidentityv1",
        "//lib/auth/mfatypes",
        "//lib/auth/migration",
        "//lib/auth/mocku2f",
        "//lib/auth/moderation",
        "//lib/auth/notifications/notificationsv1",
        "//lib/auth/okta",
        "//lib/auth/presence/presencev1",
        "//lib/auth/recordingencryption",
        "//lib/auth/recordingencryption/recordingencryptionv1",
        "//lib/auth/scopes/access",
        "//lib/auth/scopes/joining",
        "//lib/auth/secreports/secreportsv1",
        "//lib/auth/stableunixusers",
        "//lib/auth/state",
        "//lib/auth/testauthority",
        "//lib/auth/trust/trustv1",
        "//lib/auth/userloginstate",
        "//lib/auth/userloginstate/userloginstatev1",
        "//lib/auth/userpreferences/userpreferencesv1",
        "//lib/auth/userprovisioning/userprovisioningv2",
        "//lib/auth/users/usersv1",
        "//lib/auth/usertasks/usertasksv1",
        "//lib/auth/vnetconfig/vnetconfigv1",
        "//lib/auth/webauthn",
        "//lib/auth/webauthntypes",
        "//lib/authz",
        "//lib/azuredevops",
        "//lib/backend",
        "//lib/backend/memory",
        "//lib/bitbucket",
        "//lib/boundkeypair",
        "//lib/cache",
        "//lib/circleci",
        "//lib/client/sso",
        "//lib/cloud/azure",
        "//lib/cryptosuites",
        "//lib/decision",
        "//lib/decision/decisionv1",
        "//lib/defaults",
        "//lib/devicetrust/assertserver",
        "//lib/devicetrust/authz",
        "//lib/devicetrust/config",
        "//lib/events",
        "//lib/events/eventstest",
        "//lib/gcp",
        "//lib/githubactions",
        "//lib/gitlab",
        "//lib/httplib",
        "//lib/integrations/awsoidc",
        "//lib/integrations/awsra",
        "//lib/integrations/awsra/createsession",
        "//lib/inventory",
        "//lib/joinserver",
        "//lib/jwt",
        "//lib/kube/token",
        "//lib/limiter",
        "//lib/loginrule",
        "//lib/modules",
        "//lib/multiplexer",
        "//lib/observability/metrics",
        "//lib/observability/tracing",
        "//lib/oidc",
        "//lib/plugin",
        "//lib/release",
        "//lib/resourceusage",
        "//lib/scopes/cache/access",
        "//lib/service/servicecfg",
        "//lib/services",
        "//lib/services/local",
        "//lib/services/readonly",
        "//lib/services/suite",
        "//lib/session",
        "//lib/spacelift",
        "//lib/srv/db/common/databaseobjectimportrule",
        "//lib/srv/db/common/role",
        "//lib/srv/server/installer",
        "//lib/sshca",
        "//lib/sshutils",
        "//lib/terraformcloud",
        "//lib/tlsca",
        "//lib/tpm",
        "//lib/usagereporter/teleport",
        "//lib/utils",
        "//lib/utils/aws",
        "//lib/utils/aws/stsutils",
        "//lib/utils/clocki",
        "//lib/utils/genmap",
        "//lib/utils/interval",
        "//lib/utils/log",
        "//lib/utils/slices",
        "//lib/versioncontrol",
        "//lib/versioncontrol/github",
        "//lib/versioncontrol/upgradewindow",
        "//lib/winpki",
        "@com_github_aws_aws_sdk_go_v2//aws",
        "@com_github_aws_aws_sdk_go_v2_config//:config",
        "@com_github_aws_aws_sdk_go_v2_credentials//stscreds",
        "@com_github_aws_aws_sdk_go_v2_feature_ec2_imds//:imds",
        "@com_github_aws_aws_sdk_go_v2_service_ec2//:ec2",
        "@com_github_aws_aws_sdk_go_v2_service_ec2//types",
        "@com_github_aws_aws_sdk_go_v2_service_sts//:sts",
        "@com_github_aws_smithy_go_tracing_smithyoteltracing//:smithyoteltracing",
        "@com_github_azure_azure_sdk_for_go_sdk_azcore//:azcore",
        "@com_github_azure_azure_sdk_for_go_sdk_azcore//arm",
        "@com_github_azure_azure_sdk_for_go_sdk_azcore//arm/policy",
        "@com_github_azure_azure_sdk_for_go_sdk_azcore//policy",
        "@com_github_coreos_go_semver//semver",
        "@com_github_digitorus_pkcs7//:pkcs7",
        "@com_github_go_jose_go_jose_v3//jwt",
        "@com_github_go_webauthn_webauthn//protocol",
        "@com_github_google_go_attestation//attest",
        "@com_github_google_uuid//:uuid",
        "@com_github_gravitational_license//:license",
        "@com_github_gravitational_roundtrip//:roundtrip",
        "@com_github_gravitational_trace//:trace",
        "@com_github_grpc_ecosystem_go_grpc_middleware_providers_prometheus//:prometheus",
        "@com_github_jonboulle_clockwork//:clockwork",
        "@com_github_julienschmidt_httprouter//:httprouter",
        "@com_github_pquerna_otp//:otp",
        "@com_github_pquerna_otp//totp",
        "@com_github_prometheus_client_golang//prometheus",
        "@com_github_zitadel_oidc_v3//pkg/oidc",
        "@io_opentelemetry_go_contrib_instrumentation_google_golang_org_grpc_otelgrpc//:otelgrpc",
        "@io_opentelemetry_go_otel//:otel",
        "@io_opentelemetry_go_otel//attribute",
        "@io_opentelemetry_go_otel_exporters_otlp_otlptrace//:otlptrace",
        "@io_opentelemetry_go_otel_trace//:trace",
        "@io_opentelemetry_go_proto_otlp//collector/trace/v1:trace",
        "@io_opentelemetry_go_proto_otlp//common/v1:common",
        "@org_golang_google_grpc//:grpc",
        "@org_golang_google_grpc//codes",
        "@org_golang_google_grpc//credentials",
        "@org_golang_google_grpc//encoding/gzip",
        "@org_golang_google_grpc//keepalive",
        "@org_golang_google_grpc//peer",
        "@org_golang_google_grpc//status",
        "@org_golang_google_protobuf//proto",
        "@org_golang_google_protobuf//types/known/durationpb",
        "@org_golang_google_protobuf//types/known/emptypb",
        "@org_golang_google_protobuf//types/known/structpb",
        "@org_golang_google_protobuf//types/known/timestamppb",
        "@org_golang_x_crypto//bcrypt",
        "@org_golang_x_crypto//ssh",
        "@org_golang_x_mod//semver",
        "@org_golang_x_net//http2",
        "@org_golang_x_oauth2//:oauth2",
        "@org_golang_x_sync//errgroup",
        "@org_golang_x_time//rate",
    ],
)

go_test(
    name = "auth_test",
    srcs = [
        "access_request_test.go",
        "access_test.go",
        "accountrecovery_test.go",
        "apiserver_test.go",
        "auth_login_test.go",
        "auth_test.go",
        "auth_with_roles_okta_rbac_test.go",
        "auth_with_roles_test.go",
        "autoupdate_agent_version_report_test.go",
        "autoupdate_rollout_test.go",
        "azure_certs_test.go",
        "bot_test.go",
        "db_test.go",
        "desktop_test.go",
        "fuzz_test.go",
        "github_test.go",
        "grpcserver_test.go",
        "init_test.go",
        "join_azure_devops_test.go",
        "join_azure_test.go",
        "join_bitbucket_test.go",
        "join_bound_keypair_test.go",
        "join_circleci_test.go",
        "join_ec2_test.go",
        "join_gcp_test.go",
        "join_github_test.go",
        "join_gitlab_test.go",
        "join_iam_test.go",
        "join_kubernetes_test.go",
        "join_oracle_test.go",
        "join_spacelift_test.go",
        "join_terraformcloud_test.go",
        "join_test.go",
        "join_tpm_test.go",
        "methods_test.go",
        "middleware_test.go",
        "moderated_sessions_test.go",
        "notification_test.go",
        "password_test.go",
        "periodic_test.go",
        "server_info_test.go",
        "sessions_test.go",
        "sso_diag_context_test.go",
        "sso_mfa_test.go",
        "tls_test.go",
        "transport_credentials_test.go",
        "trustedcluster_test.go",
        "usage_test.go",
        "usertoken_test.go",
    ],
    embed = [":auth"],
    deps = [
        "//:teleport",
        "//api",
        "//api/breaker",
        "//api/client",
        "//api/client/proto",
        "//api/client/webclient",
        "//api/constants",
        "//api/defaults",
        "//api/fixtures",
        "//api/gen/proto/go/teleport/autoupdate/v1:autoupdate",
        "//api/gen/proto/go/teleport/backendinfo/v1:backendinfo",
        "//api/gen/proto/go/teleport/clusterconfig/v1:clusterconfig",
        "//api/gen/proto/go/teleport/dbobjectimportrule/v1:dbobjectimportrule",
        "//api/gen/proto/go/teleport/devicetrust/v1:devicetrust",
        "//api/gen/proto/go/teleport/header/v1:header",
        "//api/gen/proto/go/teleport/healthcheckconfig/v1:healthcheckconfig",
        "//api/gen/proto/go/teleport/identitycenter/v1:identitycenter",
        "//api/gen/proto/go/teleport/machineid/v1:machineid",
        "//api/gen/proto/go/teleport/mfa/v1:mfa",
        "//api/gen/proto/go/teleport/notifications/v1:notifications",
        "//api/gen/proto/go/teleport/scopes/access/v1:access",
        "//api/gen/proto/go/teleport/trust/v1:trust",
        "//api/gen/proto/go/teleport/users/v1:users",
        "//api/gen/proto/go/teleport/vnet/v1:vnet",
        "//api/gen/proto/go/teleport/workloadidentity/v1:workloadidentity",
        "//api/gen/proto/go/userpreferences/v1:userpreferences",
        "//api/internalutils/stream",
        "//api/metadata",
        "//api/mfa",
        "//api/observability/tracing",
        "//api/trail",
        "//api/types",
        "//api/types/accesslist",
        "//api/types/autoupdate",
        "//api/types/backendinfo",
        "//api/types/common",
        "//api/types/events",
        "//api/types/header",
        "//api/types/installers",
        "//api/types/label",
        "//api/types/trait",
        "//api/types/userloginstate",
        "//api/types/vnet",
        "//api/types/webauthn",
        "//api/types/wrappers",
        "//api/utils",
        "//api/utils/keys",
        "//api/utils/sshutils",
        "//entitlements",
        "//integrations/lib/testing/fakejoin",
        "//lib",
        "//lib/auth/authclient",
        "//lib/auth/join",
        "//lib/auth/join/oracle",
        "//lib/auth/keystore",
        "//lib/auth/machineid/machineidv1",
        "//lib/auth/mfatypes",
        "//lib/auth/mocku2f",
        "//lib/auth/okta",
        "//lib/auth/state",
        "//lib/auth/storage",
        "//lib/auth/testauthority",
        "//lib/auth/webauthntypes",
        "//lib/authz",
        "//lib/azuredevops",
        "//lib/backend",
        "//lib/backend/lite",
        "//lib/backend/memory",
        "//lib/bitbucket",
        "//lib/boundkeypair",
        "//lib/circleci",
        "//lib/cloud/azure",
        "//lib/cryptosuites",
        "//lib/defaults",
        "//lib/devicetrust/authz",
        "//lib/events",
        "//lib/events/eventstest",
        "//lib/events/test",
        "//lib/fixtures",
        "//lib/gcp",
        "//lib/githubactions",
        "//lib/gitlab",
        "//lib/integrations/awsra/createsession",
        "//lib/inventory",
        "//lib/jwt",
        "//lib/kube/token",
        "//lib/loginrule",
        "//lib/modules",
        "//lib/modules/modulestest",
        "//lib/observability/tracing",
        "//lib/okta/oktatest",
        "//lib/reversetunnelclient",
        "//lib/scopes/access",
        "//lib/service/servicecfg",
        "//lib/services",
        "//lib/services/local",
        "//lib/services/suite",
        "//lib/session",
        "//lib/spacelift",
        "//lib/srv/db/common/databaseobjectimportrule",
        "//lib/srv/discovery/common",
        "//lib/srv/server/installer",
        "//lib/sshca",
        "//lib/sshutils",
        "//lib/tbot/identity",
        "//lib/terraformcloud",
        "//lib/tlsca",
        "//lib/tpm",
        "//lib/utils",
        "//lib/utils/log/logtest",
        "//lib/utils/pagination",
        "//lib/utils/proxy",
        "//lib/utils/testutils",
        "@com_github_aws_aws_sdk_go_v2_service_ec2//:ec2",
        "@com_github_aws_aws_sdk_go_v2_service_ec2//types",
        "@com_github_coreos_go_semver//semver",
        "@com_github_digitorus_pkcs7//:pkcs7",
        "@com_github_go_jose_go_jose_v3//:go-jose",
        "@com_github_go_jose_go_jose_v3//jwt",
        "@com_github_google_go_attestation//attest",
        "@com_github_google_go_cmp//cmp",
        "@com_github_google_go_cmp//cmp/cmpopts",
        "@com_github_google_uuid//:uuid",
        "@com_github_gravitational_license//:license",
        "@com_github_gravitational_trace//:trace",
        "@com_github_jonboulle_clockwork//:clockwork",
        "@com_github_julienschmidt_httprouter//:httprouter",
        "@com_github_oracle_oci_go_sdk_v65//common",
        "@com_github_pquerna_otp//:otp",
        "@com_github_pquerna_otp//totp",
        "@com_github_prometheus_client_model//go",
        "@com_github_stretchr_testify//assert",
        "@com_github_stretchr_testify//mock",
        "@com_github_stretchr_testify//require",
        "@com_github_vulcand_predicate//builder",
        "@com_github_zitadel_oidc_v3//pkg/oidc",
        "@io_k8s_apimachinery//pkg/util/yaml",
        "@io_opentelemetry_go_proto_otlp//common/v1:common",
        "@io_opentelemetry_go_proto_otlp//resource/v1:resource",
        "@io_opentelemetry_go_proto_otlp//trace/v1:trace",
        "@org_golang_google_grpc//:grpc",
        "@org_golang_google_grpc//codes",
        "@org_golang_google_grpc//credentials",
        "@org_golang_google_grpc//credentials/insecure",
        "@org_golang_google_grpc//metadata",
        "@org_golang_google_grpc//status",
        "@org_golang_google_protobuf//proto",
        "@org_golang_google_protobuf//testing/protocmp",
        "@org_golang_google_protobuf//types/known/durationpb",
        "@org_golang_google_protobuf//types/known/emptypb",
        "@org_golang_google_protobuf//types/known/timestamppb",
        "@org_golang_x_crypto//bcrypt",
        "@org_golang_x_crypto//ssh",
    ],
)
